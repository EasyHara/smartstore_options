<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ìë™ ìƒì„±ê¸°</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f5f6fa; color: #333; }
    .container { max-width: 100%; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); overflow-x: auto; }
    h1 { font-size: 24px; margin-bottom: 16px; }
    table { width: 100%; min-width: 1200px; border-collapse: collapse; margin: 10px 0; table-layout: fixed; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 14px; word-break: break-word; }
    th { background-color: #f0f0f0; }
    button, input[type="file"], input[type="text"] { margin: 4px; padding: 6px 12px; font-size: 14px; }
    input[type="checkbox"] { margin-right: 4px; }
    textarea { width: 100%; height: 100px; margin-top: 10px; font-family: monospace; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ƒ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ìë™ ìƒì„±ê¸°</h1>
    <input type="file" id="inputFile" accept=".xls,.xlsx">
    <button onclick="downloadTemplate()">ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
    <br>
    <label><input type="checkbox" id="combineNameColor"> ìƒí’ˆëª…+ìƒ‰ìƒ</label>
    <br>
    <table id="inputTable">
      <thead>
        <tr>
          <th>ëŒ€í‘œ</th><th>ìƒí’ˆëª…</th><th>íŒë§¤ê°€</th><th>ìƒ‰ìƒ(ì½¤ë§ˆ ë˜ëŠ” /)</th><th>ì‚¬ì´ì¦ˆ(ì½¤ë§ˆ ë˜ëŠ” /)</th>
          <th>1ë²ˆ ìƒí’ˆëª…</th><th>í’ˆì ˆëœ ìƒ‰ìƒ ì…ë ¥</th><th>í’ˆì ˆëœ ì‚¬ì´ì¦ˆ ì…ë ¥</th><th>ì œì™¸</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addRow()">+ í–‰ ì¶”ê°€</button>
    <button onclick="clearTable()">ì´ˆê¸°í™”</button>
    <br>
    <input type="text" id="templateTitle" placeholder="ì–‘ì‹ ì œëª© ì…ë ¥">
    <button onclick="saveTemplate()">ì œëª©ìœ¼ë¡œ ì €ì¥</button>
    <br>
    <button onclick="generateZip()">ì¼ê´„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ZIP)</button>
    <button onclick="downloadRepresentative()">í˜„ì¬ ëŒ€í‘œê¸°ì¤€ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    <br><br>
    <table id="templateList">
      <thead>
        <tr><th></th><th>ì œëª©</th><th>ë©”ëª¨</th><th>ìƒì„±ì¼</th><th>ìˆ˜ì •ì¼</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="deleteSelectedTemplate()">ì„ íƒëœ ì–‘ì‹ ì‚­ì œ</button>
    <button onclick="loadSelectedTemplate()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>
  <script>
    function addRow(data = {}) {
      const tbody = document.querySelector("#inputTable tbody");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="radio" name="ëŒ€í‘œ"></td>
        <td><input value="${data.ìƒí’ˆëª… || ''}"></td>
        <td><input value="${data.íŒë§¤ê°€ || ''}" type="number"></td>
        <td><input value="${data.ìƒ‰ìƒ || ''}"></td>
        <td><input value="${data.ì‚¬ì´ì¦ˆ || ''}"></td>
        <td><input value="${data["1ë²ˆ ìƒí’ˆëª…"] || ''}"></td>
        <td><input value="${data.í’ˆì ˆëœìƒ‰ìƒ || ''}"></td>
        <td><input value="${data.í’ˆì ˆëœì‚¬ì´ì¦ˆ || ''}"></td>
        <td><input type="checkbox" ${data.ì œì™¸ ? 'checked' : ''}></td>
      `;
      tbody.appendChild(row);
    }

    function clearTable() {
      document.querySelector("#inputTable tbody").innerHTML = '';
    }

    function getDataFromTable() {
      const rows = document.querySelectorAll("#inputTable tbody tr");
      return Array.from(rows).map(row => {
        const cells = row.querySelectorAll("input");
        return {
          ëŒ€í‘œ: cells[0].checked,
          ìƒí’ˆëª…: cells[1].value,
          íŒë§¤ê°€: parseInt(cells[2].value) || 0,
          ìƒ‰ìƒ: cells[3].value,
          ì‚¬ì´ì¦ˆ: cells[4].value,
          ["1ë²ˆ ìƒí’ˆëª…"]: cells[5].value,
          í’ˆì ˆëœìƒ‰ìƒ: cells[6].value,
          í’ˆì ˆëœì‚¬ì´ì¦ˆ: cells[7].value,
          ì œì™¸: cells[8].checked
        };
      });
    }

    function downloadTemplate() {
      const headers = ["ìƒí’ˆëª…","íŒë§¤ê°€","ìƒ‰ìƒ","ì‚¬ì´ì¦ˆ","1ë²ˆ ìƒí’ˆëª…","í’ˆì ˆëœ ì¡°í•©","ì œì™¸"];
      const ws = XLSX.utils.aoa_to_sheet([headers]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ìƒí’ˆì˜µì…˜");
      const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      saveAs(new Blob([wbout], {type:"application/octet-stream"}), "smartstore_template.xlsx");
    }

    document.getElementById("inputFile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets["ìƒí’ˆì˜µì…˜"] || workbook.Sheets[workbook.SheetNames[0]];
        if (!sheet) {
          alert("ìƒí’ˆì˜µì…˜ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const json = XLSX.utils.sheet_to_json(sheet);
        clearTable();
        json.forEach(row => {
          addRow({
            ìƒí’ˆëª…: row["ìƒí’ˆëª…"],
            íŒë§¤ê°€: row["íŒë§¤ê°€"],
            ìƒ‰ìƒ: row["ìƒ‰ìƒ"],
            ì‚¬ì´ì¦ˆ: row["ì‚¬ì´ì¦ˆ"],
            ["1ë²ˆ ìƒí’ˆëª…"]: row["1ë²ˆ ìƒí’ˆëª…"],
            í’ˆì ˆëœìƒ‰ìƒ: row["í’ˆì ˆëœ ìƒ‰ìƒ ì…ë ¥"] || row["í’ˆì ˆëœ ì¡°í•©"] || '',
            í’ˆì ˆëœì‚¬ì´ì¦ˆ: row["í’ˆì ˆëœ ì‚¬ì´ì¦ˆ ì…ë ¥"] || '',
            ì œì™¸: row["ì œì™¸"] === 'Y' || row["ì œì™¸"] === true
          });
        });
      };

      reader.readAsArrayBuffer(file);
    });
    // ì „ì²´ ì˜µì…˜ ë°ì´í„° ì¶”ì¶œ í›„ ZIP íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ ì¶”ê°€
function generateZip() {
  const rows = getDataFromTable();
  const combine = document.getElementById("combineNameColor").checked;
  const grouped = {};
  const zip = new JSZip();

  // ê·¸ë£¹í•‘: 1ë²ˆ ìƒí’ˆëª… ê¸°ì¤€ìœ¼ë¡œ ë¬¶ê¸°
  rows.forEach(row => {
    if (row.ì œì™¸) return;
    if (!grouped[row["1ë²ˆ ìƒí’ˆëª…"]]) grouped[row["1ë²ˆ ìƒí’ˆëª…"]] = [];
    grouped[row["1ë²ˆ ìƒí’ˆëª…"]].push(row);
  });

  Object.entries(grouped).forEach(([key, items]) => {
    const ëŒ€í‘œ = items.find(i => i.ëŒ€í‘œ) || items[0];
    const ëŒ€í‘œíŒë§¤ê°€ = ëŒ€í‘œ.íŒë§¤ê°€;
    const ëŒ€í‘œìƒí’ˆëª… = ëŒ€í‘œ.ìƒí’ˆëª…;
    let index = 1;
    const data = [];

    items.forEach(item => {
      if (item.ì œì™¸) return;
      const ìˆœë²ˆ = (index < 10 ? `0${index}` : index);
      const optionPrefix = `${ìˆœë²ˆ}) ${combine ? item.ìƒí’ˆëª… + ' / ' : ''}`;
      const ìƒ‰ìƒëª©ë¡ = (item.ìƒ‰ìƒ || '').split(/[,/]/).map(s => s.trim()).filter(Boolean);
      const ì‚¬ì´ì¦ˆëª©ë¡ = (item.ì‚¬ì´ì¦ˆ || '').split(/[,/]/).map(s => s.trim()).filter(Boolean);
      const í’ˆì ˆìƒ‰ = (item.í’ˆì ˆëœìƒ‰ìƒ || '').split(/[,/]/).map(s => s.trim());
      const í’ˆì ˆì‚¬ì´ì¦ˆ = (item.í’ˆì ˆëœì‚¬ì´ì¦ˆ || '').split(/[,/]/).map(s => s.trim());

      ìƒ‰ìƒëª©ë¡.forEach(color => {
        ì‚¬ì´ì¦ˆëª©ë¡.forEach(size => {
          const í’ˆì ˆ = í’ˆì ˆìƒ‰.includes(color) || í’ˆì ˆì‚¬ì´ì¦ˆ.includes(size);
          data.push({
            ì œí’ˆì„ íƒ: `${optionPrefix}${color}`,
            ìƒ‰ìƒ: color,
            ì‚¬ì´ì¦ˆ: size,
            ì˜µì…˜ê°€: item === ëŒ€í‘œ ? 0 : item.íŒë§¤ê°€ - ëŒ€í‘œíŒë§¤ê°€,
            ì¬ê³ ìˆ˜ëŸ‰: í’ˆì ˆ ? 0 : 99999,
            ê´€ë¦¬ì½”ë“œ: item.ìƒí’ˆëª…,
            ì‚¬ìš©ì—¬ë¶€: "Y"
          });
        });
      });
      index++;
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ì˜µì…˜ë°ì´í„°");
    const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
    zip.file(`${ëŒ€í‘œìƒí’ˆëª…}.xls`, wbout);
  });

  zip.generateAsync({ type: "blob" }).then(content => {
    saveAs(content, "ì˜µì…˜ì¼ê´„ë‹¤ìš´ë¡œë“œ.zip");
  });
}

// ì„ íƒëœ ëŒ€í‘œ ê¸°ì¤€ìœ¼ë¡œ ë‹¨ì¼ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function downloadRepresentative() {
  const rows = getDataFromTable();
  const combine = document.getElementById("combineNameColor").checked;
  const ëŒ€í‘œ = rows.find(r => r.ëŒ€í‘œ) || rows[0];
  const ëŒ€í‘œíŒë§¤ê°€ = ëŒ€í‘œ.íŒë§¤ê°€;
  const ëŒ€í‘œìƒí’ˆëª… = ëŒ€í‘œ.ìƒí’ˆëª…;
  const ëŒ€í‘œê·¸ë£¹ = ëŒ€í‘œ["1ë²ˆ ìƒí’ˆëª…"];

  const items = rows.filter(r => r["1ë²ˆ ìƒí’ˆëª…"] === ëŒ€í‘œê·¸ë£¹ && !r.ì œì™¸);
  let index = 1;
  const data = [];

  items.forEach(item => {
    const ìˆœë²ˆ = (index < 10 ? `0${index}` : index);
    const optionPrefix = `${ìˆœë²ˆ}) ${combine ? item.ìƒí’ˆëª… + ' / ' : ''}`;
    const ìƒ‰ìƒëª©ë¡ = (item.ìƒ‰ìƒ || '').split(/[,/]/).map(s => s.trim()).filter(Boolean);
    const ì‚¬ì´ì¦ˆëª©ë¡ = (item.ì‚¬ì´ì¦ˆ || '').split(/[,/]/).map(s => s.trim()).filter(Boolean);
    const í’ˆì ˆìƒ‰ = (item.í’ˆì ˆëœìƒ‰ìƒ || '').split(/[,/]/).map(s => s.trim());
    const í’ˆì ˆì‚¬ì´ì¦ˆ = (item.í’ˆì ˆëœì‚¬ì´ì¦ˆ || '').split(/[,/]/).map(s => s.trim());

    ìƒ‰ìƒëª©ë¡.forEach(color => {
      ì‚¬ì´ì¦ˆëª©ë¡.forEach(size => {
        const í’ˆì ˆ = í’ˆì ˆìƒ‰.includes(color) || í’ˆì ˆì‚¬ì´ì¦ˆ.includes(size);
        data.push({
          ì œí’ˆì„ íƒ: `${optionPrefix}${color}`,
          ìƒ‰ìƒ: color,
          ì‚¬ì´ì¦ˆ: size,
          ì˜µì…˜ê°€: item === ëŒ€í‘œ ? 0 : item.íŒë§¤ê°€ - ëŒ€í‘œíŒë§¤ê°€,
          ì¬ê³ ìˆ˜ëŸ‰: í’ˆì ˆ ? 0 : 99999,
          ê´€ë¦¬ì½”ë“œ: item.ìƒí’ˆëª…,
          ì‚¬ìš©ì—¬ë¶€: "Y"
        });
      });
    });
    index++;
  });

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ì˜µì…˜ë°ì´í„°");
  const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
  saveAs(new Blob([wbout], { type: "application/octet-stream" }), `${ëŒ€í‘œìƒí’ˆëª…}_ëŒ€í‘œê¸°ì¤€.xls`);
}

  </script>
</body>
</html>
