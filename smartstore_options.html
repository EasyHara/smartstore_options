<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ìë™ ìƒì„±ê¸°</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/plugins/SortableMultiDrag.min.js"></script>

  <style>
    /* * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
     * [ê°œì„ ] ê¸°ë³¸ ìŠ¤íƒ€ì¼ & ë°•ìŠ¤ ëª¨ë¸
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Pretendard', 'ë§‘ì€ ê³ ë”•', sans-serif;
      background: #f4f7f6; /* ë°°ê²½ìƒ‰ ì‚´ì§ ë³€ê²½ */
      color: #203326;
      font-size: 16px;
      margin: 0;
      padding: 24px;
    }

    .container {
      max-width: 100%;
      margin: auto;
      background: #ffffff; /* ì»¨í…Œì´ë„ˆ ë°°ê²½ í°ìƒ‰ */
      padding: 24px 32px 28px 32px;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(40, 80, 60, 0.08);
      overflow-x: auto;
    }

    .main-title-wrap {
      display: flex;
      flex-wrap: wrap; /* ë°˜ì‘í˜• */
      align-items: flex-end;
      justify-content: space-between;
      gap: 16px 24px; /* í‹ˆìƒˆ */
      min-height: 48px;
      margin-bottom: 28px;
      position: relative;
    }

    .main-title {
      font-size: 2.2rem;
      font-weight: 700;
      color: #184c37;
      margin: 0;
      letter-spacing: 0.02em;
      flex-shrink: 0; /* ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
    }

    .right-guide-inline {
      display: flex;
      flex-wrap: wrap; /* ë°˜ì‘í˜• */
      align-items: center;
      gap: 10px; /* í‹ˆìƒˆ */
      justify-content: flex-end;
      margin-left: auto;
    }

    /* * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
     * [ê°œì„ ] ë²„íŠ¼
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     */
    .guide-btn, .webfile-btn, button, .custom-file-label {
      min-width: 130px;
      height: 42px;
      background: #e1ece6;
      color: #2d684a;
      border: 1.2px solid #b0c9bb;
      border-radius: 9px;
      padding: 0 18px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s, border-color 0.14s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      margin: 0;
      white-space: nowrap; /* ë²„íŠ¼ ê¸€ì ì¤„ë°”ê¿ˆ ë°©ì§€ */
    }

    .guide-btn:hover, .webfile-btn:hover, button:hover, .custom-file-label:hover {
      background: #d2e3da;
      color: #184c37;
      border-color: #89ac98;
    }
    
    /* * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
     * [ê°œì„ ] ë“œë¡­ë‹¤ìš´ ê°€ì´ë“œ (ê¸°ì¡´)
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     */
    .guide-dropdown-wrap {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
      width: 100%;
    }

    #size-guide-info, #soldout-guide {
      font-size: 13px;
      max-width: 100%; /* ë„ˆë¹„ 100% */
      color: #203326;
      background: #f7faf7;
      border: 1px solid #e5eee5;
      padding: 12px 16px;
      border-radius: 8px;
    }
    #size-guide-info ul, #soldout-guide ul {
      margin: 4px 0 0 14px;
      padding: 0;
    }
    #size-guide-info b, #soldout-guide b {
      font-size: 13.5px;
      color: #184c37;
    }
    
    /* * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
     * [ê°œì„ ] ì˜µì…˜ ë°•ìŠ¤
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     */
    .option-box {
      background: #fbfdfb; /* ë” ë°ì€ ë°°ê²½ */
      border-radius: 18px;
      box-shadow: 0 2px 18px rgba(60, 100, 60, 0.04);
      padding: 24px 28px 28px 28px;
      max-width: 1800px;
      margin: 0 auto 36px auto;
      border: 1px solid #e5eee5;
    }

    .file-btn-wrap {
      display: flex;
      flex-wrap: wrap; /* ë°˜ì‘í˜• */
      align-items: center;
      gap: 10px 14px; /* í‹ˆìƒˆ */
      margin-bottom: 24px;
      margin-top: 0;
    }

    #fileName {
      font-size: 14px;
      color: #555;
    }

    #previewToggleBtn {
      background: #f2f4f7;
      color: #888;
      border-color: #d8dce0;
    }
    #previewToggleBtn.preview-on {
      background: #61ad80;
      color: #fff;
      border-color: #52946c;
    }

    /* * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
     * [ì‹ ê·œ] ì»¤ìŠ¤í…€ ë¼ë””ì˜¤/ì²´í¬ë°•ìŠ¤
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     */
    .option-group, .price-group, .download-option-wrap {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px 20px; /* ê°€ë¡œ ê°„ê²©ì„ 20pxë¡œ */
      margin-bottom: 20px;
      line-height: 1.5;
    }
    .option-group > span {
      font-weight: 500;
      color: #296149;
    }
    
    /* ê³µí†µ: input ìˆ¨ê¸°ê¸° */
    input[type="radio"], input[type="checkbox"] {
      display: none;
    }

    /* ê³µí†µ: label ìŠ¤íƒ€ì¼ */
    .option-group label, .price-group label, .download-option-wrap label {
      font-size: 15px;
      font-weight: 400;
      color: #333;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ê°„ê²© */
      user-select: none;
    }

    /* ê³µí†µ: ::before ê°€ìƒ ìš”ì†Œ (ì•„ì´ì½˜ ì˜ì—­) */
    .option-group label::before,
    .price-group label::before,
    .download-option-wrap label::before {
      content: '';
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 1.5px solid #b0c9bb;
      background: #fff;
      transition: border 0.15s, background 0.15s;
    }

    /* ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .option-group label::before {
      border-radius: 50%;
    }
    input[type="radio"]:checked + label::before {
      background: #fff;
      border-color: #184c37;
      /* ë‚´ë¶€ ì› */
      background-image: radial-gradient(#184c37 55%, transparent 60%);
      background-size: 18px 18px;
    }

    /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .price-group label::before,
    .download-option-wrap label::before {
      border-radius: 5px;
    }
    input[type="checkbox"]:checked + label::before {
      background: #184c37;
      border-color: #184c37;
      /* ì²´í¬ë§ˆí¬ (SVG) */
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
      background-size: 14px 14px;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
     * [ê°œì„ ] í• ì¸ìœ¨, ë¬´ë£Œë°°ì†¡ ì…ë ¥ í•„ë“œ
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     */
    .price-group {
      gap: 8px 12px; /* ê°„ê²© ë” ì¢ê²Œ */
      align-items: center;
      margin-bottom: 24px;
      background: #f7faf7;
      padding: 12px 16px;
      border-radius: 11px;
      border: 1px solid #e5eee5;
    }

    .price-group > span {
      font-size: 15px;
      font-weight: 500;
      color: #296149;
    }

    .price-group input[type="number"],
    .price-group select {
      height: 36px;
      padding: 0 10px;
      border: 1.2px solid #b0c9bb;
      border-radius: 7px;
      background: #fff;
      font-size: 15px;
      color: #203326;
      vertical-align: middle;
      outline: none;
      transition: border 0.18s;
    }
    
    .price-group input[type="number"] {
      width: 70px;
    }

    .price-group input[type="number"]:focus,
    .price-group select:focus {
      border: 1.5px solid #61ad80;
      background: #f5fcf8;
    }

    /* * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
     * [ê°œì„ ] í…Œì´ë¸”
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     */
    table {
      width: 100%;
      background: #f7faf9;
      border-radius: 11px;
      border-collapse: separate;
      border-spacing: 0;
      box-shadow: 0 1px 7px rgba(60, 120, 100, 0.03);
    }
    th, td {
      border-bottom: 1px solid #d2e3da;
      text-align: center;
      font-size: 15px;
      padding: 7px 3px;
    }
    th {
      background: #e4f1ea;
      color: #296149;
      font-weight: 600;
      border-top: 1.5px solid #b0c9bb; /* ìƒë‹¨ ì„  ìƒ‰ìƒ ì—°í•˜ê²Œ */
    }
    /* í…Œì´ë¸” ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
    th:first-child { border-top-left-radius: 11px; }
    th:last-child { border-top-right-radius: 11px; }
    tr:last-child td { border-bottom: none; }
    tr:last-child td:first-child { border-bottom-left-radius: 11px; }
    tr:last-child td:last-child { border-bottom-right-radius: 11px; }

    th, td { border-right: none !important; border-left: none !important; }

    /* ì´ë™/ëŒ€í‘œ/ì œì™¸ ì»¬ëŸ¼ ì¢ê²Œ */
    #inputTable th:nth-child(1), #inputTable td:nth-child(1),
    #inputTable th:nth-child(2), #inputTable td:nth-child(2),
    #inputTable th:nth-child(9), #inputTable td:nth-child(9) {
      width: 42px;
      min-width: 42px;
      max-width: 42px;
      text-align: center;
      vertical-align: middle;
      padding-left: 0;
      padding-right: 0;
    }

    /* í…Œì´ë¸” ë‚´ ì»¤ìŠ¤í…€ ë¼ë””ì˜¤/ì²´í¬ë°•ìŠ¤ */
    #inputTable td input[type="checkbox"],
    #inputTable td input[type="radio"] {
      display: none;
    }
    #inputTable td .col-move + label::before,
    #inputTable td .col-exclude + label::before {
      content: '';
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 1.5px solid #b0c9bb;
      border-radius: 5px;
      background: #fff;
      cursor: pointer;
      transition: 0.15s;
    }
    #inputTable td .col-rep + label::before {
      content: '';
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 1.5px solid #b0c9bb;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      transition: 0.15s;
    }
    
    #inputTable td input[type="checkbox"]:checked + label::before {
      background: #5a92d6;
      border-color: #5a92d6;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
      background-size: 14px 14px;
      background-position: center;
      background-repeat: no-repeat;
    }
    #inputTable td input[type="radio"]:checked + label::before {
      border-color: #5a92d6;
      background-image: radial-gradient(#5a92d6 55%, transparent 60%);
      background-size: 18px 18px;
    }


    /* í‘œ ë‚´ë¶€ ì…ë ¥ë€ í†µì¼ */
    #inputTable td input[type="text"],
    #inputTable td input[type="number"],
    input[type="text"], input[type="number"] {
      width: 100%;
      background: #f7faf9;
      border: 1.2px solid #bedfc8;
      border-radius: 5px;
      padding: 7px 7px;
      font-size: 15px;
      color: #203326;
      outline: none;
      transition: border 0.18s, background 0.18s;
      box-sizing: border-box;
    }
    #inputTable td input[type="text"]:focus,
    #inputTable td input[type="number"]:focus,
    input[type="text"]:focus, input[type="number"]:focus {
      border: 1.5px solid #61ad80;
      background: #eef8f2;
    }

    #inputTable tr { height: 38px; }
    #inputTable th, #inputTable td { font-size: 14.3px; }
    #inputTable th { font-size: 14.5px; }

    /* ë„¤ì´ë²„ ê·œì • ìœ„ë°˜ ì˜µì…˜ */
    .invalid-option,
    #inputTable tr.invalid-option {
      background: #fff2f2 !important;
    }
    #inputTable tr.invalid-option td {
      background: #fff2f2 !important;
    }
    #inputTable tr.invalid-option td input {
      background: #fff8f8;
      border-color: #f7c3c3;
    }

    /* í–‰ì¡°ì‘ ë²„íŠ¼ ê·¸ë£¹ */
    .table-action-btns {
      margin-top: 20px;
      margin-bottom: 16px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* ë‹¤ìš´ë¡œë“œ ì˜µì…˜ (ì¤‘ì•™ì •ë ¬) */
    .download-option-wrap {
      justify-content: center;
      margin: 38px 0 18px 0;
      background: #f7faf7;
      padding: 12px 16px;
      border-radius: 11px;
      border: 1px solid #e5eee5;
    }
    .download-option-wrap label {
      color: #296149;
      font-weight: 500;
      letter-spacing: 0.01em;
    }

    /* ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ì¤‘ì•™ì •ë ¬) */
    .download-btn-wrap {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px 16px;
      margin-bottom: 0;
    }
    .download-btn-wrap button {
      min-width: 160px;
      margin: 0;
    }

    /* ìˆ«ìí•„ë“œ ìŠ¤í•€ ì œê±° */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    /* ë¯¸ë¦¬ë³´ê¸° ì˜µì…˜ ì•„ì´í…œ */
    .preview-option-item {
      background: #e1ece6;
      border-radius: 7px;
      padding: 3px 8px;
      margin-bottom: 4px;
      cursor: pointer;
      user-select: none;
      transition: 0.13s, color 0.13s;
    }
    .preview-option-item.selected {
      background: #f3d8d8 !important;
      color: #b45454 !important;
    }

    /* ë“œë˜ê·¸ ì¤‘ ì‹œê°ì  ê°•ì¡° */
    .file-btn-wrap.dragover {
      outline: 2px dashed #61ad80;
      outline-offset: 4px;
      background: #f2fbf6;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 900px) {
      body { padding: 12px; }
      .container { padding: 16px; }

      .main-title-wrap,
      .right-guide-inline {
        flex-direction: column;
        gap: 7px;
        align-items: stretch;
      }
      .right-guide-inline {
        margin-left: 0;
      }
      .guide-btn, .webfile-btn, .right-guide-inline button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-title-wrap">
      <h1 class="main-title">ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ìë™ ìƒì„±ê¸°</h1>
      <div class="right-guide-inline">
        <button class="guide-btn" id="toggle-size-guide-btn">ì‚¬ì´ì¦ˆ ì…ë ¥ ë°©ë²• ì•ˆë‚´</button>
        <button class="guide-btn" id="toggle-out-guide-btn">í’ˆì ˆ ì…ë ¥ ì˜ˆì‹œ</button>
        <button class="guide-btn webfile-btn" id="webfile-link-btn">ì›¹ íŒŒì¼</button>
        <button id="openStockToolBtn" class="guide-btn webfile-btn">ê´€ë¦¬ì½”ë“œ ì¼ê´„ í’ˆì ˆíˆ´</button>
      </div>
    </div>
    
    <div class="guide-dropdown-wrap">
      <div id="size-guide-info" style="display:none;">
        <b>ì‚¬ì´ì¦ˆ ì…ë ¥ ë°©ë²• ì•ˆë‚´</b>
        <ul>
          <li>ë²”ìœ„ ì…ë ¥: 230~240 â†’ 5ë‹¨ìœ„ ìë™ ìƒì„± (ì˜ˆ: 230,235,240)</li>
          <li>ê°œë³„ ì…ë ¥: 230,235/245 â†’ ì‰¼í‘œ ë˜ëŠ” ìŠ¬ë˜ì‹œë¡œ ì§ì ‘ ì§€ì •</li>
          <li>ë„¤ì´ë²„ ê·œì •ì— ë”°ë¼ ë¯¸ë‹¬Â·ì´ˆê³¼ ì˜µì…˜ì€ ë‹¤ìš´ë¡œë“œ ì‹œ ìë™ ì œê±°ë˜ë©°, ë¹¨ê°„ìƒ‰ í‘œì‹œ</li>
        </ul>
      </div>
      <div id="soldout-guide" class="guide-dropdown" style="display: none;">
        <b>í’ˆì ˆ ì…ë ¥ ì˜ˆì‹œ</b><br>
        â€¢ ì˜ˆì‹œ1) ë¸”ë™, ë¸”ë£¨<br>
        â€¢ ì˜ˆì‹œ2) 90,100,105<br>
        â€¢ ì˜ˆì‹œ3) ë¸”ë™-100, ë¸”ë£¨-105
      </div>
    </div>

    <div class="option-box">
      <div class="file-btn-wrap">
        <input type="file" id="inputFile" style="display:none;">
        <label for="inputFile" class="custom-file-label">íŒŒì¼ ì„ íƒ</label>
        <span id="fileName">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
        <button type="button" class="webfile-btn" id="download-template-btn">ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
        <button type="button" id="previewToggleBtn" style="margin-left:auto;">ì˜µì…˜ ë¯¸ë¦¬ë³´ê¸° OFF</button>
      </div>
      
      <div class="option-group">
        <span>ì˜µì…˜ ë…¸ì¶œ ë°©ì‹:</span>
        <input type="radio" name="optionDisplay" value="both" id="opt-both" checked>
        <label for="opt-both">ìƒ‰ìƒ&ì‚¬ì´ì¦ˆ ëª¨ë‘</label>
        <input type="radio" name="optionDisplay" value="colorOnly" id="opt-color">
        <label for="opt-color">ìƒ‰ìƒë§Œ</label>
        <input type="radio" name="optionDisplay" value="sizeOnly" id="opt-size">
        <label for="opt-size">ì‚¬ì´ì¦ˆë§Œ</label>
        <input type="radio" name="optionDisplay" value="nameOnly" id="opt-name">
        <label for="opt-name">ìƒí’ˆëª…ë§Œ</label>
      </div>
      
      <div class="price-group">
        <span>ì˜µì…˜ê°€ ê³„ì‚° í• ì¸ë¥ </span>
        <input type="number" id="discountRate" value="100">%
        
        <input type="checkbox" id="freeShippingOption">
        <label for="freeShippingOption">ë¬´ë£Œë°°ì†¡</label>
        
        <select id="freeShippingType">
          <option value="won">ì›</option>
          <option value="percent">%</option>
        </select>
        <input type="number" id="freeShippingAmount" value="2500" style="width: 70px;">
      </div>

      <table id="inputTable">
        <thead>
          <tr>
            <th>ì´ë™</th>
            <th>ëŒ€í‘œ</th>
            <th>ìƒí’ˆëª…</th>
            <th>íŒë§¤ê°€</th>
            <th>ìƒ‰ìƒ</th>
            <th>ì‚¬ì´ì¦ˆ</th>
            <th>1ë²ˆ ìƒí’ˆëª…</th>
            <th>í’ˆì ˆëœ ì¡°í•©</th>
            <th>ì œì™¸</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
      
      <div class="table-action-btns">
        <button>+ í–‰ ì¶”ê°€</button>
        <button>ì´ˆê¸°í™”</button>
        <button>ìˆœì„œ ì´ˆê¸°í™”</button>
        <button>ë§¨ ìœ„ë¡œ</button>
        <button>ìœ„ë¡œ</button>
        <button>ì•„ë˜ë¡œ</button>
        <button>ë§¨ ì•„ë˜ë¡œ</button>
      </div>
      
      <div class="download-option-wrap">
        <input type="checkbox" id="hideBrand">
        <label for="hideBrand">ë¸Œëœë“œ ì œê±°</label>
        
        <input type="checkbox" id="splitProductCode">
        <label for="splitProductCode">ìƒí’ˆì½”ë“œ ë¶„ë¦¬</label>
        
        <input type="checkbox" id="appendCodeToSize">
        <label for="appendCodeToSize">ì‚¬ì´ì¦ˆì— ìƒí’ˆì½”ë“œ</label>
        
        <input type="checkbox" id="allFirstName">
        <label for="allFirstName">ëª¨ë‘ 1ë²ˆìƒí’ˆëª…</label>
      </div>

      <div class="download-btn-wrap">
        <button id="downloadRepresentativeBtn">ì„ íƒìƒí’ˆ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        <button id="downloadZipBtn">ì¼ê´„ ZIP ë‹¤ìš´ë¡œë“œ</button>
        <button id="downloadAddProductBtn">ì¶”ê°€ìƒí’ˆ ë‹¤ìš´ë¡œë“œ</button>
        <button id="downloadSingleProductBtn">ë‹¨í’ˆë“±ë¡ ë‹¤ìš´ë¡œë“œ</button>
        <button id="downloadSingleAllBtn">ë‹¨í’ˆ ì „ì²´ ZIP</button>
        <button id="downloadOrderedBtn">ìˆœì„œë°˜ì˜ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>
  </div>
  
<script>
// 
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
// [ê°œì„ ] IIFE (ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
//
(function() {

  // (ìµœìƒë‹¨!) ì „ì—­ ì„ ì–¸ í•„ìš”
  let originalData = [];

  // ì˜µì…˜ ë¯¸ë¦¬ë³´ê¸° ê¸°ë³¸ê°’ OFF
  let previewEnabled = false; // ê¸°ë³¸ê°’ OFF

  document.getElementById('openStockToolBtn').addEventListener('click', function() {
    window.open('https://easyhara.github.io/stock_zero_tool/stock_zero_tool.html', '_blank');
  });

  // ë¸Œëœë“œ, ìƒí’ˆì½”ë“œ, ë¶„ë¥˜, ì¡°í•©ì„ ì¶”ì¶œ
  function parseBrandProductType(name) {
    if (!name) return { brand: '', codes: [], type: '', manageCodes: [] };
    const arr = name.trim().split(/\s+/);
    const brand = arr[0];
    if (arr.length === 1) {
      return { brand, codes: [brand], type: brand, manageCodes: [`${brand}`] };
    } else if (arr.length === 2) {
      return { brand, codes: [arr[1]], type: arr[1], manageCodes: [`${brand} ${arr[1]}`] };
    } else {
      const type = arr[arr.length - 1];
      const codes = arr.slice(1, -1);

      // ê´€ë¦¬ì½”ë“œ = ë¸Œëœë“œ + ê° ì½”ë“œ + ë¶„ë¥˜
      let manageCodes = codes.map(code => {
        let combo = `${brand} ${code} ${type}`;
        let combo20 = combo.replace(/\s+/g, '');
        return combo20.length > 20 ? combo20.slice(0, 20) : combo;
      });
      if (manageCodes.length === 0) manageCodes = [`${brand} ${type}`];
      return { brand, codes, type, manageCodes };
    }
  }

  // ë¸Œëœë“œê°€ ì´ë¯¸ í¬í•¨ëœ ìƒí’ˆëª…ì¸ì§€ í™•ì¸í•˜ê³ , ì—†ì„ ë•Œë§Œ ë¸Œëœë“œë¥¼ í•œ ë²ˆ ë¶™ì—¬ì„œ ë°˜í™˜
  function buildBaseName(item, itemInfo, useAllFirstName, isMaster) {
    // 1) ì›ë˜ ì“¸ ì´ë¦„(1ë²ˆ ìƒí’ˆëª… ìš°ì„  ê·œì¹™ ìœ ì§€)
    let rawName;
    if (useAllFirstName) {
      rawName = item["1ë²ˆ ìƒí’ˆëª…"] || item.ìƒí’ˆëª…;
    } else {
      rawName = isMaster ? (item["1ë²ˆ ìƒí’ˆëª…"] || item.ìƒí’ˆëª…) : item.ìƒí’ˆëª…;
    }
    rawName = (rawName || "").trim();

    // 2) ë¸Œëœë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
    const brand = (itemInfo.brand || "").trim();
    if (!brand) return rawName;

    // 3) ì´ë¯¸ "ë¸Œëœë“œ ..."ë¡œ ì‹œì‘í•˜ë©´ ì¤‘ë³µ ë°©ì§€
    if (rawName.startsWith(brand + " ") || rawName === brand) return rawName;

    // 4) ë¸Œëœë“œ í•œ ë²ˆë§Œ ì ‘ë‘ë¡œ ë¶™ì—¬ ë°˜í™˜
    return `${brand} ${rawName}`.trim();
  }

  // â–¶ JSON ë°ì´í„° â†’ ì‹œíŠ¸ ìë™ ë„ˆë¹„ í•¨ìˆ˜
  function autoWidth(ws, data, header) {
    const colWidths = header.map(hdr => {
      let maxLen = hdr.length;        // í—¤ë” ê¸¸ì´ ê¸°ì¤€
      data.forEach(row => {
        const v = row[hdr];
        if (v != null) {
          const len = v.toString().length;
          if (len > maxLen) maxLen = len;
        }
      });
      return { wch: maxLen + 2 };      // +2 ì—¬ìœ 
    });
    ws['!cols'] = colWidths;
  }

  // â–¶ AOA(2ì°¨ì› ë°°ì—´) â†’ ì‹œíŠ¸ ìë™ ë„ˆë¹„ í•¨ìˆ˜
  function autoWidthAoA(ws, aoa) {
    const colCount = aoa[0]?.length || 0;
    const colWidths = [];
    for (let c = 0; c < colCount; c++) {
      let maxLen = 0;
      aoa.forEach(row => {
        const val = row[c] != null ? row[c].toString() : "";
        if (val.length > maxLen) maxLen = val.length;
      });
      colWidths.push({ wch: maxLen + 2 });
    }
    ws['!cols'] = colWidths;
  }

  //ë“œë¡­ë‹¤ìš´ ë²„íŠ¼
  document.addEventListener('DOMContentLoaded', function() {
    // í• ì¸ìœ¨ input ì´ë²¤íŠ¸ ë°”ì¸ë”©
    var discountInput = document.getElementById('discountRate');
    if (discountInput) {
      discountInput.addEventListener('input', highlightInvalidOptions);
      discountInput.addEventListener('change', highlightInvalidOptions);
    }

    // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë°”ì¸ë”© (input[type=file] ì‚¬ìš©)
    var inputFile = document.getElementById('inputFile');
    if (inputFile) {
      inputFile.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // íŒŒì¼ëª… í‘œì‹œ
        document.getElementById('fileName').innerText = file.name;
        
        const reader = new FileReader();
        reader.onload = evt => {
          const data = new Uint8Array(evt.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
          clearTable();
          json.forEach(r => addRow({
            ìƒí’ˆëª…: r['ìƒí’ˆëª…'],
            íŒë§¤ê°€: r['íŒë§¤ê°€'],
            ìƒ‰ìƒ:   r['ìƒ‰ìƒ'],
            ì‚¬ì´ì¦ˆ: r['ì‚¬ì´ì¦ˆ'],
            '1ë²ˆ ìƒí’ˆëª…': r['1ë²ˆ ìƒí’ˆëª…'],
            í’ˆì ˆëœì¡°í•©: r['í’ˆì ˆëœ ì¡°í•©'] || '',
            ì œì™¸: r['ì œì™¸'] === 'Y'
          }));
          // === ì¶”ê°€ ì½”ë“œ ===
          Array.from(document.querySelectorAll('#inputTable tbody tr')).forEach(row => {
            if (!row.classList.contains('row-option-preview')) { // ë¯¸ë¦¬ë³´ê¸° í–‰ ì œì™¸
              updateOptionPreviewForRow(row);
            }
          });
          originalData = getDataFromTable();
          highlightInvalidOptions();
        }; // â† ì—¬ê¸°ì„œ onload í•¨ìˆ˜ ë‹«ê¸°

        reader.readAsArrayBuffer(file); // â† onload í•¨ìˆ˜ ë°–ì— ìœ„ì¹˜í•´ì•¼ í•¨!
      });
    }

    // ì‚¬ì´ì¦ˆ ì…ë ¥ ì•ˆë‚´
    const sizeBtn = document.getElementById('toggle-size-guide-btn');
    const sizeInfo = document.getElementById('size-guide-info');
    if (sizeBtn && sizeInfo) {
      sizeBtn.addEventListener('click', function() {
        sizeInfo.style.display = (sizeInfo.style.display === 'none' || sizeInfo.style.display === '') ? 'block' : 'none';
      });
    }
    // í’ˆì ˆ ì…ë ¥ ì˜ˆì‹œ
    const outBtn = document.getElementById('toggle-out-guide-btn');
    const outInfo = document.getElementById('soldout-guide');
    if (outBtn && outInfo) {
      outBtn.addEventListener('click', function() {
        outInfo.style.display = (outInfo.style.display === 'none' || outInfo.style.display === '') ? 'block' : 'none';
      });
    }
    // ì›¹íŒŒì¼ ë²„íŠ¼ ìƒˆ íƒ­ ë§í¬
    const webfileBtn = document.getElementById('webfile-link-btn');
    if (webfileBtn) {
      webfileBtn.addEventListener('click', function() {
        window.open('https://github.com/EasyHara/smartstore_options/blob/main/smartstore_options.html', '_blank');
      });
    }

    // ë¬´ë£Œë°°ì†¡ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.getElementById('freeShippingOption').addEventListener('change', highlightInvalidOptions);
    document.getElementById('freeShippingAmount').addEventListener('input', highlightInvalidOptions);
    document.getElementById('freeShippingType').addEventListener('change', highlightInvalidOptions);

  });

  // 
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  // [ğŸ’¥ğŸ’¥ ë²„ê·¸ ìˆ˜ì • ğŸ’¥ğŸ’¥]
  // Sortable.jsì˜ ìì²´ Ctrl+Click ê¸°ëŠ¥ê³¼ ì¶©ëŒí•˜ë˜
  // onRowClick í•¨ìˆ˜ë¥¼ ì™„ì „íˆ ì‚­ì œí•©ë‹ˆë‹¤.
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  //
  /*
  function onRowClick(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') {
        return;
    }
    if (e.ctrlKey || e.metaKey) {
        this.classList.toggle('selected');
    }
  }
  */

  // í• ì¸ë¥  ì¸í’‹ í´ë¦­ ì‹œ 100ì´ë©´ ìë™ìœ¼ë¡œ ì§€ì›€
  document.getElementById('discountRate').addEventListener('focus', function(e) {
    if (e.target.value === '100') e.target.value = '';
  });
  // í¬ì»¤ìŠ¤ í•´ì œì‹œ ë¹„ì–´ìˆìœ¼ë©´ ë‹¤ì‹œ 100
  document.getElementById('discountRate').addEventListener('blur', function(e) {
    if (e.target.value === '') e.target.value = '100';
  });

  // 
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  // [ë¦¬íŒ©í† ë§] addRow: ì•ˆì •ì„±ì„ ìœ„í•´ inputì— class ì¶”ê°€
  // [ğŸ’¥ğŸ’¥ ë²„ê·¸ ìˆ˜ì • ğŸ’¥ğŸ’¥] onRowClick ë¦¬ìŠ¤ë„ˆ ì—°ê²° ì½”ë“œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  //
  function addRow(data = {}) {
    const tbody = document.querySelector('#inputTable tbody');
    const row = document.createElement('tr');
    
    // ìœ ë‹ˆí¬ ID ìƒì„± (label for)
    const uniqueId = `row-${tbody.children.length}-${Math.random().toString(16).slice(2)}`;

    row.innerHTML = `
      <td>
        <input type="checkbox" class="to-move col-move" id="${uniqueId}-move">
        <label for="${uniqueId}-move"></label>
      </td>
      <td>
        <input type="radio" name="ëŒ€í‘œ" class="col-rep" id="${uniqueId}-rep" ${data.ëŒ€í‘œ ? "checked" : ""}>
        <label for="${uniqueId}-rep"></label>
      </td>
      <td><input type="text" class="col-name" value="${data.ìƒí’ˆëª… || ""}"></td>
      <td><input type="number" class="col-price" value="${data.íŒë§¤ê°€ || ""}"></td>
      <td><input type="text" class="col-color" value="${data.ìƒ‰ìƒ || ""}"></td>
      <td><input type="text" class="col-size" value="${data.ì‚¬ì´ì¦ˆ || ""}"></td>
      <td><input type="text" class="col-firstname" value="${data['1ë²ˆ ìƒí’ˆëª…'] || ""}"></td>
      <td><input type="text" class="col-soldout" value="${data.í’ˆì ˆëœì¡°í•© || ""}"></td>
      <td>
        <input type="checkbox" class="col-exclude" id="${uniqueId}-exclude" ${data.ì œì™¸ ? "checked" : ""}>
        <label for="${uniqueId}-exclude"></label>
      </td>
    `;
    
    // í´ë¦­/ì…ë ¥ ë“± ì´ë²¤íŠ¸ ë°”ì¸ë”©
    // row.addEventListener('click', onRowClick); // <-- [ğŸ’¥ ë²„ê·¸ ìˆ˜ì •] ì´ ë¼ì¸ì„ ì‚­ì œ
    
    row.querySelectorAll('input').forEach(input => {
      input.addEventListener('input', function(){
        updateOptionPreviewForRow(row);
        highlightInvalidOptions();
      });
      input.addEventListener('change', function(){
        updateOptionPreviewForRow(row);
        highlightInvalidOptions();
      });
    });

    // [ë¦¬íŒ©í† ë§] classë¡œ í’ˆì ˆ ì¸í’‹ì„ ì°¾ìŒ
    const soldoutInput = row.querySelector('.col-soldout');
    if (soldoutInput) {
      soldoutInput.addEventListener('input', function() {
        highlightInvalidOptions();
      });
    }

    tbody.appendChild(row);
    highlightInvalidOptions();
    updateOptionPreviewForRow(row);
  }

  // 
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  // [âœ… ìµœì¢… ë²„ê·¸ ìˆ˜ì •]
  // preventOnFilter: falseë¡œ ì„¤ì •í•˜ì—¬
  // í•„í„°ëœ ìš”ì†Œ(input, label)ì˜ ê¸°ë³¸ ë™ì‘(ì…ë ¥, í´ë¦­)ì„ 'í—ˆìš©'í•©ë‹ˆë‹¤.
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  //
  Sortable.create(document.querySelector('#inputTable tbody'), {
    animation: 150,
    filter: 'input, label', // inputì´ë‚˜ label í´ë¦­ ì‹œ ë“œë˜ê·¸ ë°©ì§€
    preventOnFilter: false,  // <-- âœ… 'false'ë¡œ ìˆ˜ì •í•´ì•¼ ì…ë ¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    multiDrag: true,
    selectedClass: 'selected',
    multiDragKey: 'ctrl',
    fallbackTolerance: 3
  });
  
  // 
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  // [ë¦¬íŒ©í† ë§] downloadOrderedTemplate: class ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„° ìˆ˜ì§‘
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  //
  function downloadOrderedTemplate() {
    // 1) í—¤ë” ì •ì˜ (ìŠ¤ìŠ¤_ì˜µì…˜ì–‘ì‹ê³¼ ë™ì¼)
    const headers = [
      "ìƒí’ˆëª…", "íŒë§¤ê°€", "ìƒ‰ìƒ", "ì‚¬ì´ì¦ˆ", "1ë²ˆ ìƒí’ˆëª…", "í’ˆì ˆëœ ì¡°í•©", "ì œì™¸"
    ];

    // 2) í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ìˆœì„œëŒ€ë¡œ <tbody>ì˜ ê° <tr>ì„ ì½ì–´ì„œ ë°ì´í„° ë°°ì—´ ìƒì„±
    const data = Array.from(document.querySelectorAll('#inputTable tbody tr'))
    .filter(row => !row.classList.contains('row-option-preview')) // ë¯¸ë¦¬ë³´ê¸° tr ì œì™¸!
    .map(row => {
      // [ë¦¬íŒ©í† ë§] ì¸ë±ìŠ¤ ëŒ€ì‹  classë¡œ ê°’ ì ‘ê·¼
      return [
        row.querySelector('.col-name')?.value.trim() || '',
        parseInt(row.querySelector('.col-price')?.value, 10) || 0,
        row.querySelector('.col-color')?.value.trim() || '',
        row.querySelector('.col-size')?.value.trim() || '',
        row.querySelector('.col-firstname')?.value.trim() || '',
        row.querySelector('.col-soldout')?.value.trim() || '',
        row.querySelector('.col-exclude')?.checked ? 'Y' : ''
      ];
    })
    .filter(Boolean); // null(ë¹„ì •ìƒí–‰) ì œê±°

    // 3) SheetJSë¡œ ì›Œí¬ì‹œíŠ¸, ì›Œí¬ë¶ ìƒì„±
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    autoWidthAoA(ws, [headers, ...data]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ìƒí’ˆì˜µì…˜");

    // 4) Blobìœ¼ë¡œ ë³€í™˜ í›„ FileSaver.jsë¡œ ë‹¤ìš´ë¡œë“œ
    const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/octet-stream' });
    saveAs(blob, 'ìŠ¤ìŠ¤_ì˜µì…˜ì–‘ì‹-ìˆœì„œë°˜ì˜.xls');
  }

  // í…Œì´ë¸” ì´ˆê¸°í™”
  function clearTable() {
    document.querySelector('#inputTable tbody').innerHTML = '';
    document.getElementById('inputFile').value = '';    // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
    document.getElementById('fileName').innerText = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ'; // [ê°œì„ ] íŒŒì¼ëª… ì´ˆê¸°í™”
    originalData = [];
    highlightInvalidOptions();
  }

  // ì›ë˜ ìˆœì„œ ë³µì›
  function resetOrder() {
    const tbody = document.querySelector('#inputTable tbody');
    tbody.innerHTML = '';
    originalData.forEach(d => addRow(d));
  }

  // 
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  // [ë¦¬íŒ©í† ë§] getDataFromTable: class ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„° ìˆ˜ì§‘
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  //
  function getDataFromTable() {
    return Array.from(document.querySelectorAll('#inputTable tbody tr')).map(row => {
      if (row.classList.contains('row-option-preview')) return null; // ë¯¸ë¦¬ë³´ê¸° í–‰ ì œì™¸

      // [ë¦¬íŒ©í† ë§] ì¸ë±ìŠ¤ ëŒ€ì‹  classë¡œ ê°’ ì ‘ê·¼
      return {
        ëŒ€í‘œ: row.querySelector('.col-rep')?.checked,
        ìƒí’ˆëª…: row.querySelector('.col-name')?.value.trim(),
        íŒë§¤ê°€: parseInt(row.querySelector('.col-price')?.value) || 0,
        ìƒ‰ìƒ: row.querySelector('.col-color')?.value.trim(),
        ì‚¬ì´ì¦ˆ: row.querySelector('.col-size')?.value.trim(),
        ['1ë²ˆ ìƒí’ˆëª…']: row.querySelector('.col-firstname')?.value.trim(),
        í’ˆì ˆëœì¡°í•©: row.querySelector('.col-soldout')?.value.trim(),
        ì œì™¸: row.querySelector('.col-exclude')?.checked
      };
    }).filter(Boolean);
  }


  // ì„ íƒëœ í–‰ì„ ìœ„ë¡œ/ì•„ë˜ë¡œ ì´ë™
  function moveSelectedUp() {
    const tbody = document.querySelector('#inputTable tbody');
    // ëª¨ë“  í–‰ì„ ë°°ì—´ë¡œ, ìœ„ìª½ë¶€í„° ìˆœíšŒí•˜ë©°
    Array.from(tbody.querySelectorAll('tr')).forEach(row => {
      const cb = row.querySelector('.to-move');
      if (!cb || !cb.checked) return;
      const prev = row.previousElementSibling;
      if (prev) tbody.insertBefore(row, prev);
    });
  }
  function moveSelectedDown() {
    const tbody = document.querySelector('#inputTable tbody');
    Array.from(tbody.querySelectorAll('tr')).reverse().forEach(row => {
      const cb = row.querySelector('.to-move');
      if (cb && cb.checked) {
        const next = row.nextElementSibling;
        if (next) tbody.insertBefore(next, row);
      }
    });
  }
  // ì„ íƒëœ í–‰ì„ ë§¨ ìœ„ë¡œ ì´ë™
  function moveSelectedToTop() {
    const tbody = document.querySelector('#inputTable tbody');
    // ì²´í¬ëœ í–‰ë“¤ì„ ìœ„â†’ì•„ë˜ ìˆœì„œë¡œ ì°¾ì•„ì„œ
    Array.from(tbody.querySelectorAll('tr')).forEach(row => {
      const cb = row.querySelector('.to-move');
      if (cb && cb.checked) {
        // ë§¨ ìœ„(ì²« ë²ˆì§¸ ìì‹) ì•ì— ì‚½ì…
        tbody.insertBefore(row, tbody.firstElementChild);
      }
    });
  }
  // ì„ íƒëœ í–‰ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
  function moveSelectedToBottom() {
    const tbody = document.querySelector('#inputTable tbody');
    // ì²´í¬ëœ í–‰ë“¤ì„ ì•„ë˜â†’ìœ„ ìˆœì„œë¡œ ì°¾ì•„ì„œ
    Array.from(tbody.querySelectorAll('tr')).reverse().forEach(row => {
      const cb = row.querySelector('.to-move');
      if (cb && cb.checked) {
        tbody.appendChild(row);
      }
    });
  }

  // ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
  function downloadTemplate() {
    const headers = ['ìƒí’ˆëª…','íŒë§¤ê°€','ìƒ‰ìƒ','ì‚¬ì´ì¦ˆ','1ë²ˆ ìƒí’ˆëª…','í’ˆì ˆëœ ì¡°í•©','ì œì™¸'];
    const ws = XLSX.utils.aoa_to_sheet([headers]);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'ìƒí’ˆì˜µì…˜');
    const blob = new Blob([XLSX.write(wb,{bookType:'xls',type:'array'})],{type:'application/octet-stream'});
    saveAs(blob,'ìŠ¤ìŠ¤_ì˜µì…˜ì–‘ì‹.xls');
  }


  // ë„¤ì´ë²„ ì˜µì…˜ê°€ ìœ íš¨ì„± ê²€ì‚¬
  function isValidOptionPrice(basePrice, diff) {
    if (basePrice < 2000) return diff >= 0 && diff <= basePrice;
    if (basePrice < 10000) return diff >= -basePrice * 0.5 && diff <= basePrice;
    return diff >= -basePrice * 0.5 && diff <= basePrice * 0.5;
  }

  // í• ì¸ë¥  ê¸°ì¤€ ì›ê°€ ê³„ì‚°
  function calculateOriginalPrice(salePrice, discountRate) {
    const raw = salePrice / (1 - discountRate / 100);
    return Math.round(raw / 100) * 100;
  }

  // 
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  // [ë¦¬íŒ©í† ë§] highlightInvalidOptions: class ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„° ìˆ˜ì§‘
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  //
  function highlightInvalidOptions() {
    const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
    const freeShipping = document.getElementById('freeShippingOption')?.checked;
    const tbody = document.querySelector('#inputTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('row-option-preview')); // ë¯¸ë¦¬ë³´ê¸° í–‰ ì œì™¸
    if (!rows.length) return;

    // ëŒ€í‘œí–‰ ì°¾ê¸° (ì—†ìœ¼ë©´ ì²« í–‰)
    let ëŒ€í‘œ = null;
    rows.forEach(row => {
      const radio = row.querySelector('.col-rep'); // [ë¦¬íŒ©í† ë§] class
      if (radio && radio.checked) ëŒ€í‘œ = row;
    });
    if (!ëŒ€í‘œ) ëŒ€í‘œ = rows[0];

    if (!ëŒ€í‘œ) return; // [ë°©ì–´] ëŒ€í‘œí–‰ì´ ì•„ì˜ˆ ì—†ìœ¼ë©´ ì¢…ë£Œ

    // [ë¦¬íŒ©í† ë§] class
    const ëŒ€í‘œíŒë§¤ê°€ = parseInt(ëŒ€í‘œ.querySelector('.col-price')?.value, 10) || 0;
    const masterPrice = calculateOriginalPrice(ëŒ€í‘œíŒë§¤ê°€, discountRate);

    // ë¬´ë£Œë°°ì†¡ ë¡œì§ì„ ìœ„í•œ ë³€ìˆ˜ ì„ ì–¸
    const freeShippingAmount = parseFloat(document.getElementById('freeShippingAmount')?.value) || 0;
    const freeShippingType = document.getElementById('freeShippingType')?.value || 'won';

    rows.forEach(row => {
      // [ë¦¬íŒ©í† ë§] class
      const íŒë§¤ê°€ = parseInt(row.querySelector('.col-price')?.value, 10) || 0;
      const ìƒ‰ìƒ = row.querySelector('.col-color')?.value.trim();
      const ì‚¬ì´ì¦ˆ = row.querySelector('.col-size')?.value.trim();
      const í’ˆì ˆëœì¡°í•© = row.querySelector('.col-soldout')?.value.trim();
      const isMaster = (row === ëŒ€í‘œ);

      // ìµœì¢… ì˜µì…˜ê°€: diff + ë¬´ë£Œë°°ì†¡ ì²´í¬ì‹œ ê¸ˆì•¡ ì¶”ê°€ (ëŒ€í‘œëŠ” ë¬´ë£Œë°°ì†¡ ë¯¸ì ìš©)
      let diff = íŒë§¤ê°€ - ëŒ€í‘œíŒë§¤ê°€;
      if (freeShipping && !isMaster) {
        if (freeShippingType === 'percent') {
          diff += ëŒ€í‘œíŒë§¤ê°€ * (freeShippingAmount / 100);
        } else { // 'won'
          diff += freeShippingAmount;
        }
      }

      // ------ í’ˆì ˆ ì˜µì…˜ ì²´í¬ ì‹œì‘ ------
      let invalid = false;
      if (í’ˆì ˆëœì¡°í•©) {
        const soldoutArr = í’ˆì ˆëœì¡°í•©.split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);
        // ìƒ‰ìƒ, ì‚¬ì´ì¦ˆ ì¡°í•© ëª¨ë‘ ìˆëŠ” ê²½ìš°
        if (ìƒ‰ìƒ && ì‚¬ì´ì¦ˆ) {
          const colors = parseOptions(ìƒ‰ìƒ);
          const sizes = expandSizes(ì‚¬ì´ì¦ˆ);
          const combinations = colors.flatMap(color => sizes.map(size => `${color}-${size}`));
          if (
            combinations.length > 0 &&
            combinations.every(c =>
              soldoutArr.includes(c) ||
              soldoutArr.includes(c.split('-')[0]) ||
              soldoutArr.includes(c.split('-')[1])
            )
          ) {
            invalid = true; // ëª¨ë“  ì¡°í•©ì´ í’ˆì ˆì´ë©´ í–‰ ì „ì²´ invalid-option
          }
        } else if (ìƒ‰ìƒ) {
          // ì‚¬ì´ì¦ˆ ì—†ì´ ìƒ‰ìƒë§Œ ìˆì„ ë•Œ
          const colors = parseOptions(ìƒ‰ìƒ);
          if (colors.length > 0 && colors.every(c => soldoutArr.includes(c))) {
            invalid = true;
          }
        } else if (ì‚¬ì´ì¦ˆ) {
          // ìƒ‰ìƒ ì—†ì´ ì‚¬ì´ì¦ˆë§Œ ìˆì„ ë•Œ
          const sizes = expandSizes(ì‚¬ì´ì¦ˆ);
          if (sizes.length > 0 && sizes.every(sz => soldoutArr.includes(sz))) {
            invalid = true;
          }
        }
      }
      // ------ ê¸°ì¡´ ê°€ê²© ìœ„ë°˜ ì²´í¬ë„ í•¨ê»˜ ì²˜ë¦¬ ------
      if (!isValidOptionPrice(masterPrice, diff)) {
        invalid = true;
      }

      if (invalid) {
        row.classList.add('invalid-option');
      } else {
        row.classList.remove('invalid-option');
      }
    });
  }

  // ì´ë²¤íŠ¸ ì—°ê²°
  document.getElementById('discountRate').addEventListener('input', highlightInvalidOptions);
  document.getElementById('freeShippingOption').addEventListener('change', highlightInvalidOptions);

  // ì‚¬ì´ì¦ˆì— ìƒí’ˆì½”ë“œ ë¶™ì´ê¸°
  function extractProductCode(name) {
    if (!name) return "";
    const arr = name.trim().split(" ");
    return arr.length > 1 ? arr[1] : "";
  }

  // ì˜µì…˜ ë¬¸ìì—´ â†’ ë°°ì—´
  function parseOptions(str) {
    if (!str || typeof str !== 'string') return [];
    return str
      .split(/[,ï¼ŒÂ·ï½¤\/ï¼]/g)    
      .map(s => s.trim())
      .filter(Boolean);
  }
  // (1) ìƒí’ˆëª…ì—ì„œ "ë¸Œëœë“œ ìƒí’ˆì½”ë“œ ë¶„ë¥˜"ë§Œ ì¶”ì¶œ
  function extractManageCodes(name) {
    if (!name) return [];
    const m = name.match(/^(\S+)\s+(.+)$/); // ë¸Œëœë“œ, ë‚˜ë¨¸ì§€
    if (!m) return [];
    const brand = m[1];
    const rest = m[2].trim();
    const parts = rest.split(' ');
    // parts ì˜ˆ: ['TS-S2401', 'TS-2402', 'í‹°ì…”ì¸ ']
    let ë¶„ë¥˜ = parts[parts.length - 1]; // í•­ìƒ ë§¨ ë’¤ê°€ ë¶„ë¥˜
    // ë¶„ë¥˜ì— 'í‹°ì…”ì¸ ' ë“± í•œê¸€ í¬í•¨ë  ìˆ˜ ìˆìŒ
    let codes = [];
    for (let i = 0; i < parts.length - 1; i++) {
      codes.push(`${brand} ${parts[i]} ${ë¶„ë¥˜}`);
    }
    // ë§Œì•½ ìƒí’ˆì½”ë“œê°€ í•˜ë‚˜ë¼ë©´
    if (codes.length === 0) codes.push(`${brand} ${parts[0]} ${ë¶„ë¥˜}`);
    return codes;
  }

  // (2) ê´€ë¦¬ì½”ë“œ 20ì ì œí•œ (ë„ì›Œì“°ê¸° ì œê±° í›„)
  function limitManageCodeLength(str) {
    let out = str.replace(/\s+/g, "");
    if (out.length > 20) out = out.slice(0, 20);
    return out;
  }
  // ë‹¨ì¢… ê´€ë¦¬ì½”ë“œ ìƒì„±: "ë‹¨ì¢… {ìƒí’ˆëª…}"
  function getDiscontinuedManageCodeByName(productName) {
    const code = `ë‹¨ì¢… ${productName || ""}`.trim();
    // ë„¤ì´ë²„ 20ì ì œí•œ(ê³µë°± ì œê±° ê¸°ì¤€)ì„ ê°™ì´ ì§€í‚¤ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ 3ì¤„ ìœ ì§€
    if (code.replace(/\s/g,'').length > 20) {
      return code.replace(/\s/g,'').slice(0, 20);
    }
    return code;
  }

  // 
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  // [ë²„ê·¸ ìˆ˜ì •] ì¤‘ë³µ ì„ ì–¸ë˜ì—ˆë˜ í•¨ìˆ˜ 1 (ì´ê²ƒ í•˜ë‚˜ë§Œ ë‚¨ê¹€)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  //
  function downloadRepresentative() {
    const rows = getDataFromTable().filter(r => !r.ì œì™¸);
    if (!rows.length) {
      alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const hideBrand        = document.getElementById("hideBrand").checked;
    const discountRate     = parseFloat(document.getElementById("discountRate").value) || 0;
    const mode             = getOptionDisplayMode(); // both/colorOnly/sizeOnly/nameOnly
    const useAllFirstName  = document.getElementById('allFirstName')?.checked;
    const appendCode       = document.getElementById('appendCodeToSize')?.checked;
    const splitProductCode = document.getElementById('splitProductCode')?.checked;
    const freeShipping     = document.getElementById('freeShippingOption')?.checked;

    // ë¬´ë£Œë°°ì†¡ ë¡œì§ì„ ìœ„í•œ ë³€ìˆ˜ ì„ ì–¸
    const freeShippingAmount = parseFloat(document.getElementById('freeShippingAmount')?.value) || 0;
    const freeShippingType = document.getElementById('freeShippingType')?.value || 'won';

    const master      = rows.find(r => r.ëŒ€í‘œ) || rows[0];
    const masterPrice = calculateOriginalPrice(master.íŒë§¤ê°€, discountRate);

    const ordered = [ master, ...rows.filter(r => r !== master) ];
    const data = [];
    let groupIndex = 0;

    ordered.forEach(item => {
      const diff     = item.íŒë§¤ê°€ - master.íŒë§¤ê°€;
      const colors   = parseOptions(item.ìƒ‰ìƒ).length ? parseOptions(item.ìƒ‰ìƒ) : [""];
      const sizes    = expandSizes(item.ì‚¬ì´ì¦ˆ).length ? expandSizes(item.ì‚¬ì´ì¦ˆ) : [""];
      const itemInfo = parseBrandProductType(item.ìƒí’ˆëª…);

      // ìƒ‰ìƒìˆ˜ì™€ ê´€ë¦¬ì½”ë“œìˆ˜ 1:1 ë§¤ì¹­
      const manageCodes = itemInfo.manageCodes || [];
      const colorCount  = colors.length;
      const codeList    = [];
      for (let i = 0; i < colorCount; i++) {
        codeList.push(manageCodes[i] || manageCodes[manageCodes.length - 1] || item.ìƒí’ˆëª…);
      }

      // âœ… ì¤‘ë³µ ë¸Œëœë“œ ë°©ì§€ëœ baseName
      const isMaster = (item === master);
      const baseName = buildBaseName(item, itemInfo, !!useAllFirstName, isMaster);
    
      // ë¬´ë£Œë°°ì†¡ ê¸ˆì•¡ ê³„ì‚° ë¡œì§
      let optionPrice;
      if (freeShipping && !isMaster) {
        if (freeShippingType === 'percent') {
          optionPrice = diff + (master.íŒë§¤ê°€ * (freeShippingAmount / 100));
        } else { // 'won'
          optionPrice = diff + freeShippingAmount;
        }
      } else {
        optionPrice = diff;
      }

      // --- ê·œì • ì²´í¬ (ìµœì¢… ì˜µì…˜ê°€ ê¸°ì¤€) ---
      let isValidGroup;
      if (mode === "nameOnly") {
        isValidGroup = isValidOptionPrice(masterPrice, optionPrice);
      } else {
        isValidGroup = colors.some(col => sizes.some(sz => isValidOptionPrice(masterPrice, optionPrice)));
      }
      if (!isValidGroup) return;

      groupIndex++;
      const seq = String(groupIndex).padStart(2, "0");

      if (mode === "both") {
        colors.forEach((col, colIdx) => {
          sizes.forEach(sz => {
            let szCode = sz;
            if (appendCode && itemInfo.codes && itemInfo.codes.length) {
              szCode += " / " + (itemInfo.codes[colIdx] || itemInfo.codes[itemInfo.codes.length - 1] || "");
            }

            const soldoutArr = (item.í’ˆì ˆëœì¡°í•© || '').split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);
            let manageCode;
            if (soldoutArr.includes("ë‹¨ì¢…")) {
              manageCode = getDiscontinuedManageCodeByName(item.ìƒí’ˆëª…);
            } else if (splitProductCode) {
              manageCode = codeList[colIdx];
              if (manageCode.replace(/\s/g, '').length > 20) {
                manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
              }
            } else {
              manageCode = item.ìƒí’ˆëª…;
            }

            let í’ˆì ˆ = false;
            if (item.í’ˆì ˆëœì¡°í•©) {
              const s = soldoutArr;
              í’ˆì ˆ = s.includes("ë‹¨ì¢…") || s.includes("í’ˆì ˆ") || s.includes(col) || s.includes(sz) || s.includes(`${col}-${sz}`);
            }

            data.push({
              ì œí’ˆì„ íƒ: `${seq}) ${baseName}${col ? ` / ${col}` : ""}`,
              ì‚¬ì´ì¦ˆ:   szCode,
              ì˜µì…˜ê°€:    optionPrice,
              ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
              ê´€ë¦¬ì½”ë“œ:  manageCode,
              ì‚¬ìš©ì—¬ë¶€:  "Y"
            });
          });
        });
      } else if (mode === "colorOnly") {
        colors.forEach((col, colIdx) => {
          const soldoutArr = (item.í’ˆì ˆëœì¡°í•© || '').split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);
          let manageCode;
          if (soldoutArr.includes("ë‹¨ì¢…")) {
            manageCode = getDiscontinuedManageCodeByName(item.ìƒí’ˆëª…);
          } else if (splitProductCode) {
            manageCode = codeList[colIdx];
            if (manageCode.replace(/\s/g, '').length > 20) {
              manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
            }
          } else {
            manageCode = item.ìƒí’ˆëª…;
          }
          let í’ˆì ˆ = false;
          if (item.í’ˆì ˆëœì¡°í•©) {
            const s = soldoutArr;
            í’ˆì ˆ = s.includes("ë‹¨ì¢…") || s.includes("í’ˆì ˆ") || s.includes(col);
          }

          data.push({
            ì œí’ˆì„ íƒ: `${seq}) ${baseName}`,
            ìƒ‰ìƒ:     col,
            ì˜µì…˜ê°€:    optionPrice,
            ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
            ê´€ë¦¬ì½”ë“œ:  manageCode,
            ì‚¬ìš©ì—¬ë¶€:  "Y"
          });
        });
      } else if (mode === "sizeOnly") {
        sizes.forEach(sz => {
          let szCode = sz;
          if (appendCode && itemInfo.codes && itemInfo.codes.length) {
            szCode += " / " + (itemInfo.codes[0] || "");
          }

          const soldoutArr = (item.í’ˆì ˆëœì¡°í•© || '').split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);
          let manageCode;
          if (soldoutArr.includes("ë‹¨ì¢…")) {
            manageCode = getDiscontinuedManageCodeByName(item.ìƒí’ˆëª…);
          } else if (splitProductCode) {
            manageCode = codeList[0];
            if (manageCode.replace(/\s/g, '').length > 20) {
              manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
            }
          } else {
            manageCode = item.ìƒí’ˆëª…;
          }
          let í’ˆì ˆ = false;
          if (item.í’ˆì ˆëœì¡°í•©) {
            const s = soldoutArr;
            í’ˆì ˆ = s.includes("ë‹¨ì¢…") || s.includes("í’ˆì ˆ") || s.includes(sz);
          }

          data.push({
            ì œí’ˆì„ íƒ: `${seq}) ${baseName}`,
            ì‚¬ì´ì¦ˆ:   szCode,
            ì˜µì…˜ê°€:    optionPrice,
            ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
            ê´€ë¦¬ì½”ë“œ:  manageCode,
            ì‚¬ìš©ì—¬ë¶€:  "Y"
          });
        });
      } else if (mode === "nameOnly") {
        const soldoutArr = (item.í’ˆì ˆëœì¡°í•© || '').split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);

        let manageCode;
        if (soldoutArr.includes("ë‹¨ì¢…")) {
          manageCode = getDiscontinuedManageCodeByName(item.ìƒí’ˆëª…);
        } else if (splitProductCode) {
          const mCodes = parseBrandProductType(item.ìƒí’ˆëª…).manageCodes || [];
          manageCode = mCodes[0] || item.ìƒí’ˆëª…;
          if (manageCode.replace(/\s/g, '').length > 20) {
            manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
          }
        } else {
          manageCode = item.ìƒí’ˆëª…;
        }

        const soldout = soldoutArr.includes("ë‹¨ì¢…") || soldoutArr.includes("í’ˆì ˆ");

        data.push({
          ì œí’ˆì„ íƒ: `${seq}) ${baseName}`,
          ì˜µì…˜ê°€:    optionPrice,
          ì¬ê³ ìˆ˜ëŸ‰:  soldout ? 0 : 99999,
          ê´€ë¦¬ì½”ë“œ:  manageCode,
          ì‚¬ìš©ì—¬ë¶€:  "Y"
        });
      }
    });

    // --- ë¸Œëœë“œ ìˆ¨ê¸°ê¸° & 25ì ë³´ì • ---
    data.forEach(item => {
      if (hideBrand) {
        item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/^(\d+\)\s*)\S+\s/, "$1");
      }
      if (item.ì œí’ˆì„ íƒ.length > 25) item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/ \/ /g, "/");
      if (item.ì œí’ˆì„ íƒ.length > 25) item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/^(\d+\))\s/, "$1");
    });

    // íŒŒì¼ëª… (-ë¬´ë°°)
    let safeName = (master.ìƒí’ˆëª… || "ì˜µì…˜ë°ì´í„°").replace(/[\\\/:*?"<>|]/g, "").trim();
    if (freeShipping) safeName += "-ë¬´ë°°";

    // í—¤ë” êµ¬ì„±
    const header = ["ì œí’ˆì„ íƒ"];
    if (mode === "both" || mode === "sizeOnly") header.push("ì‚¬ì´ì¦ˆ");
    if (mode === "colorOnly") header.push("ìƒ‰ìƒ");
    header.push("ì˜µì…˜ê°€","ì¬ê³ ìˆ˜ëŸ‰","ê´€ë¦¬ì½”ë“œ","ì‚¬ìš©ì—¬ë¶€");

    const ws = XLSX.utils.json_to_sheet(data, { header });
    autoWidth(ws, data, header);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ì˜µì…˜ë°ì´í„°");
    const wbout = XLSX.write(wb, { bookType: "xls", type: "array" });
    saveAs(new Blob([wbout], { type: "application/octet-stream" }), `${safeName}.xls`);
  }

  // 
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  // [ë²„ê·¸ ìˆ˜ì •] ì¤‘ë³µ ì„ ì–¸ë˜ì—ˆë˜ í•¨ìˆ˜ 2 (ì´ê²ƒ í•˜ë‚˜ë§Œ ë‚¨ê¹€)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
  //
  function generateZip() {
    const rows = getDataFromTable().filter(r => !r.ì œì™¸);
    if (!rows.length) {
      alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const hideBrand        = document.getElementById("hideBrand").checked;
    const discountRate     = parseFloat(document.getElementById("discountRate").value) || 0;
    const mode             = getOptionDisplayMode(); // both/colorOnly/sizeOnly/nameOnly
    const zip              = new JSZip();
    const useAllFirstName  = document.getElementById('allFirstName')?.checked;
    const appendCode       = document.getElementById('appendCodeToSize')?.checked;
    const splitProductCode = document.getElementById('splitProductCode')?.checked;
    const freeShipping     = document.getElementById('freeShippingOption')?.checked;

    // ë¬´ë£Œë°°ì†¡ ë¡œì§ì„ ìœ„í•œ ë³€ìˆ˜ ì„ ì–¸
    const freeShippingAmount = parseFloat(document.getElementById('freeShippingAmount')?.value) || 0;
    const freeShippingType = document.getElementById('freeShippingType')?.value || 'won';

    rows.forEach(repr => {
      const reprInfo    = parseBrandProductType(repr.ìƒí’ˆëª…);
      const masterPrice = calculateOriginalPrice(repr.íŒë§¤ê°€, discountRate);

      const ordered = [ repr, ...rows.filter(r => r !== repr) ];
      const data = [];
      let groupIndex = 0;

      ordered.forEach(item => {
        const diff     = item.íŒë§¤ê°€ - repr.íŒë§¤ê°€;
        const colors   = parseOptions(item.ìƒ‰ìƒ).length ? parseOptions(item.ìƒ‰ìƒ) : [""];
        const sizes    = expandSizes(item.ì‚¬ì´ì¦ˆ).length ? expandSizes(item.ì‚¬ì´ì¦ˆ) : [""];
        const itemInfo = parseBrandProductType(item.ìƒí’ˆëª…);

        // ìƒ‰ìƒìˆ˜ì™€ ê´€ë¦¬ì½”ë“œìˆ˜ 1:1 ë§¤ì¹­
        const manageCodes = itemInfo.manageCodes || [];
        const colorCount  = colors.length;
        const codeList    = [];
        for (let i = 0; i < colorCount; i++) {
          codeList.push(manageCodes[i] || manageCodes[manageCodes.length - 1] || item.ìƒí’ˆëª…);
        }

        // âœ… ì¤‘ë³µ ë¸Œëœë“œ ë°©ì§€ëœ baseName
        const isMaster = (item === repr);
        const baseName = buildBaseName(item, itemInfo, !!useAllFirstName, isMaster);

        // ë¬´ë£Œë°°ì†¡ ê¸ˆì•¡ ê³„ì‚° ë¡œì§
        let optionPrice;
        if (freeShipping && !isMaster) {
          if (freeShippingType === 'percent') {
            optionPrice = diff + (repr.íŒë§¤ê°€ * (freeShippingAmount / 100));
          } else { // 'won'
            optionPrice = diff + freeShippingAmount;
          }
        } else {
          optionPrice = diff;
        }

        // --- ê·œì • ì²´í¬ ---
        let isValidGroup;
        if (mode === "nameOnly") {
          isValidGroup = isValidOptionPrice(masterPrice, optionPrice);
        } else {
          isValidGroup = colors.some(col => sizes.some(sz => isValidOptionPrice(masterPrice, optionPrice)));
        }
        if (!isValidGroup) return;

        groupIndex++;
        const seq = String(groupIndex).padStart(2, "0");

        if (mode === "both") {
          colors.forEach((col, colIdx) => {
            sizes.forEach(sz => {
              let szCode = sz;
              if (appendCode && itemInfo.codes && itemInfo.codes.length) {
                szCode += " / " + (itemInfo.codes[colIdx] || itemInfo.codes[itemInfo.codes.length-1] || "");
              }

              const soldoutArr = (item.í’ˆì ˆëœì¡°í•© || '').split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);
              let manageCode;
              if (soldoutArr.includes("ë‹¨ì¢…")) {
                manageCode = getDiscontinuedManageCodeByName(item.ìƒí’ˆëª…);
              } else if (splitProductCode) {
                manageCode = codeList[colIdx];
                if (manageCode.replace(/\s/g, '').length > 20) {
                  manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
                }
              } else {
                manageCode = item.ìƒí’ˆëª…;
              }

              let í’ˆì ˆ = false;
              if (item.í’ˆì ˆëœì¡°í•©) {
                const s = soldoutArr;
                í’ˆì ˆ = s.includes("ë‹¨ì¢…") || s.includes("í’ˆì ˆ") || s.includes(col) || s.includes(sz) || s.includes(`${col}-${sz}`);
              }

              data.push({
                ì œí’ˆì„ íƒ: `${seq}) ${baseName}${col ? ` / ${col}` : ""}`,
                ì‚¬ì´ì¦ˆ:   szCode,
                ì˜µì…˜ê°€:    optionPrice,
                ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
                ê´€ë¦¬ì½”ë“œ:  manageCode,
                ì‚¬ìš©ì—¬ë¶€:  "Y"
              });
            });
          });
        } else if (mode === "colorOnly") {
          colors.forEach((col, colIdx) => {
            const soldoutArr = (item.í’ˆì ˆëœì¡°í•© || '').split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);
            let manageCode;
            if (soldoutArr.includes("ë‹¨ì¢…")) {
              manageCode = getDiscontinuedManageCodeByName(item.ìƒí’ˆëª…);
            } else if (splitProductCode) {
              manageCode = codeList[colIdx];
              if (manageCode.replace(/\s/g, '').length > 20) {
                manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
              }
            } else {
              manageCode = item.ìƒí’ˆëª…;
            }

            let í’ˆì ˆ = false;
            if (item.í’ˆì ˆëœì¡°í•©) {
              const s = soldoutArr;
              í’ˆì ˆ = s.includes("ë‹¨ì¢…") || s.includes("í’ˆì ˆ") || s.includes(col);
            }

            data.push({
              ì œí’ˆì„ íƒ: `${seq}) ${baseName}`,
              ìƒ‰ìƒ:     col,
              ì˜µì…˜ê°€:    optionPrice,
              ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
              ê´€ë¦¬ì½”ë“œ:  manageCode,
              ì‚¬ìš©ì—¬ë¶€:  "Y"
            });
          });
        } else if (mode === "sizeOnly") {
          sizes.forEach(sz => {
            let szCode = sz;
            if (appendCode && itemInfo.codes && itemInfo.codes.length) {
              szCode += " / " + (itemInfo.codes[0] || "");
            }

            const soldoutArr = (item.í’ˆì ˆëœì¡°í•© || '').split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);
            let manageCode;
            if (soldoutArr.includes("ë‹¨ì¢…")) {
              manageCode = getDiscontinuedManageCodeByName(item.ìƒí’ˆëª…);
            } else if (splitProductCode) {
              manageCode = codeList[0];
              if (manageCode.replace(/\s/g, '').length > 20) {
                manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
              }
            } else {
              manageCode = item.ìƒí’ˆëª…;
            }
            let í’ˆì ˆ = false;
            if (item.í’ˆì ˆëœì¡°í•©) {
              const s = soldoutArr;
              í’ˆì ˆ = s.includes("ë‹¨ì¢…") || s.includes("í’ˆì ˆ") || s.includes(sz);
            }

            data.push({
              ì œí’ˆì„ íƒ: `${seq}) ${baseName}`,
              ì‚¬ì´ì¦ˆ:   szCode,
              ì˜µì…˜ê°€:    optionPrice,
              ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
              ê´€ë¦¬ì½”ë“œ:  manageCode,
              ì‚¬ìš©ì—¬ë¶€:  "Y"
            });
          });
        } else if (mode === "nameOnly") {
          const soldoutArr = (item.í’ˆì ˆëœì¡°í•© || '').split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);

          let manageCode;
          if (soldoutArr.includes("ë‹¨ì¢…")) {
            manageCode = getDiscontinuedManageCodeByName(item.ìƒí’ˆëª…);
          } else if (splitProductCode) {
            const mCodes = parseBrandProductType(item.ìƒí’ˆëª…).manageCodes || [];
            manageCode = mCodes[0] || item.ìƒí’ˆëª…;
            if (manageCode.replace(/\s/g, '').length > 20) {
              manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
            }
          } else {
            manageCode = item.ìƒí’ˆëª…;
          }

          const soldout = soldoutArr.includes("ë‹¨ì¢…") || soldoutArr.includes("í’ˆì ˆ");

          data.push({
            ì œí’ˆì„ íƒ: `${seq}) ${baseName}`,
            ì˜µì…˜ê°€:    optionPrice,
            ì¬ê³ ìˆ˜ëŸ‰:  soldout ? 0 : 99999,
            ê´€ë¦¬ì½”ë“œ:  manageCode,
            ì‚¬ìš©ì—¬ë¶€:  "Y"
          });
        }
      });

      // --- ë¸Œëœë“œ ìˆ¨ê¸°ê¸° & 25ì ë³´ì • ---
      data.forEach(item => {
        if (hideBrand) {
          item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/^(\d+\)\s*)\S+\s/, "$1");
        }
        if (item.ì œí’ˆì„ íƒ.length > 25) item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/ \/ /g, "/");
        if (item.ì œí’ˆì„ íƒ.length > 25) item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/^(\d+\))\s/, "$1");
      });

      // íŒŒì¼ëª… (-ë¬´ë°°)
      let safeName = (repr.ìƒí’ˆëª… || "ì˜µì…˜ë°ì´í„°").replace(/[\\\/:*?"<>|]/g, "").trim();
      if (freeShipping) safeName += "-ë¬´ë°°";

      // í—¤ë”
      const header = ["ì œí’ˆì„ íƒ"];
      if (mode === "both" || mode === "sizeOnly") header.push("ì‚¬ì´ì¦ˆ");
      if (mode === "colorOnly") header.push("ìƒ‰ìƒ");
      header.push("ì˜µì…˜ê°€", "ì¬ê³ ìˆ˜ëŸ‰", "ê´€ë¦¬ì½”ë“œ", "ì‚¬ìš©ì—¬ë¶€");

      const ws = XLSX.utils.json_to_sheet(data, { header });
      autoWidth(ws, data, header);
      const wb   = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ì˜µì…˜ë°ì´í„°");
      const blob = XLSX.write(wb, { bookType: "xls", type: "array" });

      zip.file(`${safeName}.xls`, blob);
    });

    zip.generateAsync({ type: "blob" })
      .then(content => saveAs(content, "ì˜µì…˜_ì¼ê´„ë‹¤ìš´ë¡œë“œ.zip"));
  }

  //
  // (ì°¸ê³ ) ì¤‘ë³µ ì„ ì–¸ë˜ì—ˆë˜ 2ê°œì˜ í•¨ìˆ˜ëŠ” ìœ„ì—ì„œ ìˆ˜ì •ë˜ì–´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
  //

  // ì¶”ê°€ìƒí’ˆ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ëª¨ë“  ì œì™¸ë˜ì§€ ì•Šì€ ìƒí’ˆ í¬í•¨)
  function downloadAddProductExcel() {
    const mode = getOptionDisplayMode();
    const rows = getDataFromTable().filter(r => !r.ì œì™¸);
    if (!rows.length) {
      return alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    }

    // 1) ëŒ€í‘œ ìƒí’ˆ ì•ìœ¼ë¡œ
    const ëŒ€í‘œ = rows.find(r => r.ëŒ€í‘œ) || rows[0];
    const items = [ëŒ€í‘œ, ...rows.filter(r => r !== ëŒ€í‘œ)];

    // 2) ë°ì´í„° ë°°ì—´ ì±„ìš°ê¸°
    let data = [];
    items.forEach((item, idx) => {
      const seq    = String(idx+1).padStart(2, "0");
      const colors = parseOptions(item.ìƒ‰ìƒ);
      const sizes  = expandSizes(item.ì‚¬ì´ì¦ˆ);
      const cols   = colors.length ? colors : [""];
      const szs    = sizes.length  ? sizes  : [""];

      cols.forEach(col => {
        szs.forEach(sz => {
          const opt = applyOptionMode(item.ìƒí’ˆëª…, col, sz, seq);
          // ê´€ë¦¬ì½”ë“œ ë‹¨ì¢… ì²˜ë¦¬
          const soldoutArr = (item.í’ˆì ˆëœì¡°í•© || '').split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);
          let manageCode;
          if (soldoutArr.includes("ë‹¨ì¢…")) {
            manageCode = getDiscontinuedManageCodeByName(item.ìƒí’ˆëª…);
          } else {
            manageCode = item.ìƒí’ˆëª…;
          }
          data.push({
            ì¶”ê°€ìƒí’ˆëª…: "ì œí’ˆì„ íƒ",
            ì¶”ê°€ìƒí’ˆê°’: opt.ì œí’ˆì„ íƒ,
            ì¶”ê°€ìƒí’ˆê°€: item.íŒë§¤ê°€,
            ì¬ê³ ìˆ˜ëŸ‰: 99999,
            ì‚¬ìš©ì—¬ë¶€: "Y",
            ê´€ë¦¬ì½”ë“œ: manageCode
          });
        });
      });
    });

    // 3) ì¤‘ë³µ ì œê±°
    data = data.filter((row,i) =>
      data.findIndex(r => r.ì¶”ê°€ìƒí’ˆê°’ === row.ì¶”ê°€ìƒí’ˆê°’) === i
    );

    // 4) ì•ˆì „í•œ íŒŒì¼ëª…
    const safeName = ëŒ€í‘œ.ìƒí’ˆëª….replace(/[\\\/:*?"<>|]/g, "").trim();

    // 5) ì›Œí¬ë¶ ìƒì„± & ë‹¤ìš´ë¡œë“œ
    const header = [
      "ì¶”ê°€ìƒí’ˆëª…","ì¶”ê°€ìƒí’ˆê°’","ì¶”ê°€ìƒí’ˆê°€","ì¬ê³ ìˆ˜ëŸ‰","ì‚¬ìš©ì—¬ë¶€","ê´€ë¦¬ì½”ë“œ"
    ];
    const ws    = XLSX.utils.json_to_sheet(data, { header });
    autoWidth(ws, data, header);
    const wb    = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ì¶”ê°€ìƒí’ˆ");
    const wbout = XLSX.write(wb, { bookType: "xls", type: "array" });
    saveAs(new Blob([wbout], { type: "application/octet-stream" }),
          `ì¶”ê°€ìƒí’ˆ_${safeName}.xls`);
  }

  // ë‹¨í’ˆë“±ë¡ìš© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ - ëŒ€í‘œìƒí’ˆë§Œ ìˆœë²ˆ ì—†ì´ ì¶œë ¥
  // nameOnly ëª¨ë“œ: ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ ì—†ì´ ì œí’ˆëª…ë§Œ 1í–‰ ìƒì„±
  function downloadSingleProductExcel() {
    const rows = getDataFromTable().filter(r => !r.ì œì™¸);
    const ëŒ€í‘œ = rows.find(r => r.ëŒ€í‘œ) || rows[0];
    if (!ëŒ€í‘œ) return alert("ëŒ€í‘œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");

    const splitProductCode = document.getElementById('splitProductCode')?.checked;
    const mode = getOptionDisplayMode(); // both / colorOnly / sizeOnly / nameOnly

    // ì˜µì…˜ ê°’ë“¤ íŠ¸ë¦¼
    const ìƒ‰ìƒëª©ë¡   = parseOptions(ëŒ€í‘œ.ìƒ‰ìƒ).map(s => s.trim());
    const ì‚¬ì´ì¦ˆëª©ë¡ = expandSizes(ëŒ€í‘œ.ì‚¬ì´ì¦ˆ).map(s => s.trim());
    const í’ˆì ˆì¡°í•©   = parseOptions(ëŒ€í‘œ.í’ˆì ˆëœì¡°í•©).map(s => s.trim());
    const ìƒí’ˆëª…     = ëŒ€í‘œ["1ë²ˆ ìƒí’ˆëª…"] || ëŒ€í‘œ.ìƒí’ˆëª…;

    // ê´€ë¦¬ì½”ë“œ í›„ë³´(ìƒ‰ìƒ ìˆ˜ ê¸°ì¤€)
    const itemInfo    = parseBrandProductType(ëŒ€í‘œ.ìƒí’ˆëª…);
    const manageCodes = itemInfo.manageCodes || [];
    const codeList    = [];
    for (let i = 0; i < (ìƒ‰ìƒëª©ë¡.length || 1); i++) {
      codeList.push(manageCodes[i] || manageCodes[manageCodes.length - 1] || ëŒ€í‘œ.ìƒí’ˆëª…);
    }

    const data = [];

    if (mode === "nameOnly") {
      // ê·¸ë£¹ 1í–‰
      const soldout = í’ˆì ˆì¡°í•©.includes("ë‹¨ì¢…") || í’ˆì ˆì¡°í•©.includes("í’ˆì ˆ");
      let manageCode = splitProductCode ? (codeList[0] || ëŒ€í‘œ.ìƒí’ˆëª…) : ëŒ€í‘œ.ìƒí’ˆëª…;
      if (manageCode.replace(/\s/g,'').length > 20) {
        manageCode = manageCode.replace(/\s/g,'').slice(0,20);
      }
      data.push({
        ì œí’ˆì„ íƒ: ìƒí’ˆëª…,
        ì˜µì…˜ê°€: 0,
        ì¬ê³ ìˆ˜ëŸ‰: soldout ? 0 : 99999,
        ê´€ë¦¬ì½”ë“œ: manageCode,
        ì‚¬ìš©ì—¬ë¶€: "Y"
      });
    } else {
      const ìƒ‰ìƒë°°ì—´   = ìƒ‰ìƒëª©ë¡.length > 0 ? ìƒ‰ìƒëª©ë¡ : [""];
      const ì‚¬ì´ì¦ˆë°°ì—´ = ì‚¬ì´ì¦ˆëª©ë¡.length > 0 ? ì‚¬ì´ì¦ˆëª©ë¡ : [""];

      ìƒ‰ìƒë°°ì—´.forEach((color, idx) => {
        let manageCode = splitProductCode ? (codeList[idx] || ëŒ€í‘œ.ìƒí’ˆëª…) : ëŒ€í‘œ.ìƒí’ˆëª…;
        if (manageCode.replace(/\s/g,'').length > 20) {
          manageCode = manageCode.replace(/\s/g,'').slice(0,20);
        }

        if (ì‚¬ì´ì¦ˆëª©ë¡.length === 0) {
          const soldout = í’ˆì ˆì¡°í•©.includes(color) || í’ˆì ˆì¡°í•©.includes("ë‹¨ì¢…") || í’ˆì ˆì¡°í•©.includes("í’ˆì ˆ");
          const row = {
            ì œí’ˆì„ íƒ: (mode === "both" && color) ? `${ìƒí’ˆëª…} / ${color}` : ìƒí’ˆëª…,
            ì˜µì…˜ê°€: 0,
            ì¬ê³ ìˆ˜ëŸ‰: soldout ? 0 : 99999,
            ê´€ë¦¬ì½”ë“œ: manageCode,
            ì‚¬ìš©ì—¬ë¶€: "Y"
          };
          if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
          if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = ëŒ€í‘œ.ì‚¬ì´ì¦ˆ;
          data.push(row);
        } else {
          ì‚¬ì´ì¦ˆë°°ì—´.forEach(size => {
            const soldout =
              í’ˆì ˆì¡°í•©.includes(color) ||
              í’ˆì ˆì¡°í•©.includes(size) ||
              í’ˆì ˆì¡°í•©.includes(`${color}-${size}`) ||
              í’ˆì ˆì¡°í•©.includes("ë‹¨ì¢…") || í’ˆì ˆì¡°í•©.includes("í’ˆì ˆ");

            const row = {
              ì œí’ˆì„ íƒ: (mode === "both" && color) ? `${ìƒí’ˆëª…} / ${color}` : ìƒí’ˆëª…,
              ì˜µì…˜ê°€: 0,
              ì¬ê³ ìˆ˜ëŸ‰: soldout ? 0 : 99999,
              ê´€ë¦¬ì½”ë“œ: manageCode,
              ì‚¬ìš©ì—¬ë¶€: "Y"
            };
            if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
            if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = size;
            data.push(row);
          });
        }
      });
    }

    // í—¤ë”
    const header = ["ì œí’ˆì„ íƒ"];
    if (mode === "colorOnly") header.push("ìƒ‰ìƒ");
    if (mode === "sizeOnly" || mode === "both") header.push("ì‚¬ì´ì¦ˆ");
    header.push("ì˜µì…˜ê°€", "ì¬ê³ ìˆ˜ëŸ‰", "ê´€ë¦¬ì½”ë“œ", "ì‚¬ìš©ì—¬ë¶€");

    const rowsArray = data.map(row => {
      const line = [row.ì œí’ˆì„ íƒ];
      if (mode === "colorOnly") line.push(row.ìƒ‰ìƒ);
      if (mode === "sizeOnly" || mode === "both") line.push(row.ì‚¬ì´ì¦ˆ);
      line.push(row.ì˜µì…˜ê°€, row.ì¬ê³ ìˆ˜ëŸ‰, row.ê´€ë¦¬ì½”ë“œ, row.ì‚¬ìš©ì—¬ë¶€);
      return line;
    });

    const aoa = [header, ...rowsArray];
    const ws  = XLSX.utils.aoa_to_sheet(aoa);
    autoWidthAoA(ws, aoa);

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ë‹¨í’ˆì˜µì…˜");

    const safeFileName = (ëŒ€í‘œ.ìƒí’ˆëª… || "ë‹¨í’ˆë“±ë¡").replace(/[\/:*?"<>|]/g, "").trim();
    const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
    saveAs(new Blob([wbout], { type: "application/octet-stream" }), `ë‹¨í’ˆë“±ë¡_${safeFileName}.xls`);
  }



  // â€œë‹¨í’ˆ ì „ì²´ ZIPâ€ (ìƒí’ˆëª… ê·¸ë£¹ë³„ë¡œ ëŒ€í‘œë§Œ ë‹¨í’ˆ ì—‘ì…€ ìƒì„±)
  // nameOnly ëª¨ë“œ: ê·¸ë£¹ë‹¹ 1í–‰(ì œí’ˆì„ íƒë§Œ) ìƒì„±
  function downloadSingleProductExcelAll() {
    const rows = getDataFromTable().filter(r => !r.ì œì™¸);
    if (rows.length === 0) return alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

    const mode             = getOptionDisplayMode(); // both/colorOnly/sizeOnly/nameOnly
    const splitProductCode = document.getElementById('splitProductCode')?.checked;

    const zip = new JSZip();
    const ìƒí’ˆê·¸ë£¹ = [...new Set(rows.map(r => r.ìƒí’ˆëª…))];

    ìƒí’ˆê·¸ë£¹.forEach(ìƒí’ˆëª… => {
      const ê·¸ë£¹ = rows.filter(r => r.ìƒí’ˆëª… === ìƒí’ˆëª…);
      const ëŒ€í‘œ = ê·¸ë£¹.find(r => r.ëŒ€í‘œ) || ê·¸ë£¹[0];

      // ì˜µì…˜ ê°’ë“¤
      const ìƒ‰ìƒëª©ë¡   = parseOptions(ëŒ€í‘œ.ìƒ‰ìƒ).map(s => s.trim());
      const ì‚¬ì´ì¦ˆëª©ë¡ = expandSizes(ëŒ€í‘œ.ì‚¬ì´ì¦ˆ).map(s => s.trim());
      const í’ˆì ˆì¡°í•©   = parseOptions(ëŒ€í‘œ.í’ˆì ˆëœì¡°í•©).map(s => s.trim());
      const ëŒ€í‘œìƒí’ˆëª… = ëŒ€í‘œ["1ë²ˆ ìƒí’ˆëª…"] || ëŒ€í‘œ.ìƒí’ˆëª…;

      const itemInfo    = parseBrandProductType(ëŒ€í‘œ.ìƒí’ˆëª…);
      const manageCodes = itemInfo.manageCodes || [];
      const codeList    = [];
      for (let i = 0; i < (ìƒ‰ìƒëª©ë¡.length || 1); i++) {
        codeList.push(manageCodes[i] || manageCodes[manageCodes.length - 1] || ëŒ€í‘œ.ìƒí’ˆëª…);
      }

      const data = [];

      if (mode === "nameOnly") {
        const manageCodeBase = splitProductCode ? (codeList[0] || ëŒ€í‘œ.ìƒí’ˆëª…) : ëŒ€í‘œ.ìƒí’ˆëª…;
        const mc = (manageCodeBase.replace(/\s/g,'').length > 20)
          ? manageCodeBase.replace(/\s/g,'').slice(0,20)
          : manageCodeBase;

        const soldout = í’ˆì ˆì¡°í•©.includes("ë‹¨ì¢…") || í’ˆì ˆì¡°í•©.includes("í’ˆì ˆ");

        data.push({
          ì œí’ˆì„ íƒ: ëŒ€í‘œìƒí’ˆëª…,
          ì˜µì…˜ê°€: 0,
          ì¬ê³ ìˆ˜ëŸ‰: soldout ? 0 : 99999,
          ê´€ë¦¬ì½”ë“œ: mc,
          ì‚¬ìš©ì—¬ë¶€: "Y"
        });
      } else {
        const ìƒ‰ìƒë°°ì—´ = ìƒ‰ìƒëª©ë¡.length > 0 ? ìƒ‰ìƒëª©ë¡ : [""];
        ìƒ‰ìƒë°°ì—´.forEach((color, idx) => {
          const manageCodeBase = splitProductCode ? (codeList[idx] || ëŒ€í‘œ.ìƒí’ˆëª…) : ëŒ€í‘œ.ìƒí’ˆëª…;
          const mc = (manageCodeBase.replace(/\s/g,'').length > 20)
            ? manageCodeBase.replace(/\s/g,'').slice(0,20)
            : manageCodeBase;

          if (ì‚¬ì´ì¦ˆëª©ë¡.length === 0) {
            const soldout = í’ˆì ˆì¡°í•©.includes(color) || í’ˆì ˆì¡°í•©.includes("ë‹¨ì¢…") || í’ˆì ˆì¡°í•©.includes("í’ˆì ˆ");
            const row = {
              ì œí’ˆì„ íƒ: (mode === "both" ? `${ëŒ€í‘œìƒí’ˆëª…}${color ? ` / ${color}` : ""}` : ëŒ€í‘œìƒí’ˆëª…),
              ì˜µì…˜ê°€: 0,
              ì¬ê³ ìˆ˜ëŸ‰: soldout ? 0 : 99999,
              ê´€ë¦¬ì½”ë“œ: mc,
              ì‚¬ìš©ì—¬ë¶€: "Y"
            };
            if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
            if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = ëŒ€í‘œ.ì‚¬ì´ì¦ˆ;
            data.push(row);
        } else {
          ì‚¬ì´ì¦ˆë°°ì—´.forEach(size => {
            const soldout =
              í’ˆì ˆì¡°í•©.includes(color) ||
              í’ˆì ˆì¡°í•©.includes(size) ||
              í’ˆì ˆì¡°í•©.includes(`${color}-${size}`) ||
              í’ˆì ˆì¡°í•©.includes("ë‹¨ì¢…") || í’ˆì ˆì¡°í•©.includes("í’ˆì ˆ");

            const row = {
              ì œí’ˆì„ íƒ: (mode === "both" ? `${ëŒ€í‘œìƒí’ˆëª…}${color ? ` / ${color}` : ""}` : ëŒ€í‘œìƒí’ˆëª…),
              ì˜µì…˜ê°€: 0,
              ì¬ê³ ìˆ˜ëŸ‰: soldout ? 0 : 99999,
              ê´€ë¦¬ì½”ë“œ: mc,
              ì‚¬ìš©ì—¬ë¶€: "Y"
            };
            if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
            if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = size;
            data.push(row);
          });
        }
      });
      }

      // í—¤ë”
      const header = ["ì œí’ˆì„ íƒ"];
      if (mode === "colorOnly") header.push("ìƒ‰ìƒ");
      if (mode === "sizeOnly" || mode === "both") header.push("ì‚¬ì´ì¦ˆ");
      header.push("ì˜µì…˜ê°€", "ì¬ê³ ìˆ˜ëŸ‰", "ê´€ë¦¬ì½”ë“œ", "ì‚¬ìš©ì—¬ë¶€");

      const rowsArray = data.map(row => {
        const line = [row.ì œí’ˆì„ íƒ];
        if (mode === "colorOnly") line.push(row.ìƒ‰ìƒ);
        if (mode === "sizeOnly" || mode === "both") line.push(row.ì‚¬ì´ì¦ˆ);
        line.push(row.ì˜µì…˜ê°€, row.ì¬ê³ ìˆ˜ëŸ‰, row.ê´€ë¦¬ì½”ë“œ, row.ì‚¬ìš©ì—¬ë¶€);
        return line;
      });

      const aoa = [header, ...rowsArray];
      const ws  = XLSX.utils.aoa_to_sheet(aoa);
      autoWidthAoA(ws, aoa);
      const wb  = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ë‹¨í’ˆì˜µì…˜");
      const safeFileName = (ëŒ€í‘œ.ìƒí’ˆëª… || "ë‹¨í’ˆë“±ë¡").replace(/[\/:*?"<>|]/g, "").trim();
      const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
      zip.file(`ë‹¨í’ˆë“±ë¡_${safeFileName}.xls`, wbout);
    });

    zip.generateAsync({ type: "blob" }).then(content => {
      saveAs(content, "ë‹¨í’ˆë“±ë¡_ì „ì²´ë‹¤ìš´ë¡œë“œ.zip");
    });
  }



  // ì˜µì…˜ ë…¸ì¶œ ë°©ì‹ í™•ì¸ í•¨ìˆ˜
  function getOptionDisplayMode() {
    const selected = document.querySelector('input[name="optionDisplay"]:checked');
    return selected ? selected.value : "both";
  }  


  // (1) ì˜µì…˜ êµ¬ì„± ë°©ì‹ ì ìš© í•¨ìˆ˜
  function applyOptionMode(ì œí’ˆëª…, ìƒ‰ìƒ, ì‚¬ì´ì¦ˆ, ìˆœë²ˆ) {
    const prefix = ìˆœë²ˆ ? `${ìˆœë²ˆ}) ` : "";
    let í…ìŠ¤íŠ¸ = `${prefix}${ì œí’ˆëª…}`;
    const mode = getOptionDisplayMode();

    if (mode === "nameOnly") {
      return { ì œí’ˆì„ íƒ: `${prefix}${ì œí’ˆëª…}` }; // â† ì¶”ê°€
    }

    if (mode === "both") {
      const parts = [];
      if (ìƒ‰ìƒ)  parts.push(ìƒ‰ìƒ);
      if (ì‚¬ì´ì¦ˆ) parts.push(ì‚¬ì´ì¦ˆ);
      if (parts.length) í…ìŠ¤íŠ¸ += ` / ${parts.join(" ")}`;  // ë¸”ë™ FREE
    }
    else if (mode === "colorOnly" && ìƒ‰ìƒ) {
      í…ìŠ¤íŠ¸ += ` / ${ìƒ‰ìƒ}`;
    }
    else if (mode === "sizeOnly" && ì‚¬ì´ì¦ˆ) {
      í…ìŠ¤íŠ¸ += ` / ${ì‚¬ì´ì¦ˆ}`;
    }

    return { ì œí’ˆì„ íƒ: í…ìŠ¤íŠ¸ };
  }

  // (ìˆ˜ì •ëœ) ì‚¬ì´ì¦ˆ expand í•¨ìˆ˜ (ë²”ìœ„+ë‹¨ìœ„ ìë™ ë¶„ë¦¬ ì§€ì›)
  function expandSizes(sizeStr) {
    if (!sizeStr || typeof sizeStr !== 'string') return [];
    sizeStr = sizeStr.trim();

    // ì½¤ë§ˆ/ìŠ¬ë˜ì‹œ/ì¤‘ê°„ì /ì „ê° êµ¬ë¶„ìë¡œ ë¶„ë¦¬ â†’ ê°ê° ì¬ê·€ í˜¸ì¶œ
    if (/[,ï¼Œ\/ï¼Â·ï½¤]/.test(sizeStr)) {
      return sizeStr
        .split(/[,ï¼Œ\/ï¼Â·ï½¤]/g)
        .map(s => s.trim())
        .filter(Boolean)
        .flatMap(expandSizes); // ì´ ë¶€ë¶„ì´ ì¤‘ìš”!
    }
    // ë²”ìœ„ ì…ë ¥(ì˜ˆ: 230~300, 90~110í˜¸)
    const m = sizeStr.match(/^(\d{2,4})~(\d{2,4})(.*)$/);
    if (m) {
      const start = parseInt(m[1], 10), end = parseInt(m[2], 10);
      const unit = m[3] ? m[3].trim() : '';
      const out = [];
      for (let v = start; v <= end; v += 5) {
        out.push(unit ? `${v}${unit}` : String(v));
      }
      return out;
    }
    return [sizeStr];
  }




  // (2) íŒŒì¼ ì—…ë¡œë“œ ë¦¬ìŠ¤ë„ˆ (DOMContentLoadedë¡œ ì´ë™)
  // document.getElementById("inputFile").addEventListener("change", function(e) { ... });

  let lastFocusedInput = null;

  //ì—‘ì…€ì—ì„œ ë³µì‚¬ ë¶™ì—¬ë„£ê¸° ì½”ë“œ
  document.querySelector('#inputTable tbody').addEventListener('paste', function(e) {
    const active = document.activeElement;
    if (!active || !active.matches('input[type="text"], input[type="number"]')) return;

    const text = (e.clipboardData || window.clipboardData).getData('text');
    if (!text) return;

    e.preventDefault(); // [ê°œì„ ] ë¶™ì—¬ë„£ê¸° ë™ì‘ì€ ë¬´ì¡°ê±´ ë§‰ê³  ì‹œì‘

    const tbody = document.querySelector('#inputTable tbody');
    let trs   = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('row-option-preview'));

    // [ê°€ë¡œ] ë¶™ì—¬ë„£ê¸°
    if (text.includes('\t')) {
      const rows = text.replace(/\r/g,'').split('\n').filter(Boolean);
      const td = active.closest('td');
      const tr = active.closest('tr');
      const colIdx = Array.from(tr.children).indexOf(td);
      let rowIdx = trs.indexOf(tr);

      // ë¶€ì¡±í•œ í–‰ ìë™ì¶”ê°€
      while (trs.length < rowIdx + rows.length) {
        addRow();
        trs = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('row-option-preview'));
      }

      for (let i = 0; i < rows.length; i++) {
        const cols = rows[i].split('\t');
        const targetRow = trs[rowIdx + i];
        if (!targetRow) break;
        for (let j = 0; j < cols.length; j++) {
          const targetTd = targetRow.children[colIdx + j];
          if (!targetTd) break;
          const targetInput = targetTd.querySelector('input');
          if (targetInput) {
            let v = cols[j];
            // <input type="number">ì— ì½¤ë§ˆ, ë¬¸ì ì œê±°
            if (targetInput.type === "number") {
              v = v.replace(/[^0-9.\-]/g, '');
            }
            targetInput.value = v;
            targetInput.dispatchEvent(new Event('input', {bubbles:true}));
          }
        }
      }
      return;
    }

    // [ì„¸ë¡œ] ë¶™ì—¬ë„£ê¸°: í•œ ì—´ì— ì—¬ëŸ¬ ê°’ (ê³µë€ë„ ë°˜ì˜)
    if (!text.includes('\t') && text.split('\n').length > 1) {
      const values = text.replace(/\r/g,'').split('\n');
      // ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ê°’ì´ ë§ˆì§€ë§‰ì— ë¹ˆ ì¤„ í•˜ë‚˜ ë¶™ì–´ì˜¤ëŠ” ê²½ìš°ë§Œ ì œê±°
      if (values.length > 0 && values[values.length - 1] === "") values.pop();
      
      const td     = active.closest('td');
      const tr     = active.closest('tr');
      const colIdx = Array.from(tr.children).indexOf(td);
      let trs2     = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('row-option-preview'));
      const rowIdx = trs2.indexOf(tr);

      // **í–‰ ë¶€ì¡±í•˜ë©´ ìë™ ì¶”ê°€**
      while (trs2.length < rowIdx + values.length) {
        addRow();
        trs2 = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('row-option-preview'));
      }

      // ë¶™ì—¬ë„£ê¸° ì‹¤ì œ ì…ë ¥ (ê³µë€ í¬í•¨)
      for(let i=0; i<values.length; i++) {
        const targetRow = trs2[rowIdx + i];
        if (!targetRow) break;
        const targetInput = targetRow.children[colIdx].querySelector('input');
        if (targetInput) {
          let v = values[i]; // ê³µë€ë„ ê·¸ëŒ€ë¡œ!
          // ìˆ«ìí•„ë“œì¼ ë•Œ ì½¤ë§ˆ, ë¬¸ì ì œê±°
          if (targetInput.type === "number") {
            v = v.replace(/[^0-9.\-]/g, '');
          }
          targetInput.value = v;
          targetInput.dispatchEvent(new Event('input', {bubbles:true}));
        }
      }
      return;
    }
    
    // [ê°œì„ ] ë‹¨ì¼ ì…€ ë¶™ì—¬ë„£ê¸° (ê¸°ë³¸ë™ì‘ì´ ë§‰í˜”ìœ¼ë¯€ë¡œ ì¶”ê°€)
    active.value = text;
    active.dispatchEvent(new Event('input', {bubbles:true}));

  });

  // ë²„íŠ¼ ì—°ê²° í•¨ìˆ˜
  document.getElementById('downloadRepresentativeBtn').addEventListener('click', downloadRepresentative);
  document.getElementById('downloadZipBtn').addEventListener('click', generateZip);
  document.getElementById('downloadAddProductBtn').addEventListener('click', downloadAddProductExcel);
  document.getElementById('downloadSingleProductBtn').addEventListener('click', downloadSingleProductExcel);
  document.getElementById('downloadSingleAllBtn').addEventListener('click', downloadSingleProductExcelAll);
  document.getElementById('downloadOrderedBtn').addEventListener('click', downloadOrderedTemplate);

  document.querySelectorAll('.table-action-btns button').forEach(btn => {
    const txt = btn.textContent.trim();
    if(txt === '+ í–‰ ì¶”ê°€') {
      btn.addEventListener('click', e => { e.preventDefault(); addRow(); });
    }
    else if(txt === 'ì´ˆê¸°í™”') {
      btn.addEventListener('click', e => { e.preventDefault(); clearTable(); });
    }
    else if(txt === 'ìˆœì„œ ì´ˆê¸°í™”') {
      btn.addEventListener('click', e => { e.preventDefault(); resetOrder(); });
    }
    else if(txt === 'ë§¨ ìœ„ë¡œ') {
      btn.addEventListener('click', e => { e.preventDefault(); moveSelectedToTop(); });
    }
    else if(txt === 'ìœ„ë¡œ') {
      btn.addEventListener('click', e => { e.preventDefault(); moveSelectedUp(); });
    }
    else if(txt === 'ì•„ë˜ë¡œ') {
      btn.addEventListener('click', e => { e.preventDefault(); moveSelectedDown(); });
    }
    else if(txt === 'ë§¨ ì•„ë˜ë¡œ') {
      btn.addEventListener('click', e => { e.preventDefault(); moveSelectedToBottom(); });
    }
  });

  // 'ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ' ë²„íŠ¼ ì—°ê²°
  document.getElementById('download-template-btn').addEventListener('click', function(e){
    e.preventDefault();
    downloadTemplate();
  });

  // í–‰ì˜ ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ ì…ë ¥ê°’ â†’ ì˜µì…˜ ì¡°í•©ë“¤ ë°˜í™˜
  function getOptionCombinations(colorStr, sizeStr) {
    const colors = parseOptions(colorStr);
    const sizes  = expandSizes(sizeStr);
    if (colors.length && sizes.length) {
      // ë„¤ì´ë²„ ì˜µì…˜ ë‹¤ìš´ë¡œë“œì™€ ê°™ì€ í‘œê¸°("ìƒ‰ìƒ / ì‚¬ì´ì¦ˆ")
      return colors.flatMap(color => sizes.map(size => `${color} / ${size}`));
    } else if (colors.length) {
      return colors;
    } else if (sizes.length) {
      return sizes;
    } else {
      return [];
    }
  }


  function updateOptionPreviewForRow(row) {
    if (row.classList.contains('row-option-preview')) return; // [ë°©ì–´] ìŠ¤ìŠ¤ë¡œë¥¼ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ

    // ìƒí’ˆëª…ë§Œ ëª¨ë“œ ë˜ëŠ” ë¯¸ë¦¬ë³´ê¸° OFFë©´ í”„ë¦¬ë·° í–‰ ì œê±° í›„ ì¢…ë£Œ
    if (!previewEnabled || getOptionDisplayMode() === 'nameOnly') {
      if (row.nextElementSibling && row.nextElementSibling.classList?.contains('row-option-preview')) {
        row.nextElementSibling.remove();
      }
      return;
    }

    // â†“â†“â†“â†“â†“â†“ ì•„ë˜ëŠ” ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ ë¶€ë¶„ (ONì¼ ë•Œë§Œ ì‹¤í–‰)
    const colorInput = row.querySelector('.col-color');
    const sizeInput  = row.querySelector('.col-size');

    const colors = colorInput ? colorInput.value : "";
    const sizes  = sizeInput  ? sizeInput.value  : "";

    // ì˜µì…˜ ì¡°í•© ì–»ê¸°
    const mode = getOptionDisplayMode();
    const combinations = getOptionCombinations(colors, sizes, mode);


    // ë¯¸ë¦¬ë³´ê¸° row ìƒì„± ë˜ëŠ” ì¬ì‚¬ìš©
    let preview = row.nextElementSibling && row.nextElementSibling.classList?.contains('row-option-preview')
      ? row.nextElementSibling
      : null;
      
    if (combinations.length === 0) {
      if(preview) preview.remove(); // ì¡°í•© ì—†ìœ¼ë©´ í”„ë¦¬ë·° ì‚­ì œ
      return;
    }

    if (!preview) {
      preview = document.createElement('tr');
      preview.className = 'row-option-preview';
      const td = document.createElement('td');
      td.colSpan = row.children.length;
      td.style.background = '#f7faf7';
      td.innerHTML = `<div class="option-preview" style="max-height:100px;overflow:auto;display:flex;flex-wrap:wrap;gap:6px 11px;font-size:14px;padding: 8px 12px;"></div>`;
      preview.appendChild(td);
      row.parentNode.insertBefore(preview, row.nextSibling);
    }
    const previewDiv = preview.querySelector('.option-preview');
    previewDiv.innerHTML = '';
    const soldoutInput = row.querySelector('.col-soldout'); // [ë¦¬íŒ©í† ë§] class

    combinations.forEach(opt => {
      const el = document.createElement('span');
      el.textContent = opt;
      el.className = 'preview-option-item';
      
      let isSoldout = false;
      if (soldoutInput) {
        const soldoutArr = soldoutInput.value.split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);

        // 1) ì „ì²´ í’ˆì ˆ(ë‹¨ì¢…/í’ˆì ˆ) ì²´í¬
        if (soldoutArr.includes("ë‹¨ì¢…") || soldoutArr.includes("í’ˆì ˆ")) {
          isSoldout = true;
        } else if (opt.includes(' / ')) {
          // 2) ì¼ë°˜ í’ˆì ˆ ì¡°í•© ì²´í¬ (ìƒ‰ìƒ / ì‚¬ì´ì¦ˆ)
          const [color, size] = opt.split(' / ').map(x => x.trim());
          isSoldout =
            soldoutArr.includes(opt.trim()) ||
            soldoutArr.includes(color) ||
            soldoutArr.includes(size);
        } else {
          // 3) ë‹¨ì¼ ì˜µì…˜ (ìƒ‰ìƒë§Œ or ì‚¬ì´ì¦ˆë§Œ)
          isSoldout = soldoutArr.includes(opt.trim());
        }
      }

      if (isSoldout) {
        el.classList.add('selected');
      }

      el.addEventListener('click', function() {
        if (!soldoutInput) return;
        let vals = soldoutInput.value.split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);
        const optTrim = opt.trim();
        
        // "ìƒ‰ìƒ / ì‚¬ì´ì¦ˆ" í˜•íƒœë¥¼ í´ë¦­í–ˆì„ ë•Œ
        if (optTrim.includes(' / ')) {
            const [color, size] = optTrim.split(' / ').map(x => x.trim());
            // ì´ë¯¸ "ìƒ‰ìƒ / ì‚¬ì´ì¦ˆ" ì¡°í•©ìœ¼ë¡œ ìˆê±°ë‚˜, "ìƒ‰ìƒ"ë§Œ ìˆê±°ë‚˜, "ì‚¬ì´ì¦ˆ"ë§Œ ìˆìœ¼ë©´ -> ì œê±°
            if (vals.includes(optTrim) || vals.includes(color) || vals.includes(size)) {
                vals = vals.filter(v => v !== optTrim && v !== color && v !== size);
            } else {
                vals.push(optTrim); // ì—†ë‹¤ë©´ "ìƒ‰ìƒ / ì‚¬ì´ì¦ˆ" ì¡°í•©ìœ¼ë¡œ ì¶”ê°€
            }
        } 
        // ë‹¨ì¼ ì˜µì…˜(ìƒ‰ìƒë§Œ or ì‚¬ì´ì¦ˆë§Œ)ì„ í´ë¦­í–ˆì„ ë•Œ
        else {
            if (!vals.includes(optTrim)) {
                vals.push(optTrim);
            } else {
                vals = vals.filter(v => v !== optTrim);
            }
        }
        
        soldoutInput.value = [...new Set(vals)].join(', '); // [ê°œì„ ] ì¤‘ë³µì œê±° í›„ ì…ë ¥
        updateOptionPreviewForRow(row);
        highlightInvalidOptions(); // [ì¶”ê°€] í’ˆì ˆ ë³€ê²½ ì‹œ ìœ íš¨ì„± ê²€ì‚¬
      });
      previewDiv.appendChild(el);
    });
  }


  // ì˜µì…˜ ë¯¸ë¦¬ë³´ê¸° í† ê¸€
  document.getElementById('previewToggleBtn').addEventListener('click', function() {
    previewEnabled = !previewEnabled;
    this.textContent = previewEnabled ? 'ì˜µì…˜ ë¯¸ë¦¬ë³´ê¸° ON' : 'ì˜µì…˜ ë¯¸ë¦¬ë³´ê¸° OFF';
    this.classList.toggle('preview-on', previewEnabled); // [ê°œì„ ] classë¡œ ìŠ¤íƒ€ì¼ ì œì–´
    refreshAllOptionPreviews();
  });

  // ì „ì²´ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹  í•¨ìˆ˜
  function refreshAllOptionPreviews() {
    document.querySelectorAll('#inputTable tbody tr').forEach(row => {
      if (!row.classList.contains('row-option-preview')) {
        updateOptionPreviewForRow(row);
      }
    });
  }
  
  // ================ ë“œë˜ê·¸&ë“œë¡­ ì—…ë¡œë“œ(ê¸°ì¡´ ì–‘ì‹ ìœ ì§€) ================
  (function enableDragAndDropUpload() {
    const zone = document.querySelector('.file-btn-wrap');  // íŒŒì¼ ë²„íŠ¼ ìˆëŠ” ì¤„
    if (!zone) return;

    const stop = (e) => { e.preventDefault(); e.stopPropagation(); };

    // ë“œë˜ê·¸ ì‹œ í•˜ì´ë¼ì´íŠ¸
    ['dragenter', 'dragover'].forEach(ev => {
      zone.addEventListener(ev, (e) => {
        stop(e);
        zone.classList.add('dragover');
      });
    });
    ['dragleave', 'dragend', 'drop'].forEach(ev => {
      zone.addEventListener(ev, (e) => {
        stop(e);
        zone.classList.remove('dragover');
      });
    });

    // íŒŒì¼ ë“œë¡­ ì²˜ë¦¬: ê¸°ì¡´ ì—…ë¡œë“œì™€ ë™ì¼í•˜ê²Œ í…Œì´ë¸” ì±„ì›€
    zone.addEventListener('drop', (e) => {
      // stop(e); // ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬ë¨
      // zone.classList.remove('dragover'); // ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬ë¨

      const files = e.dataTransfer && e.dataTransfer.files;
      if (!files || !files.length) return;

      const file = files[0];
      const okExt = /\.xlsx?$/i.test(file.name);
      if (!okExt) {
        alert('ì—‘ì…€ íŒŒì¼(.xls, .xlsx)ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          // === ì•„ë˜ ë¡œì§ì€ "ê¸°ì¡´ input ì—…ë¡œë“œ"ì™€ ë™ì¼í•˜ê²Œ ë™ì‘í•˜ë„ë¡ ì‘ì„± ===
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName =
            workbook.SheetNames.find(n => n.includes("ìƒí’ˆ") || n.includes("ì˜µì…˜")) ||
            workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          if (!sheet) {
            alert("ìƒí’ˆì˜µì…˜ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

          // í…Œì´ë¸” ì´ˆê¸°í™” í›„ ë¡œë“œ
          clearTable();
          json.forEach(row => addRow({
            ìƒí’ˆëª…: row["ìƒí’ˆëª…"],
            íŒë§¤ê°€: row["íŒë§¤ê°€"],
            ìƒ‰ìƒ:   row["ìƒ‰ìƒ"],
            ì‚¬ì´ì¦ˆ: row["ì‚¬ì´ì¦ˆ"],
            ["1ë²ˆ ìƒí’ˆëª…"]: row["1ë²ˆ ìƒí’ˆëª…"],
            í’ˆì ˆëœì¡°í•©: row["í’ˆì ˆëœ ì¡°í•©"] || "",
            ì œì™¸: row["ì œì™¸"] === "Y" || row["ì œì™¸"] === true // [ì˜¤íƒ€ìˆ˜ì •] "ì œM" -> "ì œì™¸"
          }));

          // ë¯¸ë¦¬ë³´ê¸° ë° ìœ íš¨ì„± ê°±ì‹ 
          Array.from(document.querySelectorAll('#inputTable tbody tr')).forEach(tr => {
            if (!tr.classList.contains('row-option-preview')) {
              updateOptionPreviewForRow(tr);
            }
          });
          originalData = getDataFromTable();
          highlightInvalidOptions();

          // íŒŒì¼ëª… í‘œì‹œ
          const nameSpan = document.getElementById('fileName');
          if (nameSpan) nameSpan.textContent = file.name;

        } catch (err) {
          console.error(err);
          alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
      };
      reader.readAsArrayBuffer(file);
    });
  })();

})(); // <-- IIFE ì¢…ë£Œ
</script>
</body>
</html>
