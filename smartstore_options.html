  <!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>스마트스토어 옵션</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <!-- 외부 라이브러리 로드 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/plugins/SortableMultiDrag.min.js"></script>

  <style>
    /* ───────────────────────────────────────────────────────────── */
    /* 박스 모델 통일 */
body {
  font-family: 'Pretendard', 'Apple SD Gothic Neo', '맑은 고딕', sans-serif;
  background: #fff;
  color: #203326;
  font-size: 16px;
  margin: 0;
}

.container {
  max-width: 100%;
  margin: auto;
  background: none;
  padding: 24px 32px 28px 32px;
  border-radius: 16px;
  box-shadow: 0 2px 18px rgba(40,80,60,0.06);
  overflow-x: auto;
}

.main-title-wrap {
  display: flex;
  align-items: flex-end;   /* 아래 정렬 */
  justify-content: space-between;
  min-height: 48px;
  margin-bottom: 28px;
  position: relative;
  padding-right: 42px;    /* 우측 버튼 여유 */
}

.main-title {
  font-size: 2.2rem;
  font-weight: 700;
  color: #184c37;
  margin: 0 0 0 16px;
  letter-spacing: 0.02em;
}

.right-guide-inline {
  display: flex;
  align-items: center;
  gap: 22px;
  justify-content: flex-end;
  margin-right: 0;
  margin-left: auto;    /* flex에서 오른쪽 끝! */
}

.guide-info, .guide-example {
  font-size: 13px;
  max-width: 210px;
  color: #203326;
}
.guide-info ul, .guide-example ul {
  margin: 4px 0 0 14px;
  padding: 0;
}
.guide-info b, .guide-example b {
  font-size: 13.5px;
}

.guide-btn, .webfile-btn {
  min-width: 140px;    /* 기존 버튼과 유사 */
  height: 42px;        /* 기존 버튼 높이와 맞춤 */
  background: #e1ece6;
  color: #2d684a;
  border: 1.2px solid #b0c9bb;
  border-radius: 9px;
  padding: 0 18px;
  font-size: 15px;     /* 기존 버튼 크기와 동일 */
  font-weight: 500;
  cursor: pointer;
  transition: 0.15s, border 0.14s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  margin: 0;
}

.guide-btn:hover, .webfile-btn:hover {
  background: #d2e3da;
  color: #184c37;
  border-color: #89ac98;
}

/* 옵션 전체 감싸는 박스 */
.option-box {
  background: #f7faf7;
  border-radius: 18px;
  box-shadow: 0 2px 18px rgba(60,100,60,0.04);
  padding: 32px 38px 34px 38px;
  max-width: 1800px;
  margin: 0 auto 36px auto;
  border: 1.5px solid #e5eee5;
}

/* 파일선택, 엑셀양식 버튼 */
.file-btn-wrap {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 18px;
  margin-top: 0;
}
.custom-file-label {
  background: #e1ece6;
  color: #2d684a;
  border: 1.2px solid #b0c9bb;
  border-radius: 7px;
  padding: 7px 18px;
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  transition: 0.15s, border 0.14s;
}
.custom-file-label:hover {
  background: #d2e3da;
  color: #184c37;
  border-color: #89ac98;
}

button {
  background: #e1ece6;
  color: #2d684a;
  border: 1.2px solid #b0c9bb;
  border-radius: 7px;
  padding: 8px 18px;
  font-size: 15px;
  font-weight: 500;
  margin-left: 8px;
  cursor: pointer;
  transition: 0.15s, border 0.14s;
}
button:hover {
  background: #d2e3da;
  color: #184c37;
  border-color: #89ac98;
}

/* 옵션방식/할인률/무료배송 등 한줄정렬 */
div[style*="margin-bottom:24px;"] {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0 14px;
  margin-bottom: 24px;
  line-height: 2;
}
div[style*="margin-bottom:24px;"] > * {
  margin: 0 !important;
  vertical-align: middle;
}
div[style*="margin-bottom:24px;"] input[type="number"] {
  width: 58px;
}
div[style*="margin-bottom:24px;"] label {
  font-weight: 400;
  font-size: 15px;
}

/* 표 */
table {
  width: 100%;
  background: #f7faf9;
  border-radius: 11px;
  border-collapse: separate;
  border-spacing: 0;
  box-shadow: 0 1px 7px rgba(60,120,100,0.03);
}
th, td {
  border-bottom: 1px solid #d2e3da;
  text-align: center;
  font-size: 15px;
  padding: 7px 3px;
}
th {
  background: #e4f1ea;
  color: #296149;
  font-weight: 600;
  border-top: 1.5px solid #8bbfa8;
}
th, td { border-right: none !important; border-left: none !important; }
tr:last-child td { border-bottom: none; }

/* 이동/대표 컬럼 좁게 */
#inputTable th:nth-child(1),
#inputTable th:nth-child(2),
#inputTable td:nth-child(1),
#inputTable td:nth-child(2) {
  width: 38px;
  min-width: 32px;
  max-width: 46px;
  text-align: center;
  vertical-align: middle;
  padding-left: 0;
  padding-right: 0;
}
#inputTable td input[type="checkbox"],
#inputTable td input[type="radio"] {
  display: inline-block;
  margin: 0 auto;
  vertical-align: middle;
  accent-color: #5a92d6;
  width: 18px;
  height: 18px;
  cursor: pointer;
}

/* 표 내부 입력란 통일 */
#inputTable td input[type="text"],
#inputTable td input[type="number"],
input[type="text"], input[type="number"] {
  width: 100%;
  background: #f7faf9;
  border: 1.2px solid #bedfc8;
  border-radius: 5px;
  padding: 7px 7px;
  font-size: 15px;
  color: #203326;
  outline: none;
  transition: border 0.18s;
  box-sizing: border-box;
}
#inputTable td input[type="text"]:focus,
#inputTable td input[type="number"]:focus,
input[type="text"]:focus, input[type="number"]:focus {
  border: 1.5px solid #61ad80;
  background: #e4f1ea;
}

/* 표 행 간격/글자 */
#inputTable tr { height: 38px; }
#inputTable th, #inputTable td { font-size: 14.3px; }
#inputTable th { font-size: 14.5px; }

/* 네이버 규정 위반 옵션 */
.invalid-option,
#inputTable tr.invalid-option {
  background: #ffe0e0 !important;
}

/* 행조작 버튼 그룹 */
.table-action-btns {
  margin-top: 20px;
  margin-bottom: 16px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
}

/* 다운로드 옵션 (중앙정렬) */
.download-option-wrap {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 28px;
  margin: 38px 0 18px 0;
}
.download-option-wrap label {
  font-size: 15px;
  color: #296149;
  font-weight: 500;
  letter-spacing: 0.01em;
}
/* 다운로드 버튼 (중앙정렬) */
.download-btn-wrap {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px 16px;
  margin-bottom: 0;
}
.download-btn-wrap button {
  min-width: 160px;
  margin: 0;
}

/* 숫자필드 스핀 제거 */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none; margin: 0;
}
input[type="number"] { -moz-appearance: textfield; }

/* 미리보기 옵션 아이템 꾸미기 */
.preview-option-item {
  background: #e1ece6;
  border-radius: 7px;
  padding: 3px 8px;
  margin-bottom: 4px;
  cursor: pointer;
  user-select: none;
  transition: 0.13s, color 0.13s;
}
.preview-option-item.selected {
  background: #f3d8d8 !important;
  color: #b45454 !important;
}

/* 반응형 */
@media (max-width: 900px) {
  .main-title-wrap,
  .right-guide-inline {
    flex-direction: column !important;
    gap: 7px !important;
    align-items: stretch !important;
  }
  .guide-info, .guide-example { max-width: 100%; }
  .webfile-btn { margin-left: 0; }
}

  </style>
</head>
<body>
  <div class="container">
    <!-- 제목, 상단 오른쪽 안내/예시/웹파일 버튼 & 드롭다운 -->
<div class="main-title-wrap">
  <h1 class="main-title">스마트스토어 옵션 자동 생성기</h1>
  <div class="right-guide-inline">
<button class="guide-btn" id="toggle-size-guide-btn">사이즈 입력 방법 안내</button>
<button class="guide-btn" id="toggle-out-guide-btn">품절 입력 예시</button>
<button class="guide-btn webfile-btn" id="webfile-link-btn">웹 파일</button>
<button id="openStockToolBtn" class="guide-btn webfile-btn">관리코드 일괄 품절툴</button>

  </div>
</div>
    <!-- 드롭다운 영역 -->
    <div style="display: flex; justify-content: flex-end; align-items: flex-start; gap: 10px; min-height: 40px; position: relative;">
<div id="size-guide-info" style="display:none; margin-top:10px;">
  <b>사이즈 입력 방법 안내</b>
  <ul>
    <li>범위 입력: 230~240 → 5단위 자동 생성 (예: 230,235,240)</li>
    <li>개별 입력: 230,235/245 → 쉼표 또는 슬래시로 직접 지정</li>
    <li>네이버 규정에 따라 미달·초과 옵션은 다운로드 시 자동 제거되며, 빨간색 표시</li>
  </ul>
</div>
      <div id="soldout-guide" class="guide-dropdown" style="display: none;">
        <b>품절 입력 예시</b><br>
        • 예시1) 블랙, 블루<br>
        • 예시2) 90,100,105<br>
        • 예시3) 블랙-100, 블루-105
      </div>
    </div>

    <!-- 기존 옵션/테이블/버튼 영역 -->
    <div class="option-box">
      <!-- 파일/엑셀 버튼 (기존대로) -->
<div class="file-btn-wrap">
  <input type="file" id="inputFile" style="display:none;">
  <button type="button" onclick="document.getElementById('inputFile').click();">파일 선택</button>
  <span id="fileName">선택된 파일 없음</span>
  <button type="button" class="webfile-btn">엑셀 양식 다운로드</button>
  <button type="button" id="previewToggleBtn" style="margin-left:10px;background:#f2f4f7;color:#888;">옵션 미리보기 OFF</button>
</div>
      <!-- 옵션 노출 방식 등 설정 -->
      <div style="margin-bottom:24px;">
        옵션 노출 방식:
<input type="radio" name="optionDisplay" value="both" id="opt-both" checked> 색상&사이즈 모두
<input type="radio" name="optionDisplay" value="colorOnly" id="opt-color"> 색상만
<input type="radio" name="optionDisplay" value="sizeOnly" id="opt-size"> 사이즈만
옵션가 계산 할인률 <input type="number" id="discountRate" value="100">% 
<input type="checkbox" id="freeShippingOption"> 무료배송(옵션가+2500원)
      </div>
      <!-- 테이블 및 아래 버튼 예시 -->
      <table id="inputTable">
        <thead>
          <tr>
            <th>이동</th>
            <th>대표</th>
            <th>상품명</th>
            <th>판매가</th>
            <th>색상</th>
            <th>사이즈</th>
            <th>1번 상품명</th>
            <th>품절된 조합</th>
            <th>제외</th>
          </tr>
        </thead>
        <tbody>
          <!-- 실제 행들은 JS에서 추가/생성 -->
        </tbody>
      </table>
      <!-- 표 하단 액션 버튼 -->
      <div class="table-action-btns">
        <button>+ 행 추가</button>
        <button>초기화</button>
        <button>순서 초기화</button>
        <button>맨 위로</button>
        <button>위로</button>
        <button>아래로</button>
        <button>맨 아래로</button>
      </div>
      <!-- 다운로드 옵션/버튼 -->
      <div class="download-option-wrap">
<label><input type="checkbox" id="hideBrand"> 브랜드 제거</label>
<label><input type="checkbox" id="splitProductCode"> 상품코드 분리</label>
<label><input type="checkbox" id="appendCodeToSize"> 사이즈에 상품코드</label>
<label><input type="checkbox" id="allFirstName"> 모두 1번상품명</label>

      </div>
<div class="download-btn-wrap">
  <button id="downloadRepresentativeBtn">선택상품 엑셀 다운로드</button>
  <button id="downloadZipBtn">일괄 ZIP 다운로드</button>
  <button id="downloadAddProductBtn">추가상품 다운로드</button>
  <button id="downloadSingleProductBtn">단품등록 다운로드</button>
  <button id="downloadSingleAllBtn">단품 전체 ZIP</button>
  <button id="downloadOrderedBtn">순서반영 엑셀 다운로드</button>
</div>
    </div>
  </div>
  <script>

// (최상단!) 전역 선언 필요
let originalData = [];

// 옵션 미리보기 기본값 OFF
let previewEnabled = false; // 기본값 OFF

document.getElementById('openStockToolBtn').addEventListener('click', function() {
  window.open('https://easyhara.github.io/stock_zero_tool/stock_zero_tool.html', '_blank');
});

// 브랜드, 상품코드, 분류, 조합을 추출
function parseBrandProductType(name) {
  if (!name) return { brand: '', codes: [], type: '', manageCodes: [] };
  const arr = name.trim().split(/\s+/);
  const brand = arr[0];
  if (arr.length === 1) {
    return { brand, codes: [brand], type: brand, manageCodes: [`${brand}`] };
  } else if (arr.length === 2) {
    return { brand, codes: [arr[1]], type: arr[1], manageCodes: [`${brand} ${arr[1]}`] };
  } else {
    const type = arr[arr.length - 1];
    const codes = arr.slice(1, -1);

    // 관리코드 = 브랜드 + 각 코드 + 분류
    let manageCodes = codes.map(code => {
      let combo = `${brand} ${code} ${type}`;
      let combo20 = combo.replace(/\s+/g, '');
      return combo20.length > 20 ? combo20.slice(0, 20) : combo;
    });
    if (manageCodes.length === 0) manageCodes = [`${brand} ${type}`];
    return { brand, codes, type, manageCodes };
  }
}


// ▶ JSON 데이터 → 시트 자동 너비 함수
function autoWidth(ws, data, header) {
  const colWidths = header.map(hdr => {
    let maxLen = hdr.length;            // 헤더 길이 기준
    data.forEach(row => {
      const v = row[hdr];
      if (v != null) {
        const len = v.toString().length;
        if (len > maxLen) maxLen = len;
      }
    });
    return { wch: maxLen + 2 };         // +2 여유
  });
  ws['!cols'] = colWidths;
}

// ▶ AOA(2차원 배열) → 시트 자동 너비 함수
function autoWidthAoA(ws, aoa) {
  const colCount = aoa[0]?.length || 0;
  const colWidths = [];
  for (let c = 0; c < colCount; c++) {
    let maxLen = 0;
    aoa.forEach(row => {
      const val = row[c] != null ? row[c].toString() : "";
      if (val.length > maxLen) maxLen = val.length;
    });
    colWidths.push({ wch: maxLen + 2 });
  }
  ws['!cols'] = colWidths;
}

//드롭다운 버튼
document.addEventListener('DOMContentLoaded', function() {
  // 할인율 input 이벤트 바인딩
  var discountInput = document.getElementById('discountRate');
  if (discountInput) {
    discountInput.addEventListener('input', highlightInvalidOptions);
    discountInput.addEventListener('change', highlightInvalidOptions);
  }

  // 파일 업로드 이벤트 바인딩
  var inputFile = document.getElementById('inputFile');
  if (inputFile) {
    inputFile.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        clearTable();
        json.forEach(r => addRow({
          상품명: r['상품명'],
          판매가: r['판매가'],
          색상:   r['색상'],
          사이즈: r['사이즈'],
          '1번 상품명': r['1번 상품명'],
          품절된조합: r['품절된 조합'] || '',
          제외: r['제외'] === 'Y'
        }));
        // === 추가 코드 ===
        Array.from(document.querySelectorAll('#inputTable tbody tr')).forEach(row => {
          updateOptionPreviewForRow(row);
        });
        originalData = getDataFromTable();
        highlightInvalidOptions();
      }; // ← 여기서 onload 함수 닫기

      reader.readAsArrayBuffer(file); // ← onload 함수 밖에 위치해야 함!
    });
  }
  // 사이즈 입력 안내
  const sizeBtn = document.getElementById('toggle-size-guide-btn');
  const sizeInfo = document.getElementById('size-guide-info');
  if (sizeBtn && sizeInfo) {
    sizeBtn.addEventListener('click', function() {
      sizeInfo.style.display = (sizeInfo.style.display === 'none' || sizeInfo.style.display === '') ? 'block' : 'none';
    });
  }
  // 품절 입력 예시
  const outBtn = document.getElementById('toggle-out-guide-btn');
  const outInfo = document.getElementById('soldout-guide');
  if (outBtn && outInfo) {
    outBtn.addEventListener('click', function() {
      outInfo.style.display = (outInfo.style.display === 'none' || outInfo.style.display === '') ? 'block' : 'none';
    });
  }
  // 웹파일 버튼 새 탭 링크
  const webfileBtn = document.getElementById('webfile-link-btn');
  if (webfileBtn) {
    webfileBtn.addEventListener('click', function() {
      window.open('https://github.com/EasyHara/smartstore_options/blob/main/smartstore_options.html', '_blank');
    });
  }
});

    // 클릭 핸들러: Ctrl/Cmd+클릭 시 selected 클래스 토글
function onRowClick(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
  if (e.ctrlKey || e.metaKey) this.classList.toggle('selected');
}
// 파일선택시 입력한 파일명 출력
document.getElementById('inputFile').addEventListener('change', function(e){
  const fileName = e.target.files[0]?.name || "선택된 파일 없음";
  document.getElementById('fileName').innerText = fileName;
});

// 할인률 인풋 클릭 시 100이면 자동으로 지움
document.getElementById('discountRate').addEventListener('focus', function(e) {
  if (e.target.value === '100') e.target.value = '';
});
// 포커스 해제시 비어있으면 다시 100
document.getElementById('discountRate').addEventListener('blur', function(e) {
  if (e.target.value === '') e.target.value = '100';
});

      // 행 추가 + 클릭 이벤트 바인딩
function addRow(data = {}) {
  const tbody = document.querySelector('#inputTable tbody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="checkbox" class="to-move"></td>
    <td><input type="radio"   name="대표" ${data.대표 ? "checked" : ""}></td>
    <td><input type="text"    value="${data.상품명   || ""}"></td>
    <td><input type="number"  value="${data.판매가   || ""}"></td>
    <td><input type="text"    value="${data.색상     || ""}"></td>
    <td><input type="text"    value="${data.사이즈   || ""}"></td>
    <td><input type="text"    value="${data['1번 상품명'] || ""}"></td>
    <td><input type="text"    value="${data.품절된조합 || ""}"></td>
    <td><input type="checkbox" ${data.제외 ? "checked" : ""}></td>
  `;
  // 클릭/입력 등 이벤트 바인딩(필요시)
  row.addEventListener('click', onRowClick);

  row.querySelectorAll('input').forEach(input => {
    input.addEventListener('input', function(){
      updateOptionPreviewForRow(row);
      highlightInvalidOptions();
    });
    input.addEventListener('change', function(){
      updateOptionPreviewForRow(row);
      highlightInvalidOptions();
    });
  });

  // 품절 조합 실시간 반영
  const soldoutInput = row.querySelectorAll('input')[7];
  if (soldoutInput) {
    soldoutInput.addEventListener('input', function() {
      highlightInvalidOptions();
    });
  }

  tbody.appendChild(row);
  highlightInvalidOptions();
  updateOptionPreviewForRow(row);
}


  // core + plugin 모두 로드된 이후에 한 번만 실행
  Sortable.create(document.querySelector('#inputTable tbody'), {
    animation: 150,
    handle: 'td',
    multiDrag: true,           // 멀티 드래그 활성화
    selectedClass: 'selected', // 선택된 행에 적용할 클래스
    multiDragKey: 'ctrl',      // Ctrl(Cmd) 키로 복수 선택
    fallbackTolerance: 3
  });
  

// 테이블 데이터를 스스_옵션양식 양식으로 엑셀 다운로드
function downloadOrderedTemplate() {
  // 1) 헤더 정의 (스스_옵션양식과 동일)
  const headers = [
    "상품명",
    "판매가",
    "색상",
    "사이즈",
    "1번 상품명",
    "품절된 조합",
    "제외"
  ];

  // 2) 현재 화면에 표시된 순서대로 <tbody>의 각 <tr>을 읽어서 데이터 배열 생성
  const data = Array.from(document.querySelectorAll('#inputTable tbody tr'))
  .filter(row => !row.classList.contains('row-option-preview')) // 미리보기 tr 제외!
  .map(row => {  
    const inputs = row.querySelectorAll('input');
    return [
      inputs[2].value.trim(),                // 상품명
      parseInt(inputs[3].value, 10) || 0,    // 판매가
      inputs[4].value.trim(),                // 색상
      inputs[5].value.trim(),                // 사이즈
      inputs[6].value.trim(),                // 1번 상품명
      inputs[7].value.trim(),                // 품절된 조합
      inputs[8].checked ? 'Y' : ''           // 제외(Y/빈문자)
    ];
  })
  .filter(Boolean); // null(비정상행) 제거

  // 3) SheetJS로 워크시트, 워크북 생성
  const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
  autoWidthAoA(ws, [headers, ...data]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "상품옵션");

  // 4) Blob으로 변환 후 FileSaver.js로 다운로드
  const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
  const blob = new Blob([wbout], { type: 'application/octet-stream' });
  saveAs(blob, '스스_옵션양식-순서반영.xls');
  }

    


    // 테이블 초기화
function clearTable() {
  document.querySelector('#inputTable tbody').innerHTML = '';
  document.getElementById('inputFile').value = '';    // 파일 선택 초기화
  originalData = [];                                  // 저장된 원본 순서도 초기화
  highlightInvalidOptions(); // ← 이 한 줄 추가!
}

    // 원래 순서 복원
function resetOrder() {
  const tbody = document.querySelector('#inputTable tbody');
  tbody.innerHTML = '';
  originalData.forEach(d => addRow(d));
}

    // 현재 테이블 데이터를 읽어서 객체 배열 리턴
    function getDataFromTable() {
  return Array.from(document.querySelectorAll('#inputTable tbody tr')).map(row => {
    const inputs = row.querySelectorAll('input');
    if (inputs.length < 9) return null;
    return {
      대표:     inputs[1].checked,
      상품명:   inputs[2].value.trim(),
      판매가:   parseInt(inputs[3].value)||0,
      색상:     inputs[4].value.trim(),
      사이즈:   inputs[5].value.trim(),
      ['1번 상품명']: inputs[6].value.trim(),
      품절된조합: inputs[7].value.trim(),
      제외:     inputs[8].checked
    };
  }).filter(Boolean);
}


    // 선택된 행을 위로/아래로 이동
    function moveSelectedUp() {
  const tbody = document.querySelector('#inputTable tbody');
  // 모든 행을 배열로, 위쪽부터 순회하며
  Array.from(tbody.querySelectorAll('tr')).forEach(row => {
    const cb = row.querySelector('.to-move');
    if (!cb || !cb.checked) return;
    const prev = row.previousElementSibling;
    if (prev) tbody.insertBefore(row, prev);
  });
}
    function moveSelectedDown() {
      const tbody = document.querySelector('#inputTable tbody');
      Array.from(tbody.querySelectorAll('tr')).reverse().forEach(row => {
        const cb = row.querySelector('.to-move');
        if (cb && cb.checked) {
          const next = row.nextElementSibling;
          if (next) tbody.insertBefore(next, row);
        }
      });
    }
    // 선택된 행을 맨 위로 이동
function moveSelectedToTop() {
  const tbody = document.querySelector('#inputTable tbody');
  // 체크된 행들을 위→아래 순서로 찾아서
  Array.from(tbody.querySelectorAll('tr')).forEach(row => {
    const cb = row.querySelector('.to-move');
    if (cb && cb.checked) {
      // 맨 위(첫 번째 자식) 앞에 삽입
      tbody.insertBefore(row, tbody.firstElementChild);
    }
  });
}
    // 선택된 행을 맨 아래로 이동
function moveSelectedToBottom() {
  const tbody = document.querySelector('#inputTable tbody');
  // 체크된 행들을 아래→위 순서로 찾아서
  Array.from(tbody.querySelectorAll('tr')).reverse().forEach(row => {
    const cb = row.querySelector('.to-move');
    if (cb && cb.checked) {
      tbody.appendChild(row);
    }
  });
}

    // 엑셀 템플릿 다운로드
    function downloadTemplate() {
      const headers = ['상품명','판매가','색상','사이즈','1번 상품명','품절된 조합','제외'];
      const ws = XLSX.utils.aoa_to_sheet([headers]);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'상품옵션');
      const blob = new Blob([XLSX.write(wb,{bookType:'xls',type:'array'})],{type:'application/octet-stream'});
      saveAs(blob,'스스_옵션양식.xls');
    }


      // 네이버 옵션가 유효성 검사
function isValidOptionPrice(basePrice, diff) {
  if (basePrice < 2000) return diff >= 0 && diff <= basePrice;
  if (basePrice < 10000) return diff >= -basePrice * 0.5 && diff <= basePrice;
  return diff >= -basePrice * 0.5 && diff <= basePrice * 0.5;
}

  // 할인률 기준 원가 계산
function calculateOriginalPrice(salePrice, discountRate) {
  const raw = salePrice / (1 - discountRate / 100);
  return Math.round(raw / 100) * 100;
}
// 빨간색(등록불가 옵션) 표기 함수 - 최종 옵션가로 검사!
function highlightInvalidOptions() {
  const discountRate = parseFloat(document.getElementById('discountRate').value) || 0;
  const freeShipping = document.getElementById('freeShippingOption')?.checked;
  const tbody = document.querySelector('#inputTable tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  if (!rows.length) return;

  // 대표행 찾기 (없으면 첫 행)
  let 대표 = null;
  rows.forEach(row => {
    const radio = row.querySelector('input[type="radio"]');
    if (radio && radio.checked) 대표 = row;
  });
  if (!대표) 대표 = rows[0];

  const 대표Inputs = 대표.querySelectorAll('input');
  if (대표Inputs.length < 9) return;  // 대표행 input도 체크!

  const 대표판매가 = parseInt(대표Inputs[3].value, 10) || 0;
  const masterPrice = calculateOriginalPrice(대표판매가, discountRate);

  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    if (inputs.length < 9) return;   // <<=== 이 줄 꼭 추가!
    const 판매가 = parseInt(inputs[3].value, 10) || 0;
  const 색상 = inputs[4].value.trim();
  const 사이즈 = inputs[5].value.trim();
  const 품절된조합 = inputs[7].value.trim();
  const isMaster = (row === 대표);

  // 최종 옵션가: diff + 무료배송 체크시 2500 (대표는 무료배송 미적용)
  let diff = 판매가 - 대표판매가;
  if (freeShipping && !isMaster) diff += 2500;

  // ------ 품절 옵션 체크 시작 ------
  let invalid = false;
  if (품절된조합) {
    const soldoutArr = 품절된조합.split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);
    // 색상, 사이즈 조합 모두 있는 경우
    if (색상 && 사이즈) {
      const colors = parseOptions(색상);
      const sizes = expandSizes(사이즈);
      const combinations = colors.flatMap(color => sizes.map(size => `${color}-${size}`));
      if (
        combinations.length > 0 &&
        combinations.every(c =>
          soldoutArr.includes(c) ||
          soldoutArr.includes(c.split('-')[0]) ||
          soldoutArr.includes(c.split('-')[1])
        )
      ) {
        invalid = true; // 모든 조합이 품절이면 행 전체 invalid-option
      }
    } else if (색상) {
      // 사이즈 없이 색상만 있을 때
      const colors = parseOptions(색상);
      if (colors.length > 0 && colors.every(c => soldoutArr.includes(c))) {
        invalid = true;
      }
    } else if (사이즈) {
      // 색상 없이 사이즈만 있을 때
      const sizes = expandSizes(사이즈);
      if (sizes.length > 0 && sizes.every(sz => soldoutArr.includes(sz))) {
        invalid = true;
      }
    }
  }
  // ------ 기존 가격 위반 체크도 함께 처리 ------
  if (!isValidOptionPrice(masterPrice, diff)) {
    invalid = true;
  }

  if (invalid) {
    row.classList.add('invalid-option');
  } else {
    row.classList.remove('invalid-option');
  }
});
}

// 이벤트 연결
document.getElementById('discountRate').addEventListener('input', highlightInvalidOptions);
document.getElementById('freeShippingOption').addEventListener('change', highlightInvalidOptions);

// 사이즈에 상품코드 붙이기
function extractProductCode(name) {
  if (!name) return "";
  const arr = name.trim().split(" ");
  // 첫 번째 단어(브랜드)를 제외하고, 그 다음 단어를 상품코드로 취급
  // ex) ["아이더", "TS-S2406", "티셔츠"] -> "TS-S2406"
  //     ["블랙야크", "S-폴로배색티셔츠"] -> "S-폴로배색티셔츠"
  return arr.length > 1 ? arr[1] : "";
}

  // 옵션 문자열 → 배열
function parseOptions(str) {
  if (!str || typeof str !== 'string') return [];
  return str
    // ASCII 콤마 ',', 전각 콤마 '，', 중간점 '·','､', ASCII 슬래시 '/', 전각 슬래시 '／' 등을 모두 분리
    .split(/[,，·､\/／]/g)    
    .map(s => s.trim())
    .filter(Boolean);
}
// (1) 상품명에서 "브랜드 상품코드 분류"만 추출
function extractManageCodes(name) {
  if (!name) return [];
  const m = name.match(/^(\S+)\s+(.+)$/); // 브랜드, 나머지
  if (!m) return [];
  const brand = m[1];
  const rest = m[2].trim();
  const parts = rest.split(' ');
  // parts 예: ['TS-S2401', 'TS-2402', '티셔츠']
  let 분류 = parts[parts.length - 1]; // 항상 맨 뒤가 분류
  // 분류에 '티셔츠' 등 한글 포함될 수 있음
  let codes = [];
  for (let i = 0; i < parts.length - 1; i++) {
    codes.push(`${brand} ${parts[i]} ${분류}`);
  }
  // 만약 상품코드가 하나라면
  if (codes.length === 0) codes.push(`${brand} ${parts[0]} ${분류}`);
  return codes;
}

// (2) 관리코드 20자 제한 (띄워쓰기 제거 후)
function limitManageCodeLength(str) {
  let out = str.replace(/\s+/g, "");
  if (out.length > 20) out = out.slice(0, 20);
  return out;
}
   
// “선택상품 엑셀 다운로드” (모든 상품 → 한 개 파일, 대표 무조건 01, 규정 위반 그룹 건너뛰고 연속 번호)
function downloadRepresentative() {
  const rows = getDataFromTable().filter(r => !r.제외);
  if (!rows.length) {
    alert("출력할 데이터가 없습니다.");
    return;
  }

  const hideBrand       = document.getElementById("hideBrand").checked;
  const discountRate    = parseFloat(document.getElementById("discountRate").value) || 0;
  const mode            = getOptionDisplayMode();
  const useAllFirstName = document.getElementById('allFirstName')?.checked;
  const appendCode      = document.getElementById('appendCodeToSize')?.checked;
  const splitProductCode = document.getElementById('splitProductCode')?.checked;
  const freeShipping    = document.getElementById('freeShippingOption')?.checked; // 무료배송 체크박스

  const master       = rows.find(r => r.대표) || rows[0];
  const masterPrice  = calculateOriginalPrice(master.판매가, discountRate);

  const ordered = [ master, ...rows.filter(r => r !== master) ];

  const data = [];
  let groupIndex = 0;

  ordered.forEach(item => {
    const diff    = item.판매가 - master.판매가;
    const colors  = parseOptions(item.색상).length ? parseOptions(item.색상) : [""];
    const sizes   = expandSizes(item.사이즈);
    const itemInfo = parseBrandProductType(item.상품명);

    // 색상수와 관리코드수 1:1 매칭
    const manageCodes = itemInfo.manageCodes;
    const colorCount = colors.length;
    const codeList = [];
    for(let i=0; i<colorCount; i++) {
      codeList.push(manageCodes[i] || manageCodes[manageCodes.length-1]);
    }

    let baseName;
    if (useAllFirstName) {
      baseName = item["1번 상품명"] ? `${itemInfo.brand} ${item["1번 상품명"]}` : item.상품명;
    } else {
      baseName = item.대표
        ? `${itemInfo.brand} ${item["1번 상품명"] || item.상품명}`
        : item.상품명;
    }

    // ★ 규정 체크: 무료배송이면 +2500을 옵션가로!
    const isMaster = (item === master);
    const optionPrice = diff + (freeShipping && !isMaster ? 2500 : 0);

    // 규정 위반 체크: 반드시 최종 옵션가 기준으로!
    const hasValid = colors.some(col => sizes.some(sz => isValidOptionPrice(masterPrice, optionPrice)));
    if (!hasValid) return;

    groupIndex++;
    const seq = String(groupIndex).padStart(2, "0");

    if (mode === "both") {
      colors.forEach((col, colIdx) => {
        sizes.forEach(sz => {
          let szCode = sz;
          if (appendCode && itemInfo.codes && itemInfo.codes.length) {
            szCode += " / " + (itemInfo.codes[colIdx] || itemInfo.codes[itemInfo.codes.length-1] || "");
          }
          let 품절 = false;
          if (
            (item.품절된조합 && (
              item.품절된조합.includes("단종") ||
              item.품절된조합.includes("품절") ||
              item.품절된조합.split(/[,\s/]+/).includes(col) ||
              item.품절된조합.split(/[,\s/]+/).includes(sz) ||
              item.품절된조합.split(/[,\s/]+/).includes(col + "-" + sz)
            ))
          ) {
            품절 = true;
          }
          let manageCode;
          if (splitProductCode) {
           manageCode = codeList[colIdx];
           if (manageCode.replace(/\s/g, '').length > 20) {
           manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
             }
          } else {
           manageCode = item.상품명;
           }
          data.push({
            제품선택: `${seq}) ${baseName}${col ? ` / ${col}` : ""}`,
            사이즈:   szCode,
            옵션가:    optionPrice,
            재고수량:  품절 ? 0 : 99999,
            관리코드:  manageCode,
            사용여부:  "Y"
          });
        });
      });
    } else if (mode === "colorOnly") {
      colors.forEach((col, colIdx) => {
        let 품절 = false;
        if (
          (item.품절된조합 && (
            item.품절된조합.includes("단종") ||
            item.품절된조합.includes("품절") ||
            item.품절된조합.split(/[,\s/]+/).includes(col)
          ))
        ) {
          품절 = true;
        }
        let manageCode = codeList[colIdx];
        if (manageCode.replace(/\s/g, '').length > 20) {
          manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
        }
        data.push({
          제품선택: `${seq}) ${baseName}`,
          색상:     col,
          옵션가:    optionPrice,
          재고수량:  품절 ? 0 : 99999,
          관리코드:  manageCode,
          사용여부:  "Y"
        });
      });
    } else {
      sizes.forEach(sz => {
        let szCode = sz;
        if (appendCode && itemInfo.codes && itemInfo.codes.length) {
          szCode += " / " + (itemInfo.codes[0] || "");
        }
        let 품절 = false;
        if (
          (item.품절된조합 && (
            item.품절된조합.includes("단종") ||
            item.품절된조합.includes("품절") ||
            item.품절된조합.split(/[,\s/]+/).includes(sz)
          ))
        ) {
          품절 = true;
        }
        let manageCode = codeList[0];
        if (manageCode.replace(/\s/g, '').length > 20) {
          manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
        }
        data.push({
          제품선택: `${seq}) ${baseName}`,
          사이즈:   szCode,
          옵션가:    optionPrice,
          재고수량:  품절 ? 0 : 99999,
          관리코드:  manageCode,
          사용여부:  "Y"
        });
      });
    }
  });

  // --- 브랜드 숨기기 & 25자 보정 로직 ---
  data.forEach(item => {
    if (hideBrand) {
      item.제품선택 = item.제품선택.replace(/^(\d+\)\s*)\S+\s/, "$1");
    }
    if (item.제품선택.length > 25) {
      item.제품선택 = item.제품선택.replace(/ \/ /g, "/");
    }
    if (item.제품선택.length > 25) {
      item.제품선택 = item.제품선택.replace(/^(\d+\))\s/, "$1");
    }
  });

  // ★★★ 무료배송 체크 시 파일명 변경
  let safeName = master.상품명.replace(/[\\\/:*?"<>|]/g, "").trim();
  if (freeShipping) safeName += "-무배";

  // 엑셀 헤더 구성
  const header = ["제품선택"];
  if (mode === "both" || mode === "sizeOnly") header.push("사이즈");
  if (mode === "colorOnly") header.push("색상");
  header.push("옵션가","재고수량","관리코드","사용여부");

  // 시트 생성 & 다운로드
  const ws = XLSX.utils.json_to_sheet(data, { header });
  autoWidth(ws, data, header);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "옵션데이터");
  saveAs(
    new Blob([XLSX.write(wb, { bookType: "xls", type: "array" })]),
    `${safeName}.xls`
  );
}

// 일괄 ZIP 다운로드 (무료배송 체크 시 내부 파일명 -무배)
function generateZip() {
  const rows = getDataFromTable().filter(r => !r.제외);
  if (!rows.length) {
    alert("출력할 데이터가 없습니다.");
    return;
  }

  const hideBrand      = document.getElementById("hideBrand").checked;
  const discountRate   = parseFloat(document.getElementById("discountRate").value) || 0;
  const mode           = getOptionDisplayMode();
  const zip            = new JSZip();
  const useAllFirstName = document.getElementById('allFirstName')?.checked;
  const appendCode     = document.getElementById('appendCodeToSize')?.checked;
  const freeShipping   = document.getElementById('freeShippingOption')?.checked; // 무료배송 체크박스

  rows.forEach(repr => {
    const reprInfo = parseBrandProductType(repr.상품명);
    const masterPrice = calculateOriginalPrice(repr.판매가, discountRate);

    const ordered = [ repr, ...rows.filter(r => r !== repr) ];
    const data = [];
    let groupIndex = 0;

    ordered.forEach(item => {
      const diff   = item.판매가 - repr.판매가;
      const colors = parseOptions(item.색상).length ? parseOptions(item.색상) : [""];
      const sizes  = expandSizes(item.사이즈);
      const itemInfo = parseBrandProductType(item.상품명);

      // 색상수와 관리코드수 1:1 매칭
      const manageCodes = itemInfo.manageCodes;
      const colorCount = colors.length;
      const codeList = [];
      for(let i=0; i<colorCount; i++) {
        codeList.push(manageCodes[i] || manageCodes[manageCodes.length-1]);
      }

      let baseName;
      if (useAllFirstName) {
        baseName = item["1번 상품명"] ? `${itemInfo.brand} ${item["1번 상품명"]}` : item.상품명;
      } else {
        baseName = item === repr
          ? `${itemInfo.brand} ${item["1번 상품명"] || item.상품명}`
          : item.상품명;
      }

      // ★ 규정 체크: 무료배송이면 +2500을 옵션가로!
      const isMaster = (item === repr);
      const optionPrice = diff + (freeShipping && !isMaster ? 2500 : 0);

      // 규정 위반 체크: 반드시 최종 옵션가 기준으로!
      const hasValid = colors.some(col => sizes.some(sz => isValidOptionPrice(masterPrice, optionPrice)));
      if (!hasValid) return;

      groupIndex++;
      const seq = String(groupIndex).padStart(2, "0");

      if (mode === "both") {
        colors.forEach((col, colIdx) => {
          sizes.forEach(sz => {
            let szCode = sz;
            if (appendCode && itemInfo.codes && itemInfo.codes.length) {
              szCode += " / " + (itemInfo.codes[colIdx] || itemInfo.codes[itemInfo.codes.length-1] || "");
            }
            let 품절 = false;
            if (
              (item.품절된조합 && (
                item.품절된조합.includes("단종") ||
                item.품절된조합.includes("품절") ||
                item.품절된조합.split(/[,\s/]+/).includes(col) ||
                item.품절된조합.split(/[,\s/]+/).includes(sz) ||
                item.품절된조합.split(/[,\s/]+/).includes(col + "-" + sz)
              ))
            ) {
              품절 = true;
            }
            let manageCode = codeList[colIdx];
            if (manageCode.replace(/\s/g, '').length > 20) {
              manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
            }

            data.push({
              제품선택: `${seq}) ${baseName}${col ? ` / ${col}` : ""}`,
              사이즈:   szCode,
              옵션가:    optionPrice,
              재고수량:  품절 ? 0 : 99999,
              관리코드:  manageCode,
              사용여부:  "Y"
            });
          });
        });
      } else if (mode === "colorOnly") {
        colors.forEach((col, colIdx) => {
          let 품절 = false;
          if (
            (item.품절된조합 && (
              item.품절된조합.includes("단종") ||
              item.품절된조합.includes("품절") ||
              item.품절된조합.split(/[,\s/]+/).includes(col)
            ))
          ) {
            품절 = true;
          }
          let manageCode = codeList[colIdx];
          if (manageCode.replace(/\s/g, '').length > 20) {
            manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
          }
          data.push({
            제품선택: `${seq}) ${baseName}`,
            색상:     col,
            옵션가:    optionPrice,
            재고수량:  품절 ? 0 : 99999,
            관리코드:  manageCode,
            사용여부:  "Y"
          });
        });
      } else {
        sizes.forEach(sz => {
          let szCode = sz;
          if (appendCode && itemInfo.codes && itemInfo.codes.length) {
            szCode += " / " + (itemInfo.codes[0] || "");
          }
          let 품절 = false;
          if (
            (item.품절된조합 && (
              item.품절된조합.includes("단종") ||
              item.품절된조합.includes("품절") ||
              item.품절된조합.split(/[,\s/]+/).includes(sz)
            ))
          ) {
            품절 = true;
          }
          let manageCode = codeList[0];
          if (manageCode.replace(/\s/g, '').length > 20) {
            manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
          }
          data.push({
            제품선택: `${seq}) ${baseName}`,
            사이즈:   szCode,
            옵션가:    optionPrice,
            재고수량:  품절 ? 0 : 99999,
            관리코드:  manageCode,
            사용여부:  "Y"
          });
        });
      }
    });

    // --- 브랜드 숨기기 & 25자 보정 로직 ---
    data.forEach(item => {
      if (hideBrand) {
        item.제품선택 = item.제품선택.replace(/^(\d+\)\s*)\S+\s/, "$1");
      }
      if (item.제품선택.length > 25) {
        item.제품선택 = item.제품선택.replace(/ \/ /g, "/");
      }
      if (item.제품선택.length > 25) {
        item.제품선택 = item.제품선택.replace(/^(\d+\))\s/, "$1");
      }
    });

    // ★★★ 무료배송 체크 시 파일명 변경
    let safeName = repr.상품명.replace(/[\\\/:*?"<>|]/g, "").trim();
    if (freeShipping) safeName += "-무배";

    const header = ["제품선택"];
    if (mode === "both" || mode === "sizeOnly") header.push("사이즈");
    if (mode === "colorOnly") header.push("색상");
    header.push("옵션가", "재고수량", "관리코드", "사용여부");

    const ws = XLSX.utils.json_to_sheet(data, { header });
    autoWidth(ws, data, header);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "옵션데이터");

    const blob = XLSX.write(wb, { bookType: "xls", type: "array" });
    zip.file(`${safeName}.xls`, blob);
  });

  zip.generateAsync({ type: "blob" })
    .then(content => saveAs(content, "옵션_일괄다운로드.zip"));
}

// 추가상품 엑셀 다운로드 (모든 제외되지 않은 상품 포함)
  function downloadAddProductExcel() {
    const mode = getOptionDisplayMode();
    const rows = getDataFromTable().filter(r => !r.제외);
    if (!rows.length) {
      return alert("출력할 데이터가 없습니다.");
    }

    // 1) 대표 상품 앞으로
    const 대표 = rows.find(r => r.대표) || rows[0];
    const items = [대표, ...rows.filter(r => r !== 대표)];

    // 2) 데이터 배열 채우기
    let data = [];
    items.forEach((item, idx) => {
      const seq    = String(idx+1).padStart(2, "0");
      const colors = parseOptions(item.색상);
      const sizes  = expandSizes(item.사이즈);
      const cols   = colors.length ? colors : [""];
      const szs    = sizes.length  ? sizes  : [""];

      cols.forEach(col => {
        szs.forEach(sz => {
          const opt = applyOptionMode(item.상품명, col, sz, seq);
          data.push({
            추가상품명: "제품선택",
            추가상품값: opt.제품선택,
            추가상품가: item.판매가,
            재고수량: 99999,
            사용여부: "Y",
            관리코드: item.상품명
          });
        });
      });
    });

    // 3) 중복 제거
    data = data.filter((row,i) =>
      data.findIndex(r => r.추가상품값 === row.추가상품값) === i
    );

    // 4) 안전한 파일명
    const safeName = 대표.상품명.replace(/[\\\/:*?"<>|]/g, "").trim();

    // 5) 워크북 생성 & 다운로드
    const header = [
    "추가상품명","추가상품값","추가상품가","재고수량","사용여부","관리코드"
  ];
    const ws    = XLSX.utils.json_to_sheet(data, { header });
    autoWidth(ws, data, header);
    const wb    = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "추가상품");
    const wbout = XLSX.write(wb, { bookType: "xls", type: "array" });
    saveAs(new Blob([wbout], { type: "application/octet-stream" }),
           `추가상품_${safeName}.xls`);
  }
  
// 단품등록용 엑셀 다운로드 - 대표상품만 순번 없이 출력  
function downloadSingleProductExcel() {
  const rows = getDataFromTable().filter(r => !r.제외);
  const 대표 = rows.find(r => r.대표) || rows[0];
  if (!대표) return alert("대표 상품이 없습니다.");

  const 색상목록 = parseOptions(대표.색상);
  const 사이즈목록 = expandSizes(대표.사이즈);
  const 품절조합 = parseOptions(대표.품절된조합);
  const 상품명 = 대표["1번 상품명"] || 대표.상품명;
  const mode = getOptionDisplayMode();

  const data = [];

  색상목록.forEach(color => {
    if (사이즈목록.length === 0) {
      const 품절 = 품절조합.includes(color);
      const row = {
        제품선택: mode === "both" ? `${상품명} / ${color}` : 상품명,
        옵션가: 0,
        재고수량: 품절 ? 0 : 99999,
        관리코드: 대표.상품명,
        사용여부: "Y"
      };
      if (mode === "colorOnly") row.색상 = color;
      if (mode === "sizeOnly" || mode === "both") row.사이즈 = 대표.사이즈;
      data.push(row);
    } else {
      사이즈목록.forEach(size => {
        const 품절 = 품절조합.includes(color) || 품절조합.includes(size) || 품절조합.includes(`${color}-${size}`);
        const row = {
          제품선택: mode === "both" ? `${상품명} / ${color}` : 상품명,
          옵션가: 0,
          재고수량: 품절 ? 0 : 99999,
          관리코드: 대표.상품명,
          사용여부: "Y"
        };
        if (mode === "colorOnly") row.색상 = color;
        if (mode === "sizeOnly" || mode === "both") row.사이즈 = size;
        data.push(row);
      });
    }
  });

  const header = ["제품선택"];
  if (mode === "colorOnly") header.push("색상");
  if (mode === "sizeOnly" || mode === "both") header.push("사이즈");
  header.push("옵션가", "재고수량", "관리코드", "사용여부");

  const rowsArray = data.map(row => {
    const line = [row.제품선택];
    if (mode === "colorOnly") line.push(row.색상);
    if (mode === "sizeOnly" || mode === "both") line.push(row.사이즈);
    line.push(row.옵션가, row.재고수량, row.관리코드, row.사용여부);
    return line;
  });

  const aoa = [header, ...rowsArray];
  const ws  = XLSX.utils.aoa_to_sheet(aoa);
  autoWidthAoA(ws, aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "단품옵션");
  const safeFileName = (대표.상품명 || "단품등록").replace(/[\/:*?"<>|]/g, "").trim();
  const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
  saveAs(new Blob([wbout], { type: "application/octet-stream" }), `단품등록_${safeFileName}.xls`);
}

// 단품등록용 전체 엑셀 ZIP 다운로드
function downloadSingleProductExcelAll() {
  const rows = getDataFromTable().filter(r => !r.제외);
  if (rows.length === 0) return alert("출력할 데이터가 없습니다.");

  const mode = getOptionDisplayMode();
  const zip = new JSZip();
  const 상품그룹 = [...new Set(rows.map(r => r.상품명))];

  상품그룹.forEach(상품명 => {
    const 그룹 = rows.filter(r => r.상품명 === 상품명);
    const 대표 = 그룹.find(r => r.대표) || 그룹[0];
    const 색상목록 = parseOptions(대표.색상);
    const 사이즈목록 = expandSizes(대표.사이즈);
    const 품절조합 = parseOptions(대표.품절된조합);
    const 대표상품명 = 대표["1번 상품명"] || 대표.상품명;

    const data = [];
    const 색상배열 = 색상목록.length > 0 ? 색상목록 : [""];

    색상배열.forEach(color => {
      if (사이즈목록.length === 0) {
        const 품절 = 품절조합.includes(color);
        const row = {
          제품선택: mode === "both" ? `${대표상품명} / ${color}` : 대표상품명,
          옵션가: 0,
          재고수량: 품절 ? 0 : 99999,
          관리코드: 대표.상품명,
          사용여부: "Y"
        };
        if (mode === "colorOnly") row.색상 = color;
        if (mode === "sizeOnly" || mode === "both") row.사이즈 = 대표.사이즈;
        data.push(row);
      } else {
        사이즈목록.forEach(size => {
          const 품절 = 품절조합.includes(color) || 품절조합.includes(size) || 품절조합.includes(`${color}-${size}`);
          const row = {
            제품선택: mode === "both" ? `${대표상품명} / ${color}` : 대표상품명,
            옵션가: 0,
            재고수량: 품절 ? 0 : 99999,
            관리코드: 대표.상품명,
            사용여부: "Y"
          };
          if (mode === "colorOnly") row.색상 = color;
          if (mode === "sizeOnly" || mode === "both") row.사이즈 = size;
          data.push(row);
        });
      }
    });

    const header = ["제품선택"];
    if (mode === "colorOnly") header.push("색상");
    if (mode === "sizeOnly" || mode === "both") header.push("사이즈");
    header.push("옵션가", "재고수량", "관리코드", "사용여부");

    const rowsArray = data.map(row => {
      const line = [row.제품선택];
      if (mode === "colorOnly") line.push(row.색상);
      if (mode === "sizeOnly" || mode === "both") line.push(row.사이즈);
      line.push(row.옵션가, row.재고수량, row.관리코드, row.사용여부);
      return line;
    });

    const aoa = [header, ...rowsArray];
    const ws  = XLSX.utils.aoa_to_sheet(aoa);
    autoWidthAoA(ws, aoa);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "단품옵션");
    const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
    const safeFileName = (대표.상품명 || "단품등록").replace(/[\/:*?"<>|]/g, "").trim();
    zip.file(`단품등록_${safeFileName}.xls`, wbout);
  });

  zip.generateAsync({ type: "blob" }).then(content => {
    saveAs(content, "단품등록_전체다운로드.zip");
  });
}

// 옵션 노출 방식 확인 함수
function getOptionDisplayMode() {
  const selected = document.querySelector('input[name="optionDisplay"]:checked');
  return selected ? selected.value : "both";
} 


  // (1) 옵션 구성 방식 적용 함수
function applyOptionMode(제품명, 색상, 사이즈, 순번) {
  const prefix = 순번 ? `${순번}) ` : "";
  let 텍스트 = `${prefix}${제품명}`;
  const mode = getOptionDisplayMode();

  if (mode === "both") {
    const parts = [];
    if (색상)  parts.push(색상);
    if (사이즈) parts.push(사이즈);
    if (parts.length) 텍스트 += ` / ${parts.join(" ")}`;  // 블랙 FREE
  }
  else if (mode === "colorOnly" && 색상) {
    텍스트 += ` / ${색상}`;
  }
  else if (mode === "sizeOnly" && 사이즈) {
    텍스트 += ` / ${사이즈}`;
  }

  return { 제품선택: 텍스트 };
}

// (수정된) 사이즈 expand 함수 (범위+단위 자동 분리 지원)
function expandSizes(sizeStr) {
  if (!sizeStr || typeof sizeStr !== 'string') return [];
  // 콤마/슬래시 분리
  if (/[,，\/／]/.test(sizeStr)) {
    return sizeStr
      .split(/[,，\/／]/g)
      .map(s => s.trim())
      .filter(Boolean);
  }
  // 범위 입력(예: 230~300mm, 90~110호)
  const m = sizeStr.match(/^(\d{2,4})~(\d{2,4})(.*)$/);
  if (m) {
    const start = +m[1], end = +m[2];
    const unit = m[3] ? m[3].trim() : '';
    const out = [];
    for (let v = start; v <= end; v += 5) {
      out.push(unit ? `${v}${unit}` : String(v));
    }
    return out;
  }
  return [sizeStr.trim()];
}


// 2) 파일 업로드 리스너
document.getElementById("inputFile").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(evt) {
    // 1) 워크북 파싱
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames.find(name =>
      name.includes("상품") || name.includes("옵션")
    ) || workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    if (!sheet) return alert("상품옵션 시트를 찾을 수 없습니다.");

    // 2) JSON 변환 → 테이블 초기화 → addRow 반복
    const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    clearTable();
    json.forEach(row => addRow({
      상품명: row["상품명"],
      판매가: row["판매가"],
      색상: row["색상"],
      사이즈: row["사이즈"],
      ["1번 상품명"]: row["1번 상품명"],
      품절된조합: row["품절된 조합"] || '',
      제외: row["제외"] === 'Y' || row["제외"] === true
    }));

    // 3) 테이블이 채워진 뒤에 originalData에 저장
    originalData = getDataFromTable();
  };

  reader.readAsArrayBuffer(file);
});
let lastFocusedInput = null;

//엑셀에서 복사 붙여넣기 코드
document.querySelector('#inputTable tbody').addEventListener('paste', function(e) {
  const active = document.activeElement;
  if (!active || !active.matches('input[type="text"], input[type="number"]')) return;

  const text = (e.clipboardData || window.clipboardData).getData('text');
  if (!text) return;

  const tbody = document.querySelector('#inputTable tbody');
  let trs   = Array.from(tbody.querySelectorAll('tr'));

  // [가로] 붙여넣기
  if (text.includes('\t')) {
    const rows = text.replace(/\r/g,'').split('\n').filter(Boolean);
    const td = active.closest('td');
    const tr = active.closest('tr');
    const colIdx = Array.from(tr.children).indexOf(td);
    let rowIdx = trs.indexOf(tr);

    // 부족한 행 자동추가
    while (trs.length < rowIdx + rows.length) {
      addRow();
      trs = Array.from(tbody.querySelectorAll('tr'));
    }

    for (let i = 0; i < rows.length; i++) {
      const cols = rows[i].split('\t');
      const targetRow = trs[rowIdx + i];
      if (!targetRow) break;
      for (let j = 0; j < cols.length; j++) {
        const targetTd = targetRow.children[colIdx + j];
        if (!targetTd) break;
        const targetInput = targetTd.querySelector('input');
        if (targetInput) {
          let v = cols[j];
          // <input type="number">에 콤마, 문자 제거
          if (
            targetInput.type === "number" ||
            targetInput.getAttribute("type") === "number"
          ) {
            v = v.replace(/[^0-9.\-]/g, '');
          }
          targetInput.value = v;
          targetInput.dispatchEvent(new Event('input', {bubbles:true}));
        }
      }
    }
    e.preventDefault();
    return;
  }

// [세로] 붙여넣기: 한 열에 여러 값 (공란도 반영)
if (!text.includes('\t') && text.split('\n').length > 1) {
  const values = text.replace(/\r/g,'').split('\n');
  // 엑셀에서 복사한 값이 마지막에 빈 줄 하나 붙어오는 경우만 제거
  if (values.length > 0 && values[values.length - 1] === "") values.pop();
  const td     = active.closest('td');
  const tr     = active.closest('tr');
  const colIdx = Array.from(tr.children).indexOf(td);
  let trs2     = Array.from(tbody.querySelectorAll('tr'));
  const rowIdx = trs2.indexOf(tr);

  // **행 부족하면 자동 추가**
  while (trs2.length < rowIdx + values.length) {
    addRow();
    trs2 = Array.from(tbody.querySelectorAll('tr'));
  }

  // 붙여넣기 실제 입력 (공란 포함)
  for(let i=0; i<values.length; i++) {
    const targetRow = trs2[rowIdx + i];
    if (!targetRow) break;
    const targetInput = targetRow.children[colIdx].querySelector('input');
    if (targetInput) {
      let v = values[i]; // 공란도 그대로!
      // 숫자필드일 때 콤마, 문자 제거
      if (
        targetInput.type === "number" ||
        targetInput.getAttribute("type") === "number"
      ) {
        v = v.replace(/[^0-9.\-]/g, '');
      }
      targetInput.value = v;
      targetInput.dispatchEvent(new Event('input', {bubbles:true}));
    }
  }
  e.preventDefault();
  return;
}


});  // ← 이 **닫는 괄호와 세미콜론(;)**이 반드시 필요함!!!

// 버튼 연결 함수
document.getElementById('downloadRepresentativeBtn').addEventListener('click', downloadRepresentative);
document.getElementById('downloadZipBtn').addEventListener('click', generateZip);
document.getElementById('downloadAddProductBtn').addEventListener('click', downloadAddProductExcel);
document.getElementById('downloadSingleProductBtn').addEventListener('click', downloadSingleProductExcel);
document.getElementById('downloadSingleAllBtn').addEventListener('click', downloadSingleProductExcelAll);
document.getElementById('downloadOrderedBtn').addEventListener('click', downloadOrderedTemplate);

document.querySelectorAll('.table-action-btns button').forEach(btn => {
  const txt = btn.textContent.trim();
  if(txt === '+ 행 추가') {
    btn.addEventListener('click', e => { e.preventDefault(); addRow(); });
  }
  else if(txt === '초기화') {
    btn.addEventListener('click', e => { e.preventDefault(); clearTable(); });
  }
  else if(txt === '순서 초기화') {
    btn.addEventListener('click', e => { e.preventDefault(); resetOrder(); });
  }
  else if(txt === '맨 위로') {
    btn.addEventListener('click', e => { e.preventDefault(); moveSelectedToTop(); });
  }
  else if(txt === '위로') {
    btn.addEventListener('click', e => { e.preventDefault(); moveSelectedUp(); });
  }
  else if(txt === '아래로') {
    btn.addEventListener('click', e => { e.preventDefault(); moveSelectedDown(); });
  }
  else if(txt === '맨 아래로') {
    btn.addEventListener('click', e => { e.preventDefault(); moveSelectedToBottom(); });
  }
});
// '엑셀 양식 다운로드' 버튼 연결
document.querySelectorAll('.webfile-btn').forEach(btn => {
  if(btn.textContent.includes('엑셀 양식')) {
    btn.addEventListener('click', function(e){
      e.preventDefault();
      downloadTemplate();
    });
  }
});
// 행의 색상/사이즈 입력값 → 옵션 조합들 반환
function getOptionCombinations(colorStr, sizeStr) {
  const colors = parseOptions(colorStr);
  const sizes  = expandSizes(sizeStr);
  if (colors.length && sizes.length) {
    // 색상-사이즈 조합 => "샌드-235"
    return colors.flatMap(color => sizes.map(size => `${color}-${size}`));
  } else if (colors.length) {
    return colors;
  } else if (sizes.length) {
    return sizes;
  } else {
    return [];
  }
}

function updateOptionPreviewForRow(row) {
  // previewEnabled가 false면 preview 행만 삭제하고 종료
  if (!previewEnabled) {
    if (row.nextElementSibling && row.nextElementSibling.classList?.contains('row-option-preview')) {
      row.nextElementSibling.remove();
    }
    return;
  }

  // ↓↓↓↓↓↓ 아래는 미리보기 표시 부분 (ON일 때만 실행)
  const tds = row.querySelectorAll('td');
  const colorInput = tds[4]?.querySelector('input');
  const sizeInput  = tds[5]?.querySelector('input');

  const colors = colorInput ? colorInput.value : "";
  const sizes  = sizeInput  ? sizeInput.value  : "";

  // 옵션 조합 얻기
  const combinations = getOptionCombinations(colors, sizes);

  // 미리보기 row 생성 또는 재사용
  let preview = row.nextElementSibling && row.nextElementSibling.classList?.contains('row-option-preview')
    ? row.nextElementSibling
    : null;
  if (!preview) {
    preview = document.createElement('tr');
    preview.className = 'row-option-preview';
    const td = document.createElement('td');
    td.colSpan = row.children.length;
    td.style.background = '#f7faf7';
    td.innerHTML = `<div class="option-preview" style="max-height:100px;overflow:auto;display:flex;flex-wrap:wrap;gap:6px 11px;font-size:14px;"></div>`;
    preview.appendChild(td);
    row.parentNode.insertBefore(preview, row.nextSibling);
  }
  const previewDiv = preview.querySelector('.option-preview');
  previewDiv.innerHTML = '';
  const soldoutInput = tds[7]?.querySelector('input'); // 품절란 input

  combinations.forEach(opt => {
  const el = document.createElement('span');
  el.textContent = opt;
  el.className = 'preview-option-item';
  el.style.cssText = 'background:#e1ece6;border-radius:7px;padding:3px 8px;margin-bottom:4px;cursor:pointer;';

  let isSoldout = false;
  if (soldoutInput) {
    const soldoutArr = soldoutInput.value.split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);

    // 컬러-사이즈 조합은 '-' 기준 분리
    if (opt.includes('-')) {
      const [color, size] = opt.split('-');
      isSoldout =
        soldoutArr.includes(opt) || // "옐로우-90" 등 완전 일치
        soldoutArr.includes(color) || // "옐로우"만 입력해도 전체 품절
        soldoutArr.includes(size);    // "90"만 입력해도 전체 90 사이즈 품절
    } else {
      isSoldout = soldoutArr.includes(opt);
    }
  }

  if (isSoldout) {
    el.style.background = '#f3d8d8';
    el.style.color = '#b45454';
  }

  el.addEventListener('click', function() {
    if (!soldoutInput) return;
    let vals = soldoutInput.value.split(/[,\s/]+/).map(v=>v.trim()).filter(Boolean);
    if (!vals.includes(opt)) {
      vals.push(opt);
    } else {
      vals = vals.filter(v => v !== opt);
    }
    soldoutInput.value = vals.join(', ');
    updateOptionPreviewForRow(row);
  });
  previewDiv.appendChild(el);
});

}


// 옵션 미리보기 토글
document.getElementById('previewToggleBtn').addEventListener('click', function() {
  previewEnabled = !previewEnabled;
  this.textContent = previewEnabled ? '옵션 미리보기 ON' : '옵션 미리보기 OFF';
  this.style.background = previewEnabled ? '#61ad80' : '#f2f4f7';
  this.style.color = previewEnabled ? '#fff' : '#888';
  refreshAllOptionPreviews();
});

// 전체 미리보기 갱신 함수
function refreshAllOptionPreviews() {
  document.querySelectorAll('#inputTable tbody tr').forEach(row => {
    updateOptionPreviewForRow(row);
  });
}
  </script>
</body>
</html>
