<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ìë™ ìƒì„±ê¸°</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* ë°•ìŠ¤ ëª¨ë¸ í†µì¼ */
    *, *::before, *::after { box-sizing: border-box; }

    body {
      font-family: 'Pretendard', sans-serif;
      padding: 20px;
      background: #f5f6fa;
      color: #333;
    }
    .container {
      max-width: 100%;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      overflow-x: auto;
    }
    h1 { font-size: 24px; margin-bottom: 16px; }

    /* í…Œì´ë¸” ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    table {
      width: 100%;
      min-width: 1200px;
      border-collapse: collapse;
      margin: 10px 0;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      font-size: 14px;
      word-break: break-word;
      vertical-align: middle;
    }
    th { background-color: #f0f0f0; }

    /* ë²„íŠ¼Â·íŒŒì¼Â·ì¸í’‹ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    button,
    input[type="file"],
    input[type="number"],
    input[type="text"] {
      margin: 4px;
      padding: 6px 10px;
      font-size: 14px;
      height: 36px;
      line-height: 1.2;
      vertical-align: middle;
    }

    /* í…Œì´ë¸” ë‚´ë¶€ input width í†µì¼ */
    #inputTable td input[type="text"],
    #inputTable td input[type="number"] {
      width: 100%;
    }

    /* ë¼ë””ì˜¤Â·ì²´í¬ë°•ìŠ¤ ì¤‘ì•™ ì •ë ¬ */
    #inputTable td input[type="radio"],
    #inputTable td input[type="checkbox"] {
      display: block;
      margin: auto;
      transform: scale(1.2);
    }

    /* ì¹¼ëŸ¼ í­ ì¡°ì • */
    #inputTable th:nth-child(1), #inputTable td:nth-child(1) { width: 5%; }
    #inputTable th:nth-child(2), #inputTable td:nth-child(2) { width: 20%; }
    #inputTable th:nth-child(3), #inputTable td:nth-child(3) { width: 15%; }
    #inputTable th:nth-child(4), #inputTable td:nth-child(4) { width: 15%; }
    #inputTable th:nth-child(5), #inputTable td:nth-child(5) { width: 15%; }
    #inputTable th:nth-child(6), #inputTable td:nth-child(6) { width: 15%; }
    #inputTable th:nth-child(7), #inputTable td:nth-child(7) { width: 10%; }
    #inputTable th:nth-child(8), #inputTable td:nth-child(8) { width: 5%; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ƒ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ìë™ ìƒì„±ê¸°</h1>
    <input type="file" id="inputFile" accept=".xls,.xlsx">
    <button onclick="downloadTemplate()">ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>

    <div style="position: relative; background: #f8f9fc; padding: 16px 20px; margin-bottom: 24px; border-radius: 10px; font-size: 14px; color: #333; line-height: 1.8; box-shadow: 0 0 0 1px #e5e7eb;">
      <a href="https://github.com/EasyHara/smartstore_options/blob/main/smartstore_options.html" target="_blank" style="position: absolute; top: 12px; right: 16px; background: #f8f9fc; color: #2563eb; font-weight: 500; font-size: 14px; text-decoration: none; padding: 4px 10px; border: 1px solid #d1d5db; border-radius: 6px;">ì›¹ íŒŒì¼</a>
      <strong style="font-size: 15px; display: block; margin-bottom: 8px; color: #1f2937;">ì‚¬ì´ì¦ˆ ì…ë ¥ ë°©ë²• ì•ˆë‚´</strong>
      <ul style="list-style: disc; padding-left: 20px; margin: 0;">
        <li><strong>ë²”ìœ„ ì…ë ¥:</strong> <code>230~240</code> â†’ <span style="color:#2563eb; font-weight: 600;">5ë‹¨ìœ„ ìë™ ìƒì„±</span> <span style="color: #888;">(ì˜ˆ: 230, 235, 240)</span></li>
        <li><strong>ê°œë³„ ì…ë ¥:</strong> <code>230,235/245</code> â†’ ì‰¼í‘œ ë˜ëŠ” ìŠ¬ë˜ì‹œë¡œ <span style="color:#2563eb; font-weight: 600;">ì‚¬ì´ì¦ˆ ì§ì ‘ ì§€ì •</span></li>
        <li><span style="color:#2563eb; font-weight: 600;">ë„¤ì´ë²„ ê·œì •ì— ë”°ë¼ ë¯¸ë‹¬, ì´ˆê³¼ëœ ì˜µì…˜ì€ ë‹¤ìš´ë¡œë“œì‹œ ìë™ìœ¼ë¡œ ì—†ì–´ì§‘ë‹ˆë‹¤</span></li>
      </ul>
    </div>

    <div style="margin: 20px auto; display: flex; justify-content: center; align-items: center; gap: 24px; flex-wrap: wrap;">
      <span style="font-weight: 500;">ì˜µì…˜ ë…¸ì¶œ ë°©ì‹:</span>
      <label><input type="radio" name="optionDisplay" value="both" checked> ìƒ‰ìƒ&ì‚¬ì´ì¦ˆ ëª¨ë‘</label>
      <label><input type="radio" name="optionDisplay" value="colorOnly"> ìƒ‰ìƒë§Œ</label>
      <label><input type="radio" name="optionDisplay" value="sizeOnly"> ì‚¬ì´ì¦ˆë§Œ</label>

      <label for="discountRate" style="font-weight: 500;">ì˜µì…˜ê°€ ê³„ì‚° ê¸°ì¤€ í• ì¸ë¥  (%)</label>
      <input type="number" id="discountRate" value="0" min="0" max="99" step="1" style="width: 60px; text-align: right;">%
      <span style="color: #888; font-size: 13px;">(ë„¤ì´ë²„í• ì¸ê°€ ê¸°ì¤€)</span>
    </div>

    <table id="inputTable">
      <thead>
        <tr>
          <th>ì„ íƒ</th><th>ìƒí’ˆëª…</th><th>íŒë§¤ê°€(ë„¤ì´ë²„í• ì¸ê°€)</th><th>ìƒ‰ìƒ</th><th>ì‚¬ì´ì¦ˆ</th><th>1ë²ˆ ìƒí’ˆëª…</th><th>í’ˆì ˆëœ ìƒ‰ìƒ,ì‚¬ì´ì¦ˆ</th><th>ì˜µì…˜ì—ì„œ ì œì™¸</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="addRow()">+ í–‰ ì¶”ê°€</button>
    <button onclick="clearTable()">ì´ˆê¸°í™”</button>
    <br><br>
    <div style="text-align: center; margin-top: 20px;">
      <button onclick="downloadRepresentative()">ì„ íƒìƒí’ˆ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="generateZip()">ì¼ê´„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ZIP)</button>
      <button onclick="downloadAddProductExcel()">ì¶”ê°€ìƒí’ˆ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="downloadSingleProductExcel()">ë‹¨í’ˆë“±ë¡ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="downloadSingleProductExcelAll()">ë‹¨í’ˆë“±ë¡ ì—‘ì…€ ì „ì²´ë‹¤ìš´ë¡œë“œ</button>
</div>
  </div>

  <script>
  // ì˜µì…˜ê°€ ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜ (ë„¤ì´ë²„ ê·œì • ë°˜ì˜)
function isValidOptionPrice(basePrice, diff) {
  if (basePrice < 2000) {
    return diff >= 0 && diff <= basePrice * 1.0;
  } else if (basePrice < 10000) {
    return diff >= basePrice * -0.5 && diff <= basePrice * 1.0;
  } else {
    return diff >= basePrice * -0.5 && diff <= basePrice * 0.5;
  }
}


  // í• ì¸ë¥  ê¸°ì¤€ìœ¼ë¡œ ì›ë˜ íŒë§¤ê°€ ê³„ì‚°
  function calculateOriginalPrice(salePrice, discountRate) {
    const raw = salePrice / (1 - discountRate / 100);
    return Math.round(raw / 100) * 100;  // 100ì› ë‹¨ìœ„ ë°˜ì˜¬ë¦¼
  }
    document.getElementById("inputFile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const sheetName = workbook.SheetNames.find(name =>
          name.includes("ìƒí’ˆ") || name.includes("ì˜µì…˜")
        ) || workbook.SheetNames[0];

        const sheet = workbook.Sheets[sheetName];
        if (!sheet) return alert("ìƒí’ˆì˜µì…˜ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        clearTable();
        json.forEach(row => addRow({
          ìƒí’ˆëª…: row["ìƒí’ˆëª…"],
          íŒë§¤ê°€: row["íŒë§¤ê°€"],
          ìƒ‰ìƒ: row["ìƒ‰ìƒ"],
          ì‚¬ì´ì¦ˆ: row["ì‚¬ì´ì¦ˆ"],
          ["1ë²ˆ ìƒí’ˆëª…"]: row["1ë²ˆ ìƒí’ˆëª…"],
          í’ˆì ˆëœì¡°í•©: row["í’ˆì ˆëœ ì¡°í•©"] || '',
          ì œì™¸: row["ì œì™¸"] === 'Y' || row["ì œì™¸"] === true
        }));
      };
      reader.readAsArrayBuffer(file);
    });

    function addRow(data = {}) {
      const tbody = document.querySelector("#inputTable tbody");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="radio" name="ëŒ€í‘œ"></td>
        <td><input value="${data.ìƒí’ˆëª… || ''}"></td>
        <td><input value="${data.íŒë§¤ê°€ || ''}" type="number"></td>
        <td><input value="${data.ìƒ‰ìƒ || ''}"></td>
        <td><input value="${data.ì‚¬ì´ì¦ˆ || ''}"></td>
        <td><input value="${data["1ë²ˆ ìƒí’ˆëª…"] || ''}"></td>
        <td><input value="${data.í’ˆì ˆëœì¡°í•© || ''}"></td>
        <td><input type="checkbox" ${data.ì œì™¸ ? 'checked' : ''}></td>
      `;
      tbody.appendChild(row);
    }

    function clearTable() {
      document.querySelector("#inputTable tbody").innerHTML = '';
      document.getElementById("inputFile").value = "";
    }

    function getDataFromTable() {
      const rows = document.querySelectorAll("#inputTable tbody tr");
      return Array.from(rows).map(row => {
        const cells = row.querySelectorAll("input");
        return {
          ëŒ€í‘œ: cells[0]?.checked ?? false,
          ìƒí’ˆëª…: cells[1]?.value?.trim() || "",
          íŒë§¤ê°€: parseInt(cells[2]?.value) || 0,
          ìƒ‰ìƒ: cells[3]?.value?.trim() || "",
          ì‚¬ì´ì¦ˆ: cells[4]?.value?.trim() || "",
          ["1ë²ˆ ìƒí’ˆëª…"]: cells[5]?.value?.trim() || "",
          í’ˆì ˆëœì¡°í•©: cells[6]?.value?.trim() || "",
          ì œì™¸: cells[7]?.checked ?? false
        };
      });
    }

    function downloadTemplate() {
      const headers = ["ìƒí’ˆëª…", "íŒë§¤ê°€", "ìƒ‰ìƒ", "ì‚¬ì´ì¦ˆ", "1ë²ˆ ìƒí’ˆëª…", "í’ˆì ˆëœ ì¡°í•©", "ì œì™¸"];
      const ws = XLSX.utils.aoa_to_sheet([headers]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ìƒí’ˆì˜µì…˜");
      const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
      saveAs(new Blob([wbout], { type: "application/octet-stream" }), `ìŠ¤ìŠ¤_ì˜µì…˜ì–‘ì‹.xls`);
    }

// ëŒ€í‘œìƒí’ˆ ê¸°ì¤€ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function downloadRepresentative() {
  const rows = getDataFromTable().filter(r => !r.ì œì™¸);
  if (!rows.length) return alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

  const ëŒ€í‘œ = rows.find(r => r.ëŒ€í‘œ) || rows[0];
  const í• ì¸ë¥  = parseFloat(document.getElementById("discountRate").value) || 0;
  const ëŒ€í‘œì •ê°€ = calculateOriginalPrice(ëŒ€í‘œ.íŒë§¤ê°€, í• ì¸ë¥ );
  const mode = getOptionDisplayMode();
  let data = [];

  // 1) ì˜µì…˜ ë°ì´í„° ìˆ˜ì§‘
  rows.sort((a,b)=>(a===ëŒ€í‘œ?-1:b===ëŒ€í‘œ?1:0)).forEach(item=>{
    const ì˜µì…˜ê°€ = item.íŒë§¤ê°€ - ëŒ€í‘œ.íŒë§¤ê°€;
    if (!isValidOptionPrice(ëŒ€í‘œì •ê°€, ì˜µì…˜ê°€)) return;

    const ì œí’ˆëª… = (item===ëŒ€í‘œ && item["1ë²ˆ ìƒí’ˆëª…"] && item["1ë²ˆ ìƒí’ˆëª…"]!==item.ìƒí’ˆëª…)
      ? `${item.ìƒí’ˆëª….split(" ")[0]} ${item["1ë²ˆ ìƒí’ˆëª…"]}` : item.ìƒí’ˆëª…;

    const ìƒ‰ìƒëª©ë¡ = parseOptions(item.ìƒ‰ìƒ).length? parseOptions(item.ìƒ‰ìƒ) : [""];
    const ì‚¬ì´ì¦ˆëª©ë¡ = expandSizes(item.ì‚¬ì´ì¦ˆ);

    ìƒ‰ìƒëª©ë¡.forEach(col=>{
      if (!ì‚¬ì´ì¦ˆëª©ë¡.length) {
        const base = applyOptionMode(ì œí’ˆëª…, col, null, ì œí’ˆëª…, "");
        data.push({ ...base, ì˜µì…˜ê°€, ê´€ë¦¬ì½”ë“œ: item.ìƒí’ˆëª…, ì¬ê³ ìˆ˜ëŸ‰:99999, ì‚¬ìš©ì—¬ë¶€:"Y" });
      } else {
        ì‚¬ì´ì¦ˆëª©ë¡.forEach(sz=>{
          const base = applyOptionMode(ì œí’ˆëª…, col, sz, ì œí’ˆëª…, "");
          data.push({ ...base, ì˜µì…˜ê°€, ê´€ë¦¬ì½”ë“œ: item.ìƒí’ˆëª…, ì¬ê³ ìˆ˜ëŸ‰:99999, ì‚¬ìš©ì—¬ë¶€:"Y" });
        });
      }
    });
  });

  // 2) ì¤‘ë³µ ì œê±° (ìƒí’ˆëª…+ì˜µì…˜ê°€+ìƒ‰ìƒ+ì‚¬ì´ì¦ˆ)
  {
    const seen = new Set();
    data = data.filter(r => {
      const key = [r.ê´€ë¦¬ì½”ë“œ, r.ì˜µì…˜ê°€, r.ìƒ‰ìƒ||"", r.ì‚¬ì´ì¦ˆ||""].join("|");
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });
  }

  // 3) ìƒí’ˆ ê·¸ë£¹ë³„ ìˆœë²ˆ ë§¤í•‘
  const groupSeq = {};
  data.forEach(r=>{
    if (!(r.ê´€ë¦¬ì½”ë“œ in groupSeq)) {
      groupSeq[r.ê´€ë¦¬ì½”ë“œ] = Object.keys(groupSeq).length + 1;
    }
  });

  // 4) ìˆœë²ˆ ë¶™ì´ê¸°
  data = data.map(r=>{
    const seq = String(groupSeq[r.ê´€ë¦¬ì½”ë“œ]).padStart(2,"0");
    return { ...r, ì œí’ˆì„ íƒ: `${seq}) ${r.ì œí’ˆì„ íƒ.replace(/^\d+\)\s*/, "")}` };
  });

  // 5) ëª¨ë“œë³„ ì»¬ëŸ¼ ì •ë¦¬
  if (mode==="colorOnly") data.forEach(r=>delete r.ì‚¬ì´ì¦ˆ);
  if (mode==="sizeOnly")  data.forEach(r=>delete r.ìƒ‰ìƒ);
  if (mode!=="colorOnly" && !data.some(r=>r.ì‚¬ì´ì¦ˆ)) data.forEach(r=>delete r.ì‚¬ì´ì¦ˆ);

  // 6) ì—‘ì…€ ìƒì„±
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ì˜µì…˜ë°ì´í„°");
  const out = XLSX.write(wb,{bookType:"xls",type:"array"});
  saveAs(new Blob([out],{type:"application/octet-stream"}), `${ëŒ€í‘œ.ìƒí’ˆëª…}.xls`);
}
    

// ì¼ê´„ ZIP ë‹¤ìš´ë¡œë“œ
function generateZip() {
  const rows = getDataFromTable().filter(r => !r.ì œì™¸);
  if (!rows.length) return alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

  const í• ì¸ë¥  = parseFloat(document.getElementById("discountRate").value) || 0;
  const mode = getOptionDisplayMode();
  const zip = new JSZip();

  rows.forEach(ëŒ€í‘œ=>{
    const ëŒ€í‘œì •ê°€ = calculateOriginalPrice(ëŒ€í‘œ.íŒë§¤ê°€, í• ì¸ë¥ );
    const items = rows.sort((a,b)=>(a===ëŒ€í‘œ?-1:b===ëŒ€í‘œ?1:0));
    let data = [];

    items.forEach(item=>{
      const ì˜µì…˜ê°€ = item.íŒë§¤ê°€ - ëŒ€í‘œ.íŒë§¤ê°€;
      if (!isValidOptionPrice(ëŒ€í‘œì •ê°€, ì˜µì…˜ê°€)) return;

      const ì œí’ˆëª… = (item===ëŒ€í‘œ && item["1ë²ˆ ìƒí’ˆëª…"] && item["1ë²ˆ ìƒí’ˆëª…"]!==item.ìƒí’ˆëª…)
        ? `${item.ìƒí’ˆëª….split(" ")[0]} ${item["1ë²ˆ ìƒí’ˆëª…"]}` : item.ìƒí’ˆëª…;

      const ìƒ‰ìƒëª©ë¡ = parseOptions(item.ìƒ‰ìƒ).length? parseOptions(item.ìƒ‰ìƒ) : [""];
      const ì‚¬ì´ì¦ˆëª©ë¡ = expandSizes(item.ì‚¬ì´ì¦ˆ);

      ìƒ‰ìƒëª©ë¡.forEach(col=>{
        if (!ì‚¬ì´ì¦ˆëª©ë¡.length) {
          const base = applyOptionMode(ì œí’ˆëª…, col, null, ì œí’ˆëª…, "");
          data.push({ ...base, ì˜µì…˜ê°€, ê´€ë¦¬ì½”ë“œ:item.ìƒí’ˆëª…, ì¬ê³ ìˆ˜ëŸ‰:99999, ì‚¬ìš©ì—¬ë¶€:"Y" });
        } else {
          ì‚¬ì´ì¦ˆëª©ë¡.forEach(sz=>{
            const base = applyOptionMode(ì œí’ˆëª…, col, sz, ì œí’ˆëª…, "");
            data.push({ ...base, ì˜µì…˜ê°€, ê´€ë¦¬ì½”ë“œ:item.ìƒí’ˆëª…, ì¬ê³ ìˆ˜ëŸ‰:99999, ì‚¬ìš©ì—¬ë¶€:"Y" });
          });
        }
      });
    });

    // ì¤‘ë³µ ì œê±°
    {
      const seen = new Set();
      data = data.filter(r=>{
        const key=[r.ê´€ë¦¬ì½”ë“œ,r.ì˜µì…˜ê°€,r.ìƒ‰ìƒ||"",r.ì‚¬ì´ì¦ˆ||""].join("|");
        if(seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    // ê·¸ë£¹ë³„ ìˆœë²ˆ ë§¤í•‘
    const groupSeq = {};
    data.forEach(r=>{
      if (!(r.ê´€ë¦¬ì½”ë“œ in groupSeq)) {
        groupSeq[r.ê´€ë¦¬ì½”ë“œ] = Object.keys(groupSeq).length + 1;
      }
    });

    // ìˆœë²ˆ ë¶™ì´ê¸°
    data = data.map(r=>{
      const seq = String(groupSeq[r.ê´€ë¦¬ì½”ë“œ]).padStart(2,"0");
      return { ...r, ì œí’ˆì„ íƒ: `${seq}) ${r.ì œí’ˆì„ íƒ.replace(/^\d+\)\s*/, "")}` };
    });

    // ëª¨ë“œë³„ ì»¬ëŸ¼ ì •ë¦¬
    if (mode==="colorOnly") data.forEach(r=>delete r.ì‚¬ì´ì¦ˆ);
    if (mode==="sizeOnly")  data.forEach(r=>delete r.ìƒ‰ìƒ);
    if (mode!=="colorOnly" && !data.some(r=>r.ì‚¬ì´ì¦ˆ)) data.forEach(r=>delete r.ì‚¬ì´ì¦ˆ);

    // ì›Œí¬ë¶ & ZIP
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ì˜µì…˜ë°ì´í„°");
    const out = XLSX.write(wb,{bookType:"xls",type:"array"});
    zip.file(`${ëŒ€í‘œ.ìƒí’ˆëª…}.xls`, out);
  });

  zip.generateAsync({type:"blob"}).then(blob=>saveAs(blob,"ì˜µì…˜_ì¼ê´„ë‹¤ìš´ë¡œë“œ.zip"));
}
// ì¶”ê°€ìƒí’ˆ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ëª¨ë“  ì œì™¸ë˜ì§€ ì•Šì€ ìƒí’ˆ í¬í•¨)
function downloadAddProductExcel() {
  const rows = getDataFromTable().filter(r => !r.ì œì™¸);
  if (rows.length === 0) return alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

  const ëŒ€í‘œ = rows.find(r => r.ëŒ€í‘œ) || rows[0];
  const ëŒ€í‘œìƒí’ˆëª… = ëŒ€í‘œ.ìƒí’ˆëª…;
  const items = rows.sort((a, b) => (a === ëŒ€í‘œ ? -1 : b === ëŒ€í‘œ ? 1 : 0));

  let index = 1;
  const data = [];

  items.forEach(item => {
    const ìˆœë²ˆ = index < 10 ? `0${index}` : `${index}`;
    const ìƒ‰ìƒëª©ë¡ = parseOptions(item.ìƒ‰ìƒ);
    const ì‚¬ì´ì¦ˆëª©ë¡ = expandSizes(item.ì‚¬ì´ì¦ˆ);
    const ìƒ‰ìƒë°°ì—´ = ìƒ‰ìƒëª©ë¡.length > 0 ? ìƒ‰ìƒëª©ë¡ : [""];

    ìƒ‰ìƒë°°ì—´.forEach(color => {
      if (ì‚¬ì´ì¦ˆëª©ë¡.length === 0) {
        data.push({
          ì¶”ê°€ìƒí’ˆëª…: "ì œí’ˆì„ íƒ",
          ì¶”ê°€ìƒí’ˆê°’: `${ìˆœë²ˆ}) ${item.ìƒí’ˆëª…} / ${color}`.trim(),
          ì¶”ê°€ìƒí’ˆê°€: item.íŒë§¤ê°€,
          ì¬ê³ ìˆ˜ëŸ‰: 99999,
          ì‚¬ìš©ì—¬ë¶€: "Y",
          ê´€ë¦¬ì½”ë“œ: item.ìƒí’ˆëª…
        });
      } else {
        ì‚¬ì´ì¦ˆëª©ë¡.forEach(size => {
          data.push({
            ì¶”ê°€ìƒí’ˆëª…: "ì œí’ˆì„ íƒ",
            ì¶”ê°€ìƒí’ˆê°’: `${ìˆœë²ˆ}) ${item.ìƒí’ˆëª…} / ${color}`.trim(),
            ì¶”ê°€ìƒí’ˆê°€: item.íŒë§¤ê°€,
            ì¬ê³ ìˆ˜ëŸ‰: 99999,
            ì‚¬ìš©ì—¬ë¶€: "Y",
            ê´€ë¦¬ì½”ë“œ: item.ìƒí’ˆëª…
          });
        });
      }
    });

    index++;
  });

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ì¶”ê°€ìƒí’ˆ");
  const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
  const safeName = (ëŒ€í‘œìƒí’ˆëª… || "ì¶”ê°€ìƒí’ˆ").replace(/[\\/:*?"<>|]/g, "").trim();
  saveAs(new Blob([wbout], { type: "application/octet-stream" }), `ì¶”ê°€ìƒí’ˆ_${safeName}.xls`);
}

// ë‹¨í’ˆë“±ë¡ìš© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ - ëŒ€í‘œìƒí’ˆë§Œ ìˆœë²ˆ ì—†ì´ ì¶œë ¥  
function downloadSingleProductExcel() {
  const rows = getDataFromTable().filter(r => !r.ì œì™¸);
  const ëŒ€í‘œ = rows.find(r => r.ëŒ€í‘œ) || rows[0];
  if (!ëŒ€í‘œ) return alert("ëŒ€í‘œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");

  const ìƒ‰ìƒëª©ë¡ = parseOptions(ëŒ€í‘œ.ìƒ‰ìƒ);
  const ì‚¬ì´ì¦ˆëª©ë¡ = expandSizes(ëŒ€í‘œ.ì‚¬ì´ì¦ˆ);
  const í’ˆì ˆì¡°í•© = parseOptions(ëŒ€í‘œ.í’ˆì ˆëœì¡°í•©);
  const ìƒí’ˆëª… = ëŒ€í‘œ["1ë²ˆ ìƒí’ˆëª…"] || ëŒ€í‘œ.ìƒí’ˆëª…;
  const mode = getOptionDisplayMode();

  const data = [];

  ìƒ‰ìƒëª©ë¡.forEach(color => {
    if (ì‚¬ì´ì¦ˆëª©ë¡.length === 0) {
      const í’ˆì ˆ = í’ˆì ˆì¡°í•©.includes(color);
      const row = {
        ì œí’ˆì„ íƒ: mode === "both" ? `${ìƒí’ˆëª…} / ${color}` : ìƒí’ˆëª…,
        ì˜µì…˜ê°€: 0,
        ì¬ê³ ìˆ˜ëŸ‰: í’ˆì ˆ ? 0 : 99999,
        ê´€ë¦¬ì½”ë“œ: ëŒ€í‘œ.ìƒí’ˆëª…,
        ì‚¬ìš©ì—¬ë¶€: "Y"
      };
      if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
      if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = ëŒ€í‘œ.ì‚¬ì´ì¦ˆ;
      data.push(row);
    } else {
      ì‚¬ì´ì¦ˆëª©ë¡.forEach(size => {
        const í’ˆì ˆ = í’ˆì ˆì¡°í•©.includes(color) || í’ˆì ˆì¡°í•©.includes(size) || í’ˆì ˆì¡°í•©.includes(`${color}-${size}`);
        const row = {
          ì œí’ˆì„ íƒ: mode === "both" ? `${ìƒí’ˆëª…} / ${color}` : ìƒí’ˆëª…,
          ì˜µì…˜ê°€: 0,
          ì¬ê³ ìˆ˜ëŸ‰: í’ˆì ˆ ? 0 : 99999,
          ê´€ë¦¬ì½”ë“œ: ëŒ€í‘œ.ìƒí’ˆëª…,
          ì‚¬ìš©ì—¬ë¶€: "Y"
        };
        if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
        if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = size;
        data.push(row);
      });
    }
  });

  const header = ["ì œí’ˆì„ íƒ"];
  if (mode === "colorOnly") header.push("ìƒ‰ìƒ");
  if (mode === "sizeOnly" || mode === "both") header.push("ì‚¬ì´ì¦ˆ");
  header.push("ì˜µì…˜ê°€", "ì¬ê³ ìˆ˜ëŸ‰", "ê´€ë¦¬ì½”ë“œ", "ì‚¬ìš©ì—¬ë¶€");

  const rowsArray = data.map(row => {
    const line = [row.ì œí’ˆì„ íƒ];
    if (mode === "colorOnly") line.push(row.ìƒ‰ìƒ);
    if (mode === "sizeOnly" || mode === "both") line.push(row.ì‚¬ì´ì¦ˆ);
    line.push(row.ì˜µì…˜ê°€, row.ì¬ê³ ìˆ˜ëŸ‰, row.ê´€ë¦¬ì½”ë“œ, row.ì‚¬ìš©ì—¬ë¶€);
    return line;
  });

  const ws = XLSX.utils.aoa_to_sheet([header, ...rowsArray]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ë‹¨í’ˆì˜µì…˜");
  const safeFileName = (ëŒ€í‘œ.ìƒí’ˆëª… || "ë‹¨í’ˆë“±ë¡").replace(/[\/:*?"<>|]/g, "").trim();
  const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
  saveAs(new Blob([wbout], { type: "application/octet-stream" }), `ë‹¨í’ˆë“±ë¡_${safeFileName}.xls`);
}

// ë‹¨í’ˆë“±ë¡ìš© ì „ì²´ ì—‘ì…€ ZIP ë‹¤ìš´ë¡œë“œ
function downloadSingleProductExcelAll() {
  const rows = getDataFromTable().filter(r => !r.ì œì™¸);
  if (rows.length === 0) return alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

  const mode = getOptionDisplayMode();
  const zip = new JSZip();
  const ìƒí’ˆê·¸ë£¹ = [...new Set(rows.map(r => r.ìƒí’ˆëª…))];

  ìƒí’ˆê·¸ë£¹.forEach(ìƒí’ˆëª… => {
    const ê·¸ë£¹ = rows.filter(r => r.ìƒí’ˆëª… === ìƒí’ˆëª…);
    const ëŒ€í‘œ = ê·¸ë£¹.find(r => r.ëŒ€í‘œ) || ê·¸ë£¹[0];
    const ìƒ‰ìƒëª©ë¡ = parseOptions(ëŒ€í‘œ.ìƒ‰ìƒ);
    const ì‚¬ì´ì¦ˆëª©ë¡ = expandSizes(ëŒ€í‘œ.ì‚¬ì´ì¦ˆ);
    const í’ˆì ˆì¡°í•© = parseOptions(ëŒ€í‘œ.í’ˆì ˆëœì¡°í•©);
    const ëŒ€í‘œìƒí’ˆëª… = ëŒ€í‘œ["1ë²ˆ ìƒí’ˆëª…"] || ëŒ€í‘œ.ìƒí’ˆëª…;

    const data = [];
    const ìƒ‰ìƒë°°ì—´ = ìƒ‰ìƒëª©ë¡.length > 0 ? ìƒ‰ìƒëª©ë¡ : [""];

    ìƒ‰ìƒë°°ì—´.forEach(color => {
      if (ì‚¬ì´ì¦ˆëª©ë¡.length === 0) {
        const í’ˆì ˆ = í’ˆì ˆì¡°í•©.includes(color);
        const row = {
          ì œí’ˆì„ íƒ: mode === "both" ? `${ëŒ€í‘œìƒí’ˆëª…} / ${color}` : ëŒ€í‘œìƒí’ˆëª…,
          ì˜µì…˜ê°€: 0,
          ì¬ê³ ìˆ˜ëŸ‰: í’ˆì ˆ ? 0 : 99999,
          ê´€ë¦¬ì½”ë“œ: ëŒ€í‘œ.ìƒí’ˆëª…,
          ì‚¬ìš©ì—¬ë¶€: "Y"
        };
        if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
        if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = ëŒ€í‘œ.ì‚¬ì´ì¦ˆ;
        data.push(row);
      } else {
        ì‚¬ì´ì¦ˆëª©ë¡.forEach(size => {
          const í’ˆì ˆ = í’ˆì ˆì¡°í•©.includes(color) || í’ˆì ˆì¡°í•©.includes(size) || í’ˆì ˆì¡°í•©.includes(`${color}-${size}`);
          const row = {
            ì œí’ˆì„ íƒ: mode === "both" ? `${ëŒ€í‘œìƒí’ˆëª…} / ${color}` : ëŒ€í‘œìƒí’ˆëª…,
            ì˜µì…˜ê°€: 0,
            ì¬ê³ ìˆ˜ëŸ‰: í’ˆì ˆ ? 0 : 99999,
            ê´€ë¦¬ì½”ë“œ: ëŒ€í‘œ.ìƒí’ˆëª…,
            ì‚¬ìš©ì—¬ë¶€: "Y"
          };
          if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
          if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = size;
          data.push(row);
        });
      }
    });

    const header = ["ì œí’ˆì„ íƒ"];
    if (mode === "colorOnly") header.push("ìƒ‰ìƒ");
    if (mode === "sizeOnly" || mode === "both") header.push("ì‚¬ì´ì¦ˆ");
    header.push("ì˜µì…˜ê°€", "ì¬ê³ ìˆ˜ëŸ‰", "ê´€ë¦¬ì½”ë“œ", "ì‚¬ìš©ì—¬ë¶€");

    const rowsArray = data.map(row => {
      const line = [row.ì œí’ˆì„ íƒ];
      if (mode === "colorOnly") line.push(row.ìƒ‰ìƒ);
      if (mode === "sizeOnly" || mode === "both") line.push(row.ì‚¬ì´ì¦ˆ);
      line.push(row.ì˜µì…˜ê°€, row.ì¬ê³ ìˆ˜ëŸ‰, row.ê´€ë¦¬ì½”ë“œ, row.ì‚¬ìš©ì—¬ë¶€);
      return line;
    });

    const ws = XLSX.utils.aoa_to_sheet([header, ...rowsArray]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ë‹¨í’ˆì˜µì…˜");
    const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
    const safeFileName = (ëŒ€í‘œ.ìƒí’ˆëª… || "ë‹¨í’ˆë“±ë¡").replace(/[\/:*?"<>|]/g, "").trim();
    zip.file(`ë‹¨í’ˆë“±ë¡_${safeFileName}.xls`, wbout);
  });

  zip.generateAsync({ type: "blob" }).then(content => {
    saveAs(content, "ë‹¨í’ˆë“±ë¡_ì „ì²´ë‹¤ìš´ë¡œë“œ.zip");
  });
}

// ìƒ‰ìƒ/ì‚¬ì´ì¦ˆ ë¶„ë¦¬ í•¨ìˆ˜
function parseOptions(input) {
  if (!input || typeof input !== 'string') return [];
  return input.split(/[,/]/).map(s => s.trim()).filter(Boolean);
}
// ì˜µì…˜ ë…¸ì¶œ ë°©ì‹ í™•ì¸ í•¨ìˆ˜
function getOptionDisplayMode() {
  const selected = document.querySelector('input[name="optionDisplay"]:checked');
  return selected ? selected.value : "both";
} 
// ì˜µì…˜ êµ¬ì„± ë°©ì‹ ì ìš© í•¨ìˆ˜
    function applyOptionMode(ì œí’ˆëª…, ìƒ‰ìƒ, ì‚¬ì´ì¦ˆ, ìƒí’ˆëª…, ìˆœë²ˆ) {
      const mode = getOptionDisplayMode();
      let ì œí’ˆì„ íƒê°’ = `${ìˆœë²ˆ}) ${ì œí’ˆëª…}`;
      let ìƒ‰ìƒì—´ = ìƒ‰ìƒ || "";
      let ì‚¬ì´ì¦ˆì—´ = ì‚¬ì´ì¦ˆ || "";

      if (mode === "colorOnly") {
        return { ì œí’ˆì„ íƒ: ì œí’ˆì„ íƒê°’, ìƒ‰ìƒ: ìƒ‰ìƒì—´ };
      } else if (mode === "sizeOnly") {
        return ì‚¬ì´ì¦ˆ
          ? { ì œí’ˆì„ íƒ: ì œí’ˆì„ íƒê°’, ì‚¬ì´ì¦ˆ: ì‚¬ì´ì¦ˆì—´ }
          : { ì œí’ˆì„ íƒ: ì œí’ˆì„ íƒê°’ };
      } else {
        ì œí’ˆì„ íƒê°’ += ìƒ‰ìƒ ? ` / ${ìƒ‰ìƒ}` : "";
        return ì‚¬ì´ì¦ˆ
          ? { ì œí’ˆì„ íƒ: ì œí’ˆì„ íƒê°’, ì‚¬ì´ì¦ˆ: ì‚¬ì´ì¦ˆì—´ }
          : { ì œí’ˆì„ íƒ: ì œí’ˆì„ íƒê°’ };
      }
    }
function expandSizes(sizeStr) {
  if (!sizeStr || typeof sizeStr !== 'string') return [];

  // ì‰¼í‘œ ë˜ëŠ” ìŠ¬ë˜ì‹œë¡œ êµ¬ë¶„ëœ ê²½ìš°
  if (sizeStr.includes(',') || sizeStr.includes('/')) {
    return sizeStr.split(/[,/]/).map(s => s.trim()).filter(Boolean);
  }

  // ë²”ìœ„ (ì˜ˆ: 230~240) ì²˜ë¦¬
  const rangeMatch = sizeStr.match(/^(\d{3})~(\d{3})$/);
  if (rangeMatch) {
    const start = parseInt(rangeMatch[1]);
    const end = parseInt(rangeMatch[2]);
    const step = 5;
    const result = [];
    for (let i = start; i <= end; i += step) {
      result.push(i.toString());
    }
    return result;
  }

  return [sizeStr.trim()];
}

  </script>
</body>
</html>
