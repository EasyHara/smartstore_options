<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>스마트스토어 옵션 자동 생성기</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input[type='text'], input[type='number'] { width: 100%; box-sizing: border-box; }
    .center { text-align: center; }
    button { padding: 10px 20px; margin-top: 20px; margin-right: 10px; }
    .top-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .options-bar { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>스마트스토어 옵션 자동 생성기</h2>
  <div class="top-bar">
    <input type="file" id="excelFile" accept=".xlsx" />
    <button onclick="downloadTemplate()">엑셀 양식 다운로드</button>
  </div>
  <div class="options-bar">
    <label><input type="checkbox" id="appendColorToName"> 상품명+색상</label>
  </div>
  <table id="inputTable">
    <thead>
      <tr>
        <th>대표</th>
        <th>상품명</th>
        <th>판매가</th>
        <th>색상(콤마 또는 /)</th>
        <th>사이즈(콤마 또는 /)</th>
        <th>1번 상품명</th>
        <th>품절된 색상 입력</th>
        <th>품절된 사이즈 입력</th>
        <th>제외</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="addRow()">+ 행 추가</button>
  <button onclick="generateExcel()">현재 대표기준 엑셀 다운로드</button>
  <button onclick="generateAllMainExcel()">일괄 엑셀 다운로드</button>

  <script>
    function addRow(data = {}) {
      const table = document.querySelector("#inputTable tbody");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="center"><input type="radio" name="mainItem" ${data.대표여부 === 'O' ? 'checked' : ''}></td>
        <td><input type="text" value="${data.상품명 || ''}"></td>
        <td><input type="number" value="${data.판매가 || ''}"></td>
        <td><input type="text" value="${data.색상 || ''}"></td>
        <td><input type="text" value="${data.사이즈 || ''}"></td>
        <td><input type="text" value="${data['1번 상품명'] || ''}"></td>
        <td><input type="text" value="${data['품절된 색상 입력'] || ''}"></td>
        <td><input type="text" value="${data['품절된 사이즈 입력'] || ''}"></td>
        <td class="center"><input type="checkbox" ${data.제외 === 'Y' ? 'checked' : ''}></td>
      `;
      table.appendChild(row);
    }

    function generateExcel(selectedMainIndex = null) {
      const rows = document.querySelectorAll("#inputTable tbody tr");
      let mainPrice = 0;
      let mainName = "";
      let filenameBase = "smartstore_options";
      let groupOutput = [];
      const appendColor = document.getElementById("appendColorToName").checked;

      if (selectedMainIndex === null) {
        rows.forEach((row, index) => {
          if (row.cells[0].querySelector("input").checked) {
            selectedMainIndex = index;
          }
        });
      }

      const rowMain = rows[selectedMainIndex];
      mainPrice = parseInt(rowMain.cells[2].querySelector("input").value) || 0;
      mainName = rowMain.cells[1].querySelector("input").value.trim();
      filenameBase = mainName;

      const makeOptionGroup = (row, isMain) => {
        const productName = row.cells[1].querySelector("input").value.trim();
        const price = parseInt(row.cells[2].querySelector("input").value) || 0;
        const colors = row.cells[3].querySelector("input").value.trim().split(/[,/]/);
        const sizes = row.cells[4].querySelector("input").value.trim().split(/[,/]/);
        const altName = row.cells[5].querySelector("input").value.trim();
        const soldOutColors = row.cells[6].querySelector("input").value.trim().split(/[,/]/).map(v => v.toString().trim());
        const soldOutSizes = row.cells[7].querySelector("input").value.trim().split(/[,/]/).map(v => v.toString().trim());
        const displayName = isMain ? altName : productName;

        let options = [];
        colors.forEach(color => {
          sizes.forEach(size => {
            const colorTrimmed = color.toString().trim();
            const sizeTrimmed = size.toString().trim();
            const isSoldOut = soldOutColors.includes(colorTrimmed) || soldOutSizes.includes(sizeTrimmed);
            const fullName = appendColor ? `${displayName} / ${colorTrimmed}` : displayName;
            options.push({
              displayName: fullName,
              색상: appendColor ? undefined : colorTrimmed,
              사이즈: sizeTrimmed,
              옵션가: isMain ? 0 : price - mainPrice,
              재고수량: isSoldOut ? 0 : 99999,
              관리코드: productName,
              사용여부: "Y"
            });
          });
        });
        return { name: displayName, options };
      };

      const allGroups = [];
      rows.forEach((row, index) => {
        if (row.cells[8].querySelector("input").checked) return;
        const isMain = index === selectedMainIndex;
        const group = makeOptionGroup(row, isMain);
        if (isMain) {
          allGroups.unshift(group);
        } else {
          allGroups.push(group);
        }
      });

      let count = 1;
      const finalOutput = [];
      allGroups.forEach(group => {
        const prefix = `${String(count).padStart(2, '0')}) `;
        group.options.forEach(opt => {
          const item = {
            제품선택: prefix + opt.displayName,
            사이즈: opt.사이즈,
            옵션가: opt.옵션가,
            재고수량: opt.재고수량,
            관리코드: opt.관리코드,
            사용여부: opt.사용여부
          };
          if (!appendColor) item["색상"] = opt.색상;
          finalOutput.push(item);
        });
        count++;
      });

      const ws = XLSX.utils.json_to_sheet(finalOutput);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "옵션데이터");
      const safeFilename = filenameBase.replace(/[\\/:*?"<>|]/g, "_").slice(0, 50);
      const filename = `${safeFilename}.xls`;
      XLSX.writeFile(wb, filename);
    }

    function generateAllMainExcel() {
      const rows = document.querySelectorAll("#inputTable tbody tr");
      rows.forEach((_, index) => {
        generateExcel(index);
      });
    }

    function downloadTemplate() {
      const headers = [
        "상품명", "판매가", "색상", "사이즈", "1번 상품명", "품절된 색상 입력", "품절된 사이즈 입력"
      ];
      const ws = XLSX.utils.aoa_to_sheet([headers]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "양식");
      XLSX.writeFile(wb, "smartstore_template.xlsx");
    }

    document.getElementById("excelFile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        const tbody = document.querySelector("#inputTable tbody");
        tbody.innerHTML = "";
        jsonData.forEach(row => addRow(row));
      };
      reader.readAsArrayBuffer(file);
    });

    addRow();
  </script>
</body>
</html>
