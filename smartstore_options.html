<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>스마트스토어 옵션 자동 생성기</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input[type='text'], input[type='number'] { width: 100%; box-sizing: border-box; }
    .top-bar, .button-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    #inputTable-container { max-height: 500px; overflow-y: auto; margin-bottom: 20px; }
    .section { margin-top: 30px; }
    .hidden { display: none; }
    .right-align { text-align: right; }
  </style>
</head>
<body>
  <h2>스마트스토어 옵션 자동 생성기</h2>
  <div class="top-bar">
    <input type="file" id="excelFile" accept=".xlsx" />
    <button onclick="downloadTemplate()">엑셀 양식 다운로드</button>
    <button onclick="addRow()">+ 행 추가</button>
    <button onclick="clearAll()">초기화</button>
    <label><input type="checkbox" id="combineColor"> 상품명+색상</label>
    <button onclick="generateExcel()">현재 대표기준 엑셀 다운로드</button>
    <button onclick="generateAllMainExcelZip()">일괄 엑셀 다운로드 (ZIP)</button>
  </div>
  <div id="inputTable-container">
    <table id="inputTable">
      <thead>
        <tr>
          <th>대표</th>
          <th>상품명</th>
          <th>판매가</th>
          <th>색상</th>
          <th>사이즈</th>
          <th>1번 상품명</th>
          <th>품절된 색상 입력</th>
          <th>품절된 사이즈 입력</th>
          <th>제외</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
<div class="button-bar">
<input id="templateTitle" placeholder="양식 제목 입력" type="text"/>
<button onclick="saveTemplateByTitle()">제목으로 저장</button>
<button onclick="deleteSelectedTemplates()" style="margin-left:auto">선택된 양식 삭제</button>
</div>
<div class="section">
<h3>저장된 양식 목록</h3>
<table id="templateList">
<thead>
<tr>
<th>선택</th><th>제목</th><th>메모</th><th>생성일</th><th>수정일</th><th>작업</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="right-align" style="margin-top: 20px;">
<button onclick="openTrash()">휴지통 바로가기</button>
</div>

<div class="section hidden" id="trashSection">
<h3>휴지통</h3>
<div id="trashList"></div>
</div>
<script>
const tableBody = document.querySelector('#inputTable tbody');

function addRow(data = {}) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="radio" name="main"></td>
    <td><input type="text" value="${data['상품명'] || ''}"></td>
    <td><input type="number" value="${data['판매가'] || ''}"></td>
    <td><input type="text" value="${data['색상'] || ''}"></td>
    <td><input type="text" value="${data['사이즈'] || ''}"></td>
    <td><input type="text" value="${data['1번 상품명'] || ''}"></td>
    <td><input type="text" value="${data['품절된 색상 입력'] || ''}"></td>
    <td><input type="text" value="${data['품절된 사이즈 입력'] || ''}"></td>
    <td><input type="checkbox" ${data['제외'] ? 'checked' : ''}></td>
  `;
  tableBody.appendChild(tr);
}

function clearAll() {
  tableBody.innerHTML = '';
}

function downloadTemplate() {
  const ws_data = [['상품명', '판매가', '색상', '사이즈', '1번 상품명', '품절된 색상 입력', '품절된 사이즈 입력']];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, '양식');
  XLSX.writeFile(wb, 'smartstore_template.xlsx');
}

function generateExcel() {
  const rows = [...document.querySelectorAll("#inputTable tbody tr")];
  const wb = XLSX.utils.book_new();
  const wsData = [["제품선택", "색상", "사이즈", "옵션가", "재고수량", "관리코드", "사용여부"]];
  let order = 1;
  const isCombineColor = document.getElementById("combineColor").checked;
  let mainProductIndex = rows.findIndex(row => row.querySelector("input[type='radio']")?.checked);
  if (mainProductIndex === -1) {
    alert("대표 상품을 선택하세요.");
    return;
  }
  const mainRow = rows[mainProductIndex];
  const mainName = mainRow.querySelectorAll("input[type='text']")[0]?.value;
  const mainPrice = parseInt(mainRow.querySelectorAll("input[type='text']")[1]?.value) || 0;

  rows.forEach((row, i) => {
    if (row.querySelector("input[type='checkbox']")?.checked) return;
    const tds = row.querySelectorAll("input[type='text']");
    const isMain = i === mainProductIndex;
    const productName = tds[0].value;
    const price = parseInt(tds[1].value) || 0;
    const colors = tds[2].value.split(/[,/]/).map(c => c.trim()).filter(Boolean);
    const sizes = tds[3].value.split(/[,/]/).map(s => s.trim()).filter(Boolean);
    const soldOutColors = tds[5].value.split(/[,/]/).map(c => c.trim());
    const soldOutSizes = tds[6].value.split(/[,/]/).map(s => s.trim());

    colors.forEach(color => {
      sizes.forEach(size => {
        const code = `${String(order).padStart(2, '0')}) ${isCombineColor ? `${productName} / ${color}` : productName}`;
        const optionPrice = isMain ? 0 : price - mainPrice;
        const stock = soldOutColors.includes(color) || soldOutSizes.includes(size) ? 0 : 99999;
        wsData.push([code, isCombineColor ? '' : color, size, optionPrice, stock, productName, 'Y']);
      });
    });
    order++;
  });

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "옵션");
  XLSX.writeFile(wb, `${mainName}.xlsx`);
}

    function generateAllMainExcelZip() {
      const zip = new JSZip();
      const rows = [...tableBody.querySelectorAll('tr')];
      const dataList = rows.map((tr, i) => {
        const inputs = tr.querySelectorAll('input');
        return {
          대표: inputs[0].checked,
          제외: inputs[inputs.length - 1].checked,
          값: [...inputs].slice(1, -1).map(input => input.value),
          상품명: inputs[1].value || `상품${i+1}`
        };
      });

      dataList.forEach((data, idx) => {
        if (data.제외) return;
        const ws_data = [['상품명', '판매가', '색상', '사이즈', '1번 상품명', '품절된 색상 입력', '품절된 사이즈 입력']];
        ws_data.push(data.값);
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, '옵션');
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
        zip.file(`${String(idx + 1).padStart(2, '0')}_${data.상품명}.xls`, s2ab(wbout));
      });

      zip.generateAsync({ type: 'blob' }).then(content => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = '일괄_옵션_엑셀.zip';
        a.click();
      });
    }

    function s2ab(s) {
      const buf = new ArrayBuffer(s.length);
      const view = new Uint8Array(buf);
      for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
      return buf;
    }

// 전체 코드가 길어져 분할 처리합니다. 이전 코드에 이어 붙여서 사용하세요.

// --- 저장 및 불러오기 ---
function saveTemplate() {
  const title = document.getElementById('templateTitle').value.trim();
  if (!title) return alert('제목을 입력해주세요.');
  if (tableBody.children.length === 0) return alert('빈 양식은 저장할 수 없습니다.');

  const data = [...tableBody.querySelectorAll('tr')].map(tr => {
    const tds = tr.querySelectorAll('input');
    return {
      '대표': tds[0].checked,
      '상품명': tds[1].value,
      '판매가': tds[2].value,
      '색상': tds[3].value,
      '사이즈': tds[4].value,
      '1번 상품명': tds[5].value,
      '품절된 색상 입력': tds[6].value,
      '품절된 사이즈 입력': tds[7].value,
      '제외': tds[8].checked
    };
  });
  const now = new Date().toISOString();
  const template = { title, data, created: now, updated: now };
  localStorage.setItem('template_' + title, JSON.stringify(template));
  loadTemplates();
}

function loadTemplates() {
  const list = document.getElementById('templateList');
  list.innerHTML = '';
  Object.keys(localStorage).filter(k => k.startsWith('template_')).forEach(key => {
    const { title, created, updated } = JSON.parse(localStorage.getItem(key));
    const div = document.createElement('div');
    div.className = 'saved-template';
    div.innerHTML = `
      <span><input type="checkbox" value="${key}" /> <strong>${title}</strong><br><small>생성: ${formatTime(created)} | 수정: ${formatTime(updated)}</small></span>
      <button onclick="loadTemplate('${key}')">불러오기</button>
    `;
    list.appendChild(div);
  });
}

function loadTemplate(key) {
  const { title, data } = JSON.parse(localStorage.getItem(key));
  document.getElementById('templateTitle').value = title;
  clearAll();
  data.forEach(row => addRow(row));
}

function deleteSelectedTemplates() {
  const checked = [...document.querySelectorAll('#templateList input[type=checkbox]:checked')];
  if (checked.length === 0) return alert('삭제할 항목을 선택해주세요.');
  if (!confirm('정말 삭제하시겠습니까?')) return;
  checked.forEach(chk => {
    const key = chk.value;
    const trash = JSON.parse(localStorage.getItem(key));
    trash.deletedAt = new Date().toISOString();
    localStorage.setItem('trash_' + key, JSON.stringify(trash));
    localStorage.removeItem(key);
  });
  loadTemplates();
}

function openTrash() {
  const section = document.getElementById('trashSection');
  section.classList.toggle('hidden');
  const list = document.getElementById('trashList');
  list.innerHTML = '';
  const now = new Date();
  const trashItems = Object.keys(localStorage).filter(k => k.startsWith('trash_template_'));
  if (trashItems.length === 0) return alert('휴지통이 비어있습니다.');
  trashItems.forEach(key => {
    const item = JSON.parse(localStorage.getItem(key));
    const deletedAt = new Date(item.deletedAt);
    const remainingDays = 7 - Math.floor((now - deletedAt) / (1000 * 60 * 60 * 24));
    if (remainingDays <= 0) {
      localStorage.removeItem(key);
      return;
    }
    const div = document.createElement('div');
    div.className = 'saved-template';
    div.innerHTML = `
      <span><strong>${item.title}</strong><br><small>삭제됨 - ${formatTime(item.deletedAt)} (남은 ${remainingDays}일)</small></span>
      <button onclick="restoreTemplate('${key}')">복원</button>
    `;
    list.appendChild(div);
  });
}

function restoreTemplate(key) {
  const item = JSON.parse(localStorage.getItem(key));
  localStorage.setItem(key.replace('trash_', ''), JSON.stringify(item));
  localStorage.removeItem(key);
  openTrash();
  loadTemplates();
}

function formatTime(str) {
  const d = new Date(str);
  return `${d.getFullYear()}. ${d.getMonth() + 1}. ${d.getDate()} ${d.getHours()}:${('0' + d.getMinutes()).slice(-2)}`;
}

window.onload = loadTemplates;

  </script>
<script>
const tableBody = document.querySelector('#inputTable tbody');

function addRow(data = {}) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="radio" name="main"></td>
    <td><input type="text" value="${data['상품명'] || ''}"></td>
    <td><input type="number" value="${data['판매가'] || ''}"></td>
    <td><input type="text" value="${data['색상'] || ''}"></td>
    <td><input type="text" value="${data['사이즈'] || ''}"></td>
    <td><input type="text" value="${data['1번 상품명'] || ''}"></td>
    <td><input type="text" value="${data['품절된 색상 입력'] || ''}"></td>
    <td><input type="text" value="${data['품절된 사이즈 입력'] || ''}"></td>
    <td><input type="checkbox" ${data['제외'] ? 'checked' : ''}></td>
  `;
  tableBody.appendChild(tr);
}

function clearAll() {
  tableBody.innerHTML = '';
}

document.getElementById('excelFile').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
    clearAll();
    json.forEach(row => addRow(row));
  };
  reader.readAsArrayBuffer(file);
});

function generateExcel() {
  const rows = [...tableBody.querySelectorAll('tr')];
  const wb = XLSX.utils.book_new();
  const wsData = [['제품선택', '색상', '사이즈', '옵션가', '재고수량', '관리코드', '사용여부']];

  const mainRow = rows.find(row => row.querySelector('input[type="radio"]')?.checked);
  if (!mainRow) return alert('대표 상품을 선택하세요.');

  const mainInputs = mainRow.querySelectorAll('input');
  const basePrice = parseInt(mainInputs[2].value) || 0;
  const baseName = mainInputs[5].value || mainInputs[1].value || '대표상품';

  let order = 1;
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    if (inputs[8].checked) return;
    const isMain = inputs[0].checked;
    const 상품명 = inputs[1].value;
    const 판매가 = parseInt(inputs[2].value) || 0;
    const 색상 = inputs[3].value.split(/[,/]/).map(s => s.trim()).filter(Boolean);
    const 사이즈 = inputs[4].value.split(/[,/]/).map(s => s.trim()).filter(Boolean);
    const 일번 = inputs[5].value;
    const 품절색 = inputs[6].value.split(/[,/]/).map(s => s.trim());
    const 품절사이즈 = inputs[7].value.split(/[,/]/).map(s => s.trim());

    색상.forEach(color => {
      사이즈.forEach(size => {
        const 재고 = (품절색.includes(color) || 품절사이즈.includes(size)) ? 0 : 99999;
        const 옵션가 = isMain ? 0 : 판매가 - basePrice;
        const 이름 = `${String(order).padStart(2, '0')}) ${isMain ? 일번 : 상품명} / ${color}`;
        wsData.push([이름, color, size, 옵션가, 재고, 상품명, 'Y']);
      });
    });
    order++;
  });

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, '옵션');
  XLSX.writeFile(wb, `${baseName}.xls`);
}
</script></body>
</html>
