<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>스마트스토어 옵션 자동 생성기</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input[type='text'], input[type='number'] { width: 100%; box-sizing: border-box; }
    .top-bar, .button-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    #inputTable-container { max-height: 500px; overflow-y: auto; margin-bottom: 20px; }
    .section { margin-top: 30px; }
    .hidden { display: none; }
    .saved-template { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #ccc; }
    .saved-template span { flex: 1; }
    .right-align { text-align: right; }
  </style>
</head>
<body>
  <h2>스마트스토어 옵션 자동 생성기</h2>

  <div class="top-bar">
    <input type="file" id="excelFile" accept=".xlsx" />
    <button onclick="downloadTemplate()">엑셀 양식 다운로드</button>
    <button onclick="addRow()">+ 행 추가</button>
    <button onclick="clearAll()">초기화</button>
    <label><input type="checkbox" id="combineNameColor" /> 상품명+색상</label>
    <button onclick="generateExcel()">현재 대표기준 엑셀 다운로드</button>
    <button onclick="generateAllMainExcelZip()">일괄 엑셀 다운로드 (ZIP)</button>
  </div>

  <div id="inputTable-container">
    <table id="inputTable">
      <thead>
        <tr>
          <th>대표</th>
          <th>상품명</th>
          <th>판매가</th>
          <th>색상</th>
          <th>사이즈</th>
          <th>1번 상품명</th>
          <th>품절된 조합 입력<br>(색상/사이즈)</th>
          <th>제외</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
function generateExcel() {
  const rows = [...document.querySelectorAll("#inputTable tbody tr")];
  const wb = XLSX.utils.book_new();
  const wsData = [["제품선택", "색상", "사이즈", "옵션가", "재고수량", "관리코드", "사용여부"]];
  const combine = document.getElementById("combineNameColor").checked;

  let order = 1;
  const nameMap = new Map();
  const mainIndex = rows.findIndex(row => row.querySelector("input[type='radio']")?.checked);
  if (mainIndex === -1) return alert("대표 상품을 선택하세요.");

  const mainRow = rows[mainIndex];
  const mainInputs = mainRow.querySelectorAll("input[type='text'], input[type='number']");
  const mainName = mainInputs[0].value;
  const mainPrice = parseInt(mainInputs[1].value) || 0;
  const main1Name = mainInputs[4].value;

  rows.forEach((row, idx) => {
    const inputs = row.querySelectorAll("input[type='text'], input[type='number']");
    const exclude = row.querySelector("input[type='checkbox']")?.checked;
    const isMain = row.querySelector("input[type='radio']")?.checked;

    if (exclude) return;

    const product = inputs[0].value;
    const price = parseInt(inputs[1].value) || 0;
    const colors = inputs[2].value.split(/[,/]/).map(v => v.trim()).filter(Boolean);
    const sizes = inputs[3].value.split(/[,/]/).map(v => v.trim()).filter(Boolean);
    const oneName = inputs[4].value;
    const soldOutCombos = inputs[5].value.split(/\s+/).map(v => v.trim()).filter(Boolean);

    if (!nameMap.has(product)) nameMap.set(product, String(order++).padStart(2, '0'));

    const prefix = nameMap.get(product);
    const title = isMain ? main1Name : product;

    colors.forEach(color => {
      sizes.forEach(size => {
        const isSoldOut = soldOutCombos.includes(`${color}/${size}`);
        const optionName = `${prefix}) ${combine ? `${title} / ${color}` : title}`;
        const optionPrice = isMain ? 0 : price - mainPrice;
        const stock = isSoldOut ? 0 : 99999;
        wsData.push([optionName, color, size, optionPrice, stock, product, 'Y']);
      });
    });
  });

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "옵션");
  XLSX.writeFile(wb, `${mainName}.xls`);
}

function generateAllMainExcelZip() {
  const zip = new JSZip();
  const rows = [...document.querySelectorAll("#inputTable tbody tr")];
  const combine = document.getElementById("combineNameColor").checked;

  let order = 1;
  const nameMap = new Map();

  rows.forEach((row, idx) => {
    const inputs = row.querySelectorAll("input[type='text'], input[type='number']");
    const exclude = row.querySelector("input[type='checkbox']")?.checked;
    if (exclude) return;

    const product = inputs[0].value;
    const price = parseInt(inputs[1].value) || 0;
    const colors = inputs[2].value.split(/[,/]/).map(v => v.trim()).filter(Boolean);
    const sizes = inputs[3].value.split(/[,/]/).map(v => v.trim()).filter(Boolean);
    const oneName = inputs[4].value;
    const soldOutCombos = inputs[5].value.split(/\s+/).map(v => v.trim()).filter(Boolean);

    if (!nameMap.has(product)) nameMap.set(product, String(order++).padStart(2, '0'));
    const prefix = nameMap.get(product);

    const wsData = [["제품선택", "색상", "사이즈", "옵션가", "재고수량", "관리코드", "사용여부"]];
    colors.forEach(color => {
      sizes.forEach(size => {
        const isSoldOut = soldOutCombos.includes(`${color}/${size}`);
        const optionName = `${prefix}) ${combine ? `${product} / ${color}` : product}`;
        const stock = isSoldOut ? 0 : 99999;
        wsData.push([optionName, color, size, 0, stock, product, 'Y']);
      });
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "옵션");
    const buffer = XLSX.write(wb, { bookType: "xls", type: "binary" });

    zip.file(`${product}.xls`, new Blob([s2ab(buffer)]));
  });

  zip.generateAsync({ type: "blob" }).then(content => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(content);
    a.download = "옵션_일괄.zip";
    a.click();
  });
}

function s2ab(s) {
  const buf = new ArrayBuffer(s.length);
  const view = new Uint8Array(buf);
  for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xff;
  return buf;
}
</script>
</body>
</html>
