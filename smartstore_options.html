<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>스마트스토어 옵션 자동 생성기</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f8f9fa; color: #212529; }
    h1 { font-size: 24px; }
    button, input[type="file"] { margin: 5px 0; padding: 8px 12px; font-size: 16px; }
    textarea { width: 100%; height: 150px; margin-top: 10px; font-family: monospace; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    label { display: flex; align-items: center; margin-top: 10px; }
    input[type="checkbox"] { margin-right: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>📃 스마트스토어 옵션 자동 생성기</h1>
    <input type="file" id="inputFile" accept=".xls,.xlsx" /><br/>
    <label><input type="checkbox" id="combineNameColor"> 상품명+색상 조합으로 제품선택 표시</label>
    <label><input type="checkbox" id="excludeItem"> 제외 상품 제외하고 출력</label>
    <button onclick="generateFiles()">엑셀 옵션 생성 및 ZIP 다운로드</button>
    <textarea id="pasteArea" placeholder="엑셀에서 복사한 데이터 붙여넣기 (선택사항)"></textarea>
  </div>
  <script>
    function generateFiles() {
      const combineNameColor = document.getElementById('combineNameColor').checked;
      const excludeItem = document.getElementById('excludeItem').checked;
      const fileInput = document.getElementById('inputFile').files[0];
      const pastedText = document.getElementById('pasteArea').value.trim();

      const processWorkbook = (workbook) => {
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        const grouped = {};
        json.forEach(row => {
          if (!grouped[row["1번 상품명"]]) grouped[row["1번 상품명"]] = [];
          grouped[row["1번 상품명"]].push(row);
        });

        const zip = new JSZip();

        Object.entries(grouped).forEach(([groupKey, items], i) => {
          const repItem = items.find(item => item["1번 상품명"] == groupKey);
          const repPrice = parseInt(repItem["판매가"]);
          const repName = repItem["상품명"];

          let data = [];
          let order = 1;

          items.forEach((item, idx) => {
            const colorList = String(item["색상"] || '').replace(/\//g, ',').split(',');
            const sizeList = String(item["사이즈"] || '').replace(/\//g, ',').split(',');
            const isRepresentative = (item["1번 상품명"] == groupKey);
            const exclude = (excludeItem && item["제외"] == 'Y');
            if (exclude) return;

            const prefix = (order < 10 ? `0${order}` : order);
            const optionName = `${prefix}) ${combineNameColor ? `${item["상품명"]} / ` : ''}`;

            colorList.forEach(color => {
              sizeList.forEach(size => {
                let 옵션가 = isRepresentative ? 0 : (parseInt(item["판매가"]) - repPrice);
                let 품절 = (String(item["품절된 조합"] || '').includes(`${color}/${size}`));
                data.push({
                  제품선택: `${optionName}${color}`,
                  색상: color,
                  사이즈: size,
                  옵션가: 옵션가,
                  재고수량: 품절 ? 0 : 99999,
                  관리코드: item["상품명"],
                  사용여부: 'Y'
                });
              });
            });
            order++;
          });

          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "옵션데이터");
          const wbout = XLSX.write(wb, {bookType:'xls', type:'array'});
          zip.file(`${repName}.xls`, wbout);
        });

        zip.generateAsync({type:"blob"}).then(content => {
          saveAs(content, "옵션_자동생성.zip");
        });
      };

      if (fileInput) {
        const reader = new FileReader();
        reader.onload = e => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          processWorkbook(workbook);
        };
        reader.readAsArrayBuffer(fileInput);
      } else if (pastedText) {
        const rows = pastedText.split("\n").map(r => r.split("\t"));
        const headers = rows[0];
        const body = rows.slice(1);
        const json = body.map(row => Object.fromEntries(row.map((cell, i) => [headers[i], cell])));
        const ws = XLSX.utils.json_to_sheet(json);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "상품옵션");
        processWorkbook(wb);
      } else {
        alert("엑셀 파일을 선택하거나 데이터를 붙여넣어 주세요.");
      }
    }
  </script>
</body>
</html>
