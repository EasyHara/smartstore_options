<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>스마트스토어 옵션 자동 생성기</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input[type='text'], input[type='number'] { width: 100%; box-sizing: border-box; }
    .center { text-align: center; }
    button { padding: 10px 20px; margin-right: 10px; }
    .top-bar, .options-bar, .save-bar, .button-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .save-bar { margin-top: 20px; }
    .template-list { margin-top: 10px; border: 1px solid #ccc; padding: 10px; }
    .template-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <h2>스마트스토어 옵션 자동 생성기</h2>

  <div class="top-bar">
    <input type="file" id="excelFile" accept=".xlsx" />
    <button onclick="downloadTemplate()">엑셀 양식 다운로드</button>
  </div>

  <div class="options-bar">
    <label><input type="checkbox" id="appendColorToName"> 상품명+색상</label>
    <button onclick="addRow()">+ 행 추가</button>
    <button onclick="clearAllRows()">초기화</button>
  </div>

  <table id="inputTable">
    <thead>
      <tr>
        <th>대표</th>
        <th>상품명</th>
        <th>판매가</th>
        <th>색상(콤마 또는 /)</th>
        <th>사이즈(콤마 또는 /)</th>
        <th>1번 상품명</th>
        <th>품절된 색상 입력</th>
        <th>품절된 사이즈 입력</th>
        <th>제외</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="button-bar">
    <button onclick="generateExcel()">현재 대표기준 엑셀 다운로드</button>
    <button onclick="generateAllMainExcelZip()">일괄 엑셀 다운로드 (ZIP)</button>
  </div>

  <div class="save-bar">
    <input type="text" id="templateTitle" placeholder="양식 제목 입력" style="flex:1">
    <button onclick="saveTemplate()">제목으로 저장</button>
  </div>

  <div class="template-list" id="templateList"></div>

  <script>
    const templateStorageKey = 'smartstore_templates';

    function saveTemplate() {
      const title = document.getElementById('templateTitle').value.trim();
      if (!title) return alert('제목을 입력해주세요.');

      const rows = Array.from(document.querySelectorAll('#inputTable tbody tr'));
      if (rows.length === 0) return alert('입력된 데이터가 없습니다.');

      const data = rows.map(row => {
        return {
          대표여부: row.cells[0].querySelector('input').checked ? 'O' : '',
          상품명: row.cells[1].querySelector('input').value,
          판매가: row.cells[2].querySelector('input').value,
          색상: row.cells[3].querySelector('input').value,
          사이즈: row.cells[4].querySelector('input').value,
          '1번 상품명': row.cells[5].querySelector('input').value,
          '품절된 색상 입력': row.cells[6].querySelector('input').value,
          '품절된 사이즈 입력': row.cells[7].querySelector('input').value,
          제외: row.cells[8].querySelector('input').checked ? 'Y' : ''
        };
      });

      const hasContent = data.some(d => d.상품명 || d.판매가 || d.색상 || d.사이즈);
      if (!hasContent) return alert('내용이 없는 양식은 저장할 수 없습니다.');

      const now = new Date();
      const templates = JSON.parse(localStorage.getItem(templateStorageKey) || '{}');
      const existing = templates[title];
      templates[title] = {
        data,
        created: existing?.created || now.toISOString(),
        modified: now.toISOString()
      };
      localStorage.setItem(templateStorageKey, JSON.stringify(templates));
      updateTemplateList();
      alert('저장되었습니다.');
    }

    function updateTemplateList() {
      const container = document.getElementById('templateList');
      const templates = JSON.parse(localStorage.getItem(templateStorageKey) || '{}');
      container.innerHTML = '<b>저장된 양식 목록</b>';

      Object.entries(templates).forEach(([title, info]) => {
        const item = document.createElement('div');
        item.className = 'template-item';
        item.innerHTML = `
          <div>
            <b>${title}</b><br>
            <small>생성: ${new Date(info.created).toLocaleString()} | 수정: ${new Date(info.modified).toLocaleString()}</small>
          </div>
          <button onclick="loadTemplate('${title}')">불러오기</button>
        `;
        container.appendChild(item);
      });
    }

    function loadTemplate(title) {
      const templates = JSON.parse(localStorage.getItem(templateStorageKey) || '{}');
      const data = templates[title]?.data;
      if (!data) return alert('불러오기 실패');
      const tbody = document.querySelector('#inputTable tbody');
      tbody.innerHTML = '';
      data.forEach(row => addRow(row));
    }

    function clearAllRows() {
      const tbody = document.querySelector('#inputTable tbody');
      tbody.innerHTML = '';
    }

    document.getElementById("excelFile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        const tbody = document.querySelector("#inputTable tbody");
        tbody.innerHTML = "";
        jsonData.forEach(row => addRow(row));
      };
      reader.readAsArrayBuffer(file);
    });

    function addRow(data = {}) {
      const table = document.querySelector("#inputTable tbody");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="center"><input type="radio" name="mainItem" ${data.대표여부 === 'O' ? 'checked' : ''}></td>
        <td><input type="text" value="${data.상품명 || ''}"></td>
        <td><input type="number" value="${data.판매가 || ''}"></td>
        <td><input type="text" value="${data.색상 || ''}"></td>
        <td><input type="text" value="${data.사이즈 || ''}"></td>
        <td><input type="text" value="${data['1번 상품명'] || ''}"></td>
        <td><input type="text" value="${data['품절된 색상 입력'] || ''}"></td>
        <td><input type="text" value="${data['품절된 사이즈 입력'] || ''}"></td>
        <td class="center"><input type="checkbox" ${data.제외 === 'Y' ? 'checked' : ''}></td>
      `;
      table.appendChild(row);
    }

    updateTemplateList();
    addRow();
  </script>
</body>
</html>
