<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ìë™ ìƒì„±ê¸°</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f8f9fa; color: #212529; }
    h1 { font-size: 24px; }
    button, input[type="file"] { margin: 5px 0; padding: 8px 12px; font-size: 16px; }
    textarea { width: 100%; height: 150px; margin-top: 10px; font-family: monospace; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    label { display: flex; align-items: center; margin-top: 10px; }
    input[type="checkbox"] { margin-right: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ƒ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ìë™ ìƒì„±ê¸°</h1>
    <input type="file" id="inputFile" accept=".xls,.xlsx" /><br/>
    <label><input type="checkbox" id="combineNameColor"> ìƒí’ˆëª…+ìƒ‰ìƒ ì¡°í•©ìœ¼ë¡œ ì œí’ˆì„ íƒ í‘œì‹œ</label>
    <label><input type="checkbox" id="excludeItem"> ì œì™¸ ìƒí’ˆ ì œì™¸í•˜ê³  ì¶œë ¥</label>
    <button onclick="generateFiles()">ì—‘ì…€ ì˜µì…˜ ìƒì„± ë° ZIP ë‹¤ìš´ë¡œë“œ</button>
    <textarea id="pasteArea" placeholder="ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ë°ì´í„° ë¶™ì—¬ë„£ê¸° (ì„ íƒì‚¬í•­)"></textarea>
  </div>
  <script>
    function generateFiles() {
      const combineNameColor = document.getElementById('combineNameColor').checked;
      const excludeItem = document.getElementById('excludeItem').checked;
      const fileInput = document.getElementById('inputFile').files[0];
      const pastedText = document.getElementById('pasteArea').value.trim();

      const processWorkbook = (workbook) => {
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);

        const grouped = {};
        json.forEach(row => {
          if (!grouped[row["1ë²ˆ ìƒí’ˆëª…"]]) grouped[row["1ë²ˆ ìƒí’ˆëª…"]] = [];
          grouped[row["1ë²ˆ ìƒí’ˆëª…"]].push(row);
        });

        const zip = new JSZip();

        Object.entries(grouped).forEach(([groupKey, items], i) => {
          const repItem = items.find(item => item["1ë²ˆ ìƒí’ˆëª…"] == groupKey);
          const repPrice = parseInt(repItem["íŒë§¤ê°€"]);
          const repName = repItem["ìƒí’ˆëª…"];

          let data = [];
          let order = 1;

          items.forEach((item, idx) => {
            const colorList = String(item["ìƒ‰ìƒ"] || '').replace(/\//g, ',').split(',');
            const sizeList = String(item["ì‚¬ì´ì¦ˆ"] || '').replace(/\//g, ',').split(',');
            const isRepresentative = (item["1ë²ˆ ìƒí’ˆëª…"] == groupKey);
            const exclude = (excludeItem && item["ì œì™¸"] == 'Y');
            if (exclude) return;

            const prefix = (order < 10 ? `0${order}` : order);
            const optionName = `${prefix}) ${combineNameColor ? `${item["ìƒí’ˆëª…"]} / ` : ''}`;

            colorList.forEach(color => {
              sizeList.forEach(size => {
                let ì˜µì…˜ê°€ = isRepresentative ? 0 : (parseInt(item["íŒë§¤ê°€"]) - repPrice);
                let í’ˆì ˆ = (String(item["í’ˆì ˆëœ ì¡°í•©"] || '').includes(`${color}/${size}`));
                data.push({
                  ì œí’ˆì„ íƒ: `${optionName}${color}`,
                  ìƒ‰ìƒ: color,
                  ì‚¬ì´ì¦ˆ: size,
                  ì˜µì…˜ê°€: ì˜µì…˜ê°€,
                  ì¬ê³ ìˆ˜ëŸ‰: í’ˆì ˆ ? 0 : 99999,
                  ê´€ë¦¬ì½”ë“œ: item["ìƒí’ˆëª…"],
                  ì‚¬ìš©ì—¬ë¶€: 'Y'
                });
              });
            });
            order++;
          });

          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "ì˜µì…˜ë°ì´í„°");
          const wbout = XLSX.write(wb, {bookType:'xls', type:'array'});
          zip.file(`${repName}.xls`, wbout);
        });

        zip.generateAsync({type:"blob"}).then(content => {
          saveAs(content, "ì˜µì…˜_ìë™ìƒì„±.zip");
        });
      };

      if (fileInput) {
        const reader = new FileReader();
        reader.onload = e => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          processWorkbook(workbook);
        };
        reader.readAsArrayBuffer(fileInput);
      } else if (pastedText) {
        const rows = pastedText.split("\n").map(r => r.split("\t"));
        const headers = rows[0];
        const body = rows.slice(1);
        const json = body.map(row => Object.fromEntries(row.map((cell, i) => [headers[i], cell])));
        const ws = XLSX.utils.json_to_sheet(json);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ìƒí’ˆì˜µì…˜");
        processWorkbook(wb);
      } else {
        alert("ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.");
      }
    }
  </script>
</body>
</html>
