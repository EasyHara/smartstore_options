  <!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ìë™ ìƒì„±ê¸°</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/plugins/SortableMultiDrag.min.js"></script>

  <style>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* ë°•ìŠ¤ ëª¨ë¸ í†µì¼ */
    *, *::before, *::after { box-sizing: border-box; }

    body {
      font-family: 'Pretendard', sans-serif;
      padding: 20px;
      background: #f5f6fa;
      color: #333;
    }

    .container {
      max-width: 100%;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      overflow-x: auto;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 16px;
    }

    .guide {
      position: relative;
      background: #f8f9fc;
      padding: 16px 20px;
      margin-bottom: 24px;
      border-radius: 10px;
      line-height: 1.6;
      box-shadow: 0 0 0 1px #e5e7eb;
    }
    .guide a.github {
      position: absolute;
      top: 12px; right: 16px;
      background: #f8f9fc; color: #2563eb;
      font-weight: 500; font-size: 14px;
      text-decoration: none;
      padding: 4px 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
    }
    .guide strong { display: block; margin-bottom: 8px; }

    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    table {
      width: 100%; min-width: 1200px;
      border-collapse: collapse;
      margin: 10px 0;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      font-size: 14px;
      word-break: break-word;
      vertical-align: middle;
    }
    th { background: #f0f0f0; }

    /* ê³µí†µ ë²„íŠ¼/ì…ë ¥ ìŠ¤íƒ€ì¼ */
    button, input[type="file"], input[type="number"], input[type="text"] {
      margin: 4px; padding: 6px 10px;
      font-size: 14px; height: 36px;
      vertical-align: middle;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    /* ëª¨ë“  í…Œì´ë¸” ë‚´ë¶€ í…ìŠ¤íŠ¸/ë„˜ë²„ ì…ë ¥ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    #inputTable td input[type="text"],
    #inputTable td input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      border: none;
      outline: none;
      background: transparent;
      padding: 4px 6px;
      margin: 0;
    }

    /* ì´ë™ ì²´í¬ë°•ìŠ¤(.to-move) ì»¤ìŠ¤í…€ */
    #inputTable td input.to-move {
      -webkit-appearance: none;
      appearance: none;
      width: 16px; height: 16px;
      background-color: transparent; border: none;
      cursor: pointer; margin: auto; display: block;
      position: relative;
    }
    #inputTable td input.to-move:checked {
      background-color: #2563eb;
    }
    #inputTable td input.to-move:checked::after {
      content: 'âœ”';
      color: #fff;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px; line-height: 1;
    }

    /* ë¼ë””ì˜¤ ë²„íŠ¼ ì¤‘ì•™ ì •ë ¬ */
    #inputTable td input[type="radio"] {
      margin: auto; display: block;
    }

    /* 8ë²ˆì§¸ ì—´(í’ˆì ˆëœ ì¡°í•©) ë§ì¤„ì„ */
    #inputTable td:nth-child(8) input[type="text"] {
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ƒ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ ì˜µì…˜ ìë™ ìƒì„±ê¸°</h1>

    <!-- íŒŒì¼ ì—…ë¡œë“œ & í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ -->
    <input type="file" id="inputFile" accept=".xls,.xlsx">
    <button onclick="downloadTemplate()">ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>

    <!-- ì‚¬ì´ì¦ˆ ì…ë ¥ ë°©ë²• ì•ˆë‚´ + GitHub ë§í¬ -->
    <div class="guide">
      <a href="https://github.com/EasyHara/smartstore_options/blob/main/smartstore_options.html"
         class="github" target="_blank">ì›¹ íŒŒì¼</a>
      <strong>ì‚¬ì´ì¦ˆ ì…ë ¥ ë°©ë²• ì•ˆë‚´</strong>
      <ul style="margin:0; padding-left:20px;">
        <li><strong>ë²”ìœ„ ì…ë ¥:</strong> <code>230~240</code> â†’ 5ë‹¨ìœ„ ìë™ ìƒì„± (ì˜ˆ: 230,235,240)</li>
        <li><strong>ê°œë³„ ì…ë ¥:</strong> <code>230,235/245</code> â†’ ì‰¼í‘œ ë˜ëŠ” ìŠ¬ë˜ì‹œë¡œ ì§ì ‘ ì§€ì •</li>
        <li>ë„¤ì´ë²„ ê·œì •ì— ë”°ë¼ ë¯¸ë‹¬Â·ì´ˆê³¼ ì˜µì…˜ì€ ë‹¤ìš´ë¡œë“œ ì‹œ ìë™ ì œê±°ë©ë‹ˆë‹¤</li>
      <strong>í’ˆì ˆ ì…ë ¥ë°©ë²•</strong>
        <li>ì˜ˆì‹œ1) ë¸”ë™,ë¸”ë£¨</li>
        <li>ì˜ˆì‹œ2) 90,100,105</li>
        <li>ì˜ˆì‹œ3) ë¸”ë™-100,ë¸”ë£¨-105</li>
      </ul>
    </div>

    <!-- ì˜µì…˜ ë…¸ì¶œ ë°©ì‹ / í• ì¸ë¥  -->
    <div style="margin-bottom:24px;">
      <span>ì˜µì…˜ ë…¸ì¶œ ë°©ì‹:</span>
      <label><input type="radio" name="optionDisplay" value="both" checked> ìƒ‰ìƒ&ì‚¬ì´ì¦ˆ ëª¨ë‘</label>
      <label><input type="radio" name="optionDisplay" value="colorOnly"> ìƒ‰ìƒë§Œ</label>
      <label><input type="radio" name="optionDisplay" value="sizeOnly"> ì‚¬ì´ì¦ˆë§Œ</label>
      <label style="margin-left:20px;">ì˜µì…˜ê°€ ê³„ì‚° í• ì¸ë¥  (%)</label>
      <input type="number" id="discountRate" value="0" min="0" max="99">%
    </div>

    <!-- ì˜µì…˜ í…Œì´ë¸” -->
    <table id="inputTable">
      <thead>
        <tr>
          <th>ì´ë™</th>
          <th>ëŒ€í‘œ</th>
          <th>ìƒí’ˆëª…</th>
          <th>íŒë§¤ê°€(ë„¤ì´ë²„í• ì¸ê°€)</th>
          <th>ìƒ‰ìƒ</th>
          <th>ì‚¬ì´ì¦ˆ</th>
          <th>1ë²ˆ ìƒí’ˆëª…</th>
          <th>í’ˆì ˆëœ ì¡°í•©</th>
          <th>ì œì™¸</th>
        </tr>
      </thead>
      <tbody>
        <!-- JSë¡œ addRow() í˜¸ì¶œ ì‹œ ì—¬ê¸°ì— <tr>ì´ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </tbody>
    </table>

    <!-- í–‰ ì¶”ê°€ / ì¡°ì‘ ë²„íŠ¼ -->
    <button onclick="addRow()">+ í–‰ ì¶”ê°€</button>
    <button onclick="clearTable()">ì´ˆê¸°í™”</button>
    <button onclick="resetOrder()">ìˆœì„œ ì´ˆê¸°í™”</button>
    <button onclick="moveSelectedToTop()">ë§¨ ìœ„ë¡œ</button>
    <button onclick="moveSelectedUp()">ìœ„ë¡œ</button>
    <button onclick="moveSelectedDown()">ì•„ë˜ë¡œ</button>
    <button onclick="moveSelectedToBottom()">ë§¨ ì•„ë˜ë¡œ</button>

    <!-- ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
    <div style="text-align:center; margin-top:20px;">
  	<label style="margin-right:16px;">
  	  <input type="checkbox" id="hideBrand"> ë¸Œëœë“œ ê°€ë¦¬ê¸°
	</label>
       <label style="margin-right:16px;">
         <input type="checkbox" id="appendCodeToSize"> ì‚¬ì´ì¦ˆë§ˆë‹¤ ìƒí’ˆì½”ë“œ
       </label>
      <label style="margin-right:16px;">
         <input type="checkbox" id="allFirstName"> ëª¨ë‘ 1ë²ˆìƒí’ˆëª…
      </label>
      <button onclick="downloadRepresentative()">ì„ íƒìƒí’ˆ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="generateZip()">ì¼ê´„ ZIP ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="downloadAddProductExcel()">ì¶”ê°€ìƒí’ˆ ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="downloadSingleProductExcel()">ë‹¨í’ˆë“±ë¡ ë‹¤ìš´ë¡œë“œ</button>
      <button onclick="downloadSingleProductExcelAll()">ë‹¨í’ˆ ì „ì²´ ZIP</button>
      <button onclick="downloadOrderedTemplate()">ìˆœì„œë°˜ì˜ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>

  <script>

// ë¸Œëœë“œ, ìƒí’ˆì½”ë“œ, ë¶„ë¥˜, ì¡°í•©ì„ ì¶”ì¶œ
function parseBrandProductType(name) {
  if (!name) return { brand: '', codes: [], type: '', manageCodes: [] };
  const arr = name.trim().split(/\s+/);
  const brand = arr[0];
  if (arr.length === 1) {
    return { brand, codes: [brand], type: brand, manageCodes: [`${brand}`] };
  } else if (arr.length === 2) {
    return { brand, codes: [arr[1]], type: arr[1], manageCodes: [`${brand} ${arr[1]}`] };
  } else {
    const type = arr[arr.length - 1];
    const codes = arr.slice(1, -1);
    // ê´€ë¦¬ì½”ë“œ = ë¸Œëœë“œ + ê° ì½”ë“œ + ë¶„ë¥˜
    let manageCodes = codes.map(code => {
      let combo = `${brand} ${code} ${type}`;
      let combo20 = combo.replace(/\s+/g, '');
      return combo20.length > 20 ? combo20.slice(0, 20) : combo;
    });
    if (manageCodes.length === 0) manageCodes = [`${brand} ${type}`];
    return { brand, codes, type, manageCodes };
  }
}


// â–¶ JSON ë°ì´í„° â†’ ì‹œíŠ¸ ìë™ ë„ˆë¹„ í•¨ìˆ˜
function autoWidth(ws, data, header) {
  const colWidths = header.map(hdr => {
    let maxLen = hdr.length;            // í—¤ë” ê¸¸ì´ ê¸°ì¤€
    data.forEach(row => {
      const v = row[hdr];
      if (v != null) {
        const len = v.toString().length;
        if (len > maxLen) maxLen = len;
      }
    });
    return { wch: maxLen + 2 };         // +2 ì—¬ìœ 
  });
  ws['!cols'] = colWidths;
}

// â–¶ AOA(2ì°¨ì› ë°°ì—´) â†’ ì‹œíŠ¸ ìë™ ë„ˆë¹„ í•¨ìˆ˜
function autoWidthAoA(ws, aoa) {
  const colCount = aoa[0]?.length || 0;
  const colWidths = [];
  for (let c = 0; c < colCount; c++) {
    let maxLen = 0;
    aoa.forEach(row => {
      const val = row[c] != null ? row[c].toString() : "";
      if (val.length > maxLen) maxLen = val.length;
    });
    colWidths.push({ wch: maxLen + 2 });
  }
  ws['!cols'] = colWidths;
}

    // í´ë¦­ í•¸ë“¤ëŸ¬: Ctrl/Cmd+í´ë¦­ ì‹œ selected í´ë˜ìŠ¤ í† ê¸€
function onRowClick(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
  if (e.ctrlKey || e.metaKey) this.classList.toggle('selected');
}

      // í–‰ ì¶”ê°€ + í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
function addRow(data = {}) {
  const tbody = document.querySelector('#inputTable tbody');
  const row = document.createElement('tr');
  row.innerHTML = `
   <td><input type="checkbox" class="to-move"></td>
    <td><input type="radio" name="ëŒ€í‘œ"></td>
    <td><input type="text" value="${data.ìƒí’ˆëª…||''}"></td>
    <td><input type="number" value="${data.íŒë§¤ê°€||''}"></td>
    <td><input type="text" value="${data.ìƒ‰ìƒ||''}"></td>
    <td><input type="text" value="${data.ì‚¬ì´ì¦ˆ||''}"></td>
    <td><input type="text" value="${data['1ë²ˆ ìƒí’ˆëª…']||''}"></td>
    <td><input type="text" value="${data.í’ˆì ˆëœì¡°í•©||''}"></td>
    <td><input type="checkbox" ${data.ì œì™¸?'checked':''}></td>
  `;
  row.addEventListener('click', onRowClick);
  tbody.appendChild(row);
}
  // core + plugin ëª¨ë‘ ë¡œë“œëœ ì´í›„ì— í•œ ë²ˆë§Œ ì‹¤í–‰
  Sortable.create(document.querySelector('#inputTable tbody'), {
    animation: 150,
    handle: 'td',
    multiDrag: true,           // ë©€í‹° ë“œë˜ê·¸ í™œì„±í™”
    selectedClass: 'selected', // ì„ íƒëœ í–‰ì— ì ìš©í•  í´ë˜ìŠ¤
    multiDragKey: 'ctrl',      // Ctrl(Cmd) í‚¤ë¡œ ë³µìˆ˜ ì„ íƒ
    fallbackTolerance: 3
  });
    
// í…Œì´ë¸” ë°ì´í„°ë¥¼ ìŠ¤ìŠ¤_ì˜µì…˜ì–‘ì‹ ì–‘ì‹ìœ¼ë¡œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function downloadOrderedTemplate() {
  // 1) í—¤ë” ì •ì˜ (ìŠ¤ìŠ¤_ì˜µì…˜ì–‘ì‹ê³¼ ë™ì¼)
  const headers = [
    "ìƒí’ˆëª…",
    "íŒë§¤ê°€",
    "ìƒ‰ìƒ",
    "ì‚¬ì´ì¦ˆ",
    "1ë²ˆ ìƒí’ˆëª…",
    "í’ˆì ˆëœ ì¡°í•©",
    "ì œì™¸"
  ];

  // 2) í˜„ì¬ í™”ë©´ì— í‘œì‹œëœ ìˆœì„œëŒ€ë¡œ <tbody>ì˜ ê° <tr>ì„ ì½ì–´ì„œ ë°ì´í„° ë°°ì—´ ìƒì„±
  const data = Array.from(document.querySelectorAll('#inputTable tbody tr')).map(row => {
    const inputs = row.querySelectorAll('input');
    return [
      inputs[2].value.trim(),                // ìƒí’ˆëª…
      parseInt(inputs[3].value, 10) || 0,    // íŒë§¤ê°€
      inputs[4].value.trim(),                // ìƒ‰ìƒ
      inputs[5].value.trim(),                // ì‚¬ì´ì¦ˆ
      inputs[6].value.trim(),                // 1ë²ˆ ìƒí’ˆëª…
      inputs[7].value.trim(),                // í’ˆì ˆëœ ì¡°í•©
      inputs[8].checked ? 'Y' : ''           // ì œì™¸(Y/ë¹ˆë¬¸ì)
    ];
  });

  // 3) SheetJSë¡œ ì›Œí¬ì‹œíŠ¸, ì›Œí¬ë¶ ìƒì„±
  const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
  autoWidthAoA(ws, [headers, ...data]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ìƒí’ˆì˜µì…˜");

  // 4) Blobìœ¼ë¡œ ë³€í™˜ í›„ FileSaver.jsë¡œ ë‹¤ìš´ë¡œë“œ
  const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
  const blob = new Blob([wbout], { type: 'application/octet-stream' });
  saveAs(blob, 'ìŠ¤ìŠ¤_ì˜µì…˜ì–‘ì‹-ìˆœì„œë°˜ì˜.xls');
  }

    
    let originalData = [];

    // í…Œì´ë¸” ì´ˆê¸°í™”
function clearTable() {
  document.querySelector('#inputTable tbody').innerHTML = '';
  document.getElementById('inputFile').value = '';    // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
  originalData = [];                                  // ì €ì¥ëœ ì›ë³¸ ìˆœì„œë„ ì´ˆê¸°í™”
}

    // ì›ë˜ ìˆœì„œ ë³µì›
function resetOrder() {
  const tbody = document.querySelector('#inputTable tbody');
  tbody.innerHTML = '';
  originalData.forEach(d => addRow(d));
}

    // í˜„ì¬ í…Œì´ë¸” ë°ì´í„°ë¥¼ ì½ì–´ì„œ ê°ì²´ ë°°ì—´ ë¦¬í„´
    function getDataFromTable() {
      return Array.from(document.querySelectorAll('#inputTable tbody tr')).map(row => {
        const inputs = row.querySelectorAll('input');
        return {
          ëŒ€í‘œ:     inputs[1].checked,
          ìƒí’ˆëª…:   inputs[2].value.trim(),
          íŒë§¤ê°€:   parseInt(inputs[3].value)||0,
          ìƒ‰ìƒ:     inputs[4].value.trim(),
          ì‚¬ì´ì¦ˆ:   inputs[5].value.trim(),
          ['1ë²ˆ ìƒí’ˆëª…']: inputs[6].value.trim(),
          í’ˆì ˆëœì¡°í•©: inputs[7].value.trim(),
          ì œì™¸:     inputs[8].checked
        };
      });
    }

    // ì„ íƒëœ í–‰ì„ ìœ„ë¡œ/ì•„ë˜ë¡œ ì´ë™
    function moveSelectedUp() {
  const tbody = document.querySelector('#inputTable tbody');
  // ëª¨ë“  í–‰ì„ ë°°ì—´ë¡œ, ìœ„ìª½ë¶€í„° ìˆœíšŒí•˜ë©°
  Array.from(tbody.querySelectorAll('tr')).forEach(row => {
    const cb = row.querySelector('.to-move');
    if (!cb || !cb.checked) return;
    const prev = row.previousElementSibling;
    if (prev) tbody.insertBefore(row, prev);
  });
}
    function moveSelectedDown() {
      const tbody = document.querySelector('#inputTable tbody');
      Array.from(tbody.querySelectorAll('tr')).reverse().forEach(row => {
        const cb = row.querySelector('.to-move');
        if (cb && cb.checked) {
          const next = row.nextElementSibling;
          if (next) tbody.insertBefore(next, row);
        }
      });
    }
    // ì„ íƒëœ í–‰ì„ ë§¨ ìœ„ë¡œ ì´ë™
function moveSelectedToTop() {
  const tbody = document.querySelector('#inputTable tbody');
  // ì²´í¬ëœ í–‰ë“¤ì„ ìœ„â†’ì•„ë˜ ìˆœì„œë¡œ ì°¾ì•„ì„œ
  Array.from(tbody.querySelectorAll('tr')).forEach(row => {
    const cb = row.querySelector('.to-move');
    if (cb && cb.checked) {
      // ë§¨ ìœ„(ì²« ë²ˆì§¸ ìì‹) ì•ì— ì‚½ì…
      tbody.insertBefore(row, tbody.firstElementChild);
    }
  });
}
    // ì„ íƒëœ í–‰ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
function moveSelectedToBottom() {
  const tbody = document.querySelector('#inputTable tbody');
  // ì²´í¬ëœ í–‰ë“¤ì„ ì•„ë˜â†’ìœ„ ìˆœì„œë¡œ ì°¾ì•„ì„œ
  Array.from(tbody.querySelectorAll('tr')).reverse().forEach(row => {
    const cb = row.querySelector('.to-move');
    if (cb && cb.checked) {
      tbody.appendChild(row);
    }
  });
}

    // ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
    function downloadTemplate() {
      const headers = ['ìƒí’ˆëª…','íŒë§¤ê°€','ìƒ‰ìƒ','ì‚¬ì´ì¦ˆ','1ë²ˆ ìƒí’ˆëª…','í’ˆì ˆëœ ì¡°í•©','ì œì™¸'];
      const ws = XLSX.utils.aoa_to_sheet([headers]);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'ìƒí’ˆì˜µì…˜');
      const blob = new Blob([XLSX.write(wb,{bookType:'xls',type:'array'})],{type:'application/octet-stream'});
      saveAs(blob,'ìŠ¤ìŠ¤_ì˜µì…˜ì–‘ì‹.xls');
    }

    // ì—…ë¡œë“œ íŒŒì¼ ì½ê¸° & ì›ë³¸ ì €ì¥
   document.getElementById('inputFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data,{type:'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet,{defval:''});
        clearTable();
        json.forEach(r => addRow({
          ìƒí’ˆëª…: r['ìƒí’ˆëª…'],
          íŒë§¤ê°€: r['íŒë§¤ê°€'],
          ìƒ‰ìƒ:   r['ìƒ‰ìƒ'],
          ì‚¬ì´ì¦ˆ: r['ì‚¬ì´ì¦ˆ'],
          '1ë²ˆ ìƒí’ˆëª…': r['1ë²ˆ ìƒí’ˆëª…'],
          í’ˆì ˆëœì¡°í•©: r['í’ˆì ˆëœ ì¡°í•©']||'',
          ì œì™¸: r['ì œì™¸']==='Y'
        }));
        originalData = getDataFromTable();
      };
      reader.readAsArrayBuffer(file);
    });
      // ë„¤ì´ë²„ ì˜µì…˜ê°€ ìœ íš¨ì„± ê²€ì‚¬
  function isValidOptionPrice(basePrice, diff) {
    if (basePrice < 2000) return diff >= 0 && diff <= basePrice;
    if (basePrice < 10000) return diff >= -basePrice * 0.5 && diff <= basePrice;
    return diff >= -basePrice * 0.5 && diff <= basePrice * 0.5;
  }

  // í• ì¸ë¥  ê¸°ì¤€ ì›ê°€ ê³„ì‚°
  function calculateOriginalPrice(salePrice, discountRate) {
    const raw = salePrice / (1 - discountRate / 100);
    return Math.round(raw / 100) * 100;
  }

// ì‚¬ì´ì¦ˆì— ìƒí’ˆì½”ë“œ ë¶™ì´ê¸°
function extractProductCode(name) {
  if (!name) return "";
  const arr = name.trim().split(" ");
  // ì²« ë²ˆì§¸ ë‹¨ì–´(ë¸Œëœë“œ)ë¥¼ ì œì™¸í•˜ê³ , ê·¸ ë‹¤ìŒ ë‹¨ì–´ë¥¼ ìƒí’ˆì½”ë“œë¡œ ì·¨ê¸‰
  // ex) ["ì•„ì´ë”", "TS-S2406", "í‹°ì…”ì¸ "] -> "TS-S2406"
  //     ["ë¸”ë™ì•¼í¬", "S-í´ë¡œë°°ìƒ‰í‹°ì…”ì¸ "] -> "S-í´ë¡œë°°ìƒ‰í‹°ì…”ì¸ "
  return arr.length > 1 ? arr[1] : "";
}

  // ì˜µì…˜ ë¬¸ìì—´ â†’ ë°°ì—´
function parseOptions(str) {
  if (!str || typeof str !== 'string') return [];
  return str
    // ASCII ì½¤ë§ˆ ',', ì „ê° ì½¤ë§ˆ 'ï¼Œ', ì¤‘ê°„ì  'Â·','ï½¤', ASCII ìŠ¬ë˜ì‹œ '/', ì „ê° ìŠ¬ë˜ì‹œ 'ï¼' ë“±ì„ ëª¨ë‘ ë¶„ë¦¬
    .split(/[,ï¼ŒÂ·ï½¤\/ï¼]/g)    
    .map(s => s.trim())
    .filter(Boolean);
}
// (1) ìƒí’ˆëª…ì—ì„œ "ë¸Œëœë“œ ìƒí’ˆì½”ë“œ ë¶„ë¥˜"ë§Œ ì¶”ì¶œ
function extractManageCodes(name) {
  if (!name) return [];
  const m = name.match(/^(\S+)\s+(.+)$/); // ë¸Œëœë“œ, ë‚˜ë¨¸ì§€
  if (!m) return [];
  const brand = m[1];
  const rest = m[2].trim();
  const parts = rest.split(' ');
  // parts ì˜ˆ: ['TS-S2401', 'TS-2402', 'í‹°ì…”ì¸ ']
  let ë¶„ë¥˜ = parts[parts.length - 1]; // í•­ìƒ ë§¨ ë’¤ê°€ ë¶„ë¥˜
  // ë¶„ë¥˜ì— 'í‹°ì…”ì¸ ' ë“± í•œê¸€ í¬í•¨ë  ìˆ˜ ìˆìŒ
  let codes = [];
  for (let i = 0; i < parts.length - 1; i++) {
    codes.push(`${brand} ${parts[i]} ${ë¶„ë¥˜}`);
  }
  // ë§Œì•½ ìƒí’ˆì½”ë“œê°€ í•˜ë‚˜ë¼ë©´
  if (codes.length === 0) codes.push(`${brand} ${parts[0]} ${ë¶„ë¥˜}`);
  return codes;
}

// (2) ê´€ë¦¬ì½”ë“œ 20ì ì œí•œ (ë„ì›Œì“°ê¸° ì œê±° í›„)
function limitManageCodeLength(str) {
  let out = str.replace(/\s+/g, "");
  if (out.length > 20) out = out.slice(0, 20);
  return out;
}
   
// â€œì„ íƒìƒí’ˆ ì—‘ì…€ ë‹¤ìš´ë¡œë“œâ€ (ëª¨ë“  ìƒí’ˆ â†’ í•œ ê°œ íŒŒì¼, ëŒ€í‘œ ë¬´ì¡°ê±´ 01, ê·œì • ìœ„ë°˜ ê·¸ë£¹ ê±´ë„ˆë›°ê³  ì—°ì† ë²ˆí˜¸)
function downloadRepresentative() {
  const rows = getDataFromTable().filter(r => !r.ì œì™¸);
  if (!rows.length) {
    alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const hideBrand       = document.getElementById("hideBrand").checked;
  const discountRate    = parseFloat(document.getElementById("discountRate").value) || 0;
  const mode            = getOptionDisplayMode();
  const useAllFirstName = document.getElementById('allFirstName')?.checked;
  const appendCode      = document.getElementById('appendCodeToSize')?.checked;

  const master       = rows.find(r => r.ëŒ€í‘œ) || rows[0];
  const masterPrice  = calculateOriginalPrice(master.íŒë§¤ê°€, discountRate);

  const ordered = [ master, ...rows.filter(r => r !== master) ];

  const data = [];
  let groupIndex = 0;

  ordered.forEach(item => {
    const diff    = item.íŒë§¤ê°€ - master.íŒë§¤ê°€;
    const colors  = parseOptions(item.ìƒ‰ìƒ).length ? parseOptions(item.ìƒ‰ìƒ) : [""];
    const sizes   = expandSizes(item.ì‚¬ì´ì¦ˆ);
    const itemInfo = parseBrandProductType(item.ìƒí’ˆëª…);

    // ìƒ‰ìƒìˆ˜ì™€ ê´€ë¦¬ì½”ë“œìˆ˜ 1:1 ë§¤ì¹­
    const manageCodes = itemInfo.manageCodes;
    const colorCount = colors.length;
    const codeList = [];
    for(let i=0; i<colorCount; i++) {
      codeList.push(manageCodes[i] || manageCodes[manageCodes.length-1]);
    }

    let baseName;
    if (useAllFirstName) {
      baseName = item["1ë²ˆ ìƒí’ˆëª…"] ? `${itemInfo.brand} ${item["1ë²ˆ ìƒí’ˆëª…"]}` : item.ìƒí’ˆëª…;
    } else {
      baseName = item.ëŒ€í‘œ
        ? `${itemInfo.brand} ${item["1ë²ˆ ìƒí’ˆëª…"] || item.ìƒí’ˆëª…}`
        : item.ìƒí’ˆëª…;
    }

    // ë„¤ì´ë²„ ì˜µì…˜ê°€ ê·œì • í†µê³¼ ì²´í¬
    const hasValid = colors.some(col => sizes.some(sz => isValidOptionPrice(masterPrice, diff)));
    if (!hasValid) return;

    groupIndex++;
    const seq = String(groupIndex).padStart(2, "0");

    if (mode === "both") {
      colors.forEach((col, colIdx) => {
        sizes.forEach(sz => {
          // ì‚¬ì´ì¦ˆ ì—´ì— "ì‚¬ì´ì¦ˆ" / "ìƒí’ˆì½”ë“œ" ë¶™ì´ê¸°
          let szCode = sz;
          if (appendCode && itemInfo.codes && itemInfo.codes.length) {
            szCode += " / " + (itemInfo.codes[colIdx] || itemInfo.codes[itemInfo.codes.length-1] || "");
          }
          // í’ˆì ˆ ì²˜ë¦¬
          let í’ˆì ˆ = false;
          if (
            (item.í’ˆì ˆëœì¡°í•© && (
              item.í’ˆì ˆëœì¡°í•©.includes("ë‹¨ì¢…") ||
              item.í’ˆì ˆëœì¡°í•©.includes("í’ˆì ˆ") ||
              item.í’ˆì ˆëœì¡°í•©.split(/[,\s/]+/).includes(col) ||
              item.í’ˆì ˆëœì¡°í•©.split(/[,\s/]+/).includes(sz) ||
              item.í’ˆì ˆëœì¡°í•©.split(/[,\s/]+/).includes(col + "-" + sz)
            ))
          ) {
            í’ˆì ˆ = true;
          }
          // ê´€ë¦¬ì½”ë“œ (ìƒ‰ìƒë³„ 1:1, 20ì ì œí•œ)
          let manageCode = codeList[colIdx];
          if (manageCode.replace(/\s/g, '').length > 20) {
            manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
          }
          data.push({
            ì œí’ˆì„ íƒ: `${seq}) ${baseName}${col ? ` / ${col}` : ""}`,
            ì‚¬ì´ì¦ˆ:   szCode,
            ì˜µì…˜ê°€:    diff,
            ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
            ê´€ë¦¬ì½”ë“œ:  manageCode,
            ì‚¬ìš©ì—¬ë¶€:  "Y"
          });
        });
      });
    } else if (mode === "colorOnly") {
      colors.forEach((col, colIdx) => {
        let í’ˆì ˆ = false;
        if (
          (item.í’ˆì ˆëœì¡°í•© && (
            item.í’ˆì ˆëœì¡°í•©.includes("ë‹¨ì¢…") ||
            item.í’ˆì ˆëœì¡°í•©.includes("í’ˆì ˆ") ||
            item.í’ˆì ˆëœì¡°í•©.split(/[,\s/]+/).includes(col)
          ))
        ) {
          í’ˆì ˆ = true;
        }
        let manageCode = codeList[colIdx];
        if (manageCode.replace(/\s/g, '').length > 20) {
          manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
        }
        data.push({
          ì œí’ˆì„ íƒ: `${seq}) ${baseName}`,
          ìƒ‰ìƒ:     col,
          ì˜µì…˜ê°€:    diff,
          ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
          ê´€ë¦¬ì½”ë“œ:  manageCode,
          ì‚¬ìš©ì—¬ë¶€:  "Y"
        });
      });
    } else {
      sizes.forEach(sz => {
        let szCode = sz;
        if (appendCode && itemInfo.codes && itemInfo.codes.length) {
          szCode += " / " + (itemInfo.codes[0] || "");
        }
        let í’ˆì ˆ = false;
        if (
          (item.í’ˆì ˆëœì¡°í•© && (
            item.í’ˆì ˆëœì¡°í•©.includes("ë‹¨ì¢…") ||
            item.í’ˆì ˆëœì¡°í•©.includes("í’ˆì ˆ") ||
            item.í’ˆì ˆëœì¡°í•©.split(/[,\s/]+/).includes(sz)
          ))
        ) {
          í’ˆì ˆ = true;
        }
        let manageCode = codeList[0];
        if (manageCode.replace(/\s/g, '').length > 20) {
          manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
        }
        data.push({
          ì œí’ˆì„ íƒ: `${seq}) ${baseName}`,
          ì‚¬ì´ì¦ˆ:   szCode,
          ì˜µì…˜ê°€:    diff,
          ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
          ê´€ë¦¬ì½”ë“œ:  manageCode,
          ì‚¬ìš©ì—¬ë¶€:  "Y"
        });
      });
    }
  });

  // --- ë¸Œëœë“œ ìˆ¨ê¸°ê¸° & 25ì ë³´ì • ë¡œì§ ---
  data.forEach(item => {
    if (hideBrand) {
      item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/^(\d+\)\s*)\S+\s/, "$1");
    }
    if (item.ì œí’ˆì„ íƒ.length > 25) {
      item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/ \/ /g, "/");
    }
    if (item.ì œí’ˆì„ íƒ.length > 25) {
      item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/^(\d+\))\s/, "$1");
    }
  });

  // ì—‘ì…€ í—¤ë” êµ¬ì„±
  const header = ["ì œí’ˆì„ íƒ"];
  if (mode === "both" || mode === "sizeOnly") header.push("ì‚¬ì´ì¦ˆ");
  if (mode === "colorOnly") header.push("ìƒ‰ìƒ");
  header.push("ì˜µì…˜ê°€","ì¬ê³ ìˆ˜ëŸ‰","ê´€ë¦¬ì½”ë“œ","ì‚¬ìš©ì—¬ë¶€");

  // ì‹œíŠ¸ ìƒì„± & ë‹¤ìš´ë¡œë“œ
  const ws = XLSX.utils.json_to_sheet(data, { header });
  autoWidth(ws, data, header);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ì˜µì…˜ë°ì´í„°");
  const safeName = master.ìƒí’ˆëª….replace(/[\\\/:*?"<>|]/g, "").trim();
  saveAs(
    new Blob([XLSX.write(wb, { bookType: "xls", type: "array" })]),
    `${safeName}.xls`
  );
}

//ì¼ê´„ ZIP ë‹¤ìš´ë¡œë“œ
function generateZip() {
  const rows = getDataFromTable().filter(r => !r.ì œì™¸);
  if (!rows.length) {
    alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const hideBrand      = document.getElementById("hideBrand").checked;
  const discountRate   = parseFloat(document.getElementById("discountRate").value) || 0;
  const mode           = getOptionDisplayMode();
  const zip            = new JSZip();
  const useAllFirstName = document.getElementById('allFirstName')?.checked;
  const appendCode     = document.getElementById('appendCodeToSize')?.checked;

  rows.forEach(repr => {
    const reprInfo = parseBrandProductType(repr.ìƒí’ˆëª…);
    const masterPrice = calculateOriginalPrice(repr.íŒë§¤ê°€, discountRate);

    const ordered = [ repr, ...rows.filter(r => r !== repr) ];
    const data = [];
    let groupIndex = 0;

    ordered.forEach(item => {
      const diff   = item.íŒë§¤ê°€ - repr.íŒë§¤ê°€;
      const colors = parseOptions(item.ìƒ‰ìƒ).length ? parseOptions(item.ìƒ‰ìƒ) : [""];
      const sizes  = expandSizes(item.ì‚¬ì´ì¦ˆ);
      const itemInfo = parseBrandProductType(item.ìƒí’ˆëª…);

      // ìƒ‰ìƒìˆ˜ì™€ ê´€ë¦¬ì½”ë“œìˆ˜ 1:1 ë§¤ì¹­
      const manageCodes = itemInfo.manageCodes;
      const colorCount = colors.length;
      const codeList = [];
      for(let i=0; i<colorCount; i++) {
        codeList.push(manageCodes[i] || manageCodes[manageCodes.length-1]);
      }

      let baseName;
      if (useAllFirstName) {
        baseName = item["1ë²ˆ ìƒí’ˆëª…"] ? `${itemInfo.brand} ${item["1ë²ˆ ìƒí’ˆëª…"]}` : item.ìƒí’ˆëª…;
      } else {
        baseName = item === repr
          ? `${itemInfo.brand} ${item["1ë²ˆ ìƒí’ˆëª…"] || item.ìƒí’ˆëª…}`
          : item.ìƒí’ˆëª…;
      }

      const hasValid = colors.some(col => sizes.some(sz => isValidOptionPrice(masterPrice, diff)));
      if (!hasValid) return;

      groupIndex++;
      const seq = String(groupIndex).padStart(2, "0");

      if (mode === "both") {
        colors.forEach((col, colIdx) => {
          sizes.forEach(sz => {
            let szCode = sz;
            if (appendCode && itemInfo.codes && itemInfo.codes.length) {
              szCode += " / " + (itemInfo.codes[colIdx] || itemInfo.codes[itemInfo.codes.length-1] || "");
            }
            let í’ˆì ˆ = false;
            if (
              (item.í’ˆì ˆëœì¡°í•© && (
                item.í’ˆì ˆëœì¡°í•©.includes("ë‹¨ì¢…") ||
                item.í’ˆì ˆëœì¡°í•©.includes("í’ˆì ˆ") ||
                item.í’ˆì ˆëœì¡°í•©.split(/[,\s/]+/).includes(col) ||
                item.í’ˆì ˆëœì¡°í•©.split(/[,\s/]+/).includes(sz) ||
                item.í’ˆì ˆëœì¡°í•©.split(/[,\s/]+/).includes(col + "-" + sz)
              ))
            ) {
              í’ˆì ˆ = true;
            }
            let manageCode = codeList[colIdx];
            if (manageCode.replace(/\s/g, '').length > 20) {
              manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
            }
            data.push({
              ì œí’ˆì„ íƒ: `${seq}) ${baseName}${col ? ` / ${col}` : ""}`,
              ì‚¬ì´ì¦ˆ:   szCode,
              ì˜µì…˜ê°€:    diff,
              ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
              ê´€ë¦¬ì½”ë“œ:  manageCode,
              ì‚¬ìš©ì—¬ë¶€:  "Y"
            });
          });
        });
      } else if (mode === "colorOnly") {
        colors.forEach((col, colIdx) => {
          let í’ˆì ˆ = false;
          if (
            (item.í’ˆì ˆëœì¡°í•© && (
              item.í’ˆì ˆëœì¡°í•©.includes("ë‹¨ì¢…") ||
              item.í’ˆì ˆëœì¡°í•©.includes("í’ˆì ˆ") ||
              item.í’ˆì ˆëœì¡°í•©.split(/[,\s/]+/).includes(col)
            ))
          ) {
            í’ˆì ˆ = true;
          }
          let manageCode = codeList[colIdx];
          if (manageCode.replace(/\s/g, '').length > 20) {
            manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
          }
          data.push({
            ì œí’ˆì„ íƒ: `${seq}) ${baseName}`,
            ìƒ‰ìƒ:     col,
            ì˜µì…˜ê°€:    diff,
            ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
            ê´€ë¦¬ì½”ë“œ:  manageCode,
            ì‚¬ìš©ì—¬ë¶€:  "Y"
          });
        });
      } else {
        sizes.forEach(sz => {
          let szCode = sz;
          if (appendCode && itemInfo.codes && itemInfo.codes.length) {
            szCode += " / " + (itemInfo.codes[0] || "");
          }
          let í’ˆì ˆ = false;
          if (
            (item.í’ˆì ˆëœì¡°í•© && (
              item.í’ˆì ˆëœì¡°í•©.includes("ë‹¨ì¢…") ||
              item.í’ˆì ˆëœì¡°í•©.includes("í’ˆì ˆ") ||
              item.í’ˆì ˆëœì¡°í•©.split(/[,\s/]+/).includes(sz)
            ))
          ) {
            í’ˆì ˆ = true;
          }
          let manageCode = codeList[0];
          if (manageCode.replace(/\s/g, '').length > 20) {
            manageCode = manageCode.replace(/\s/g, '').slice(0, 20);
          }
          data.push({
            ì œí’ˆì„ íƒ: `${seq}) ${baseName}`,
            ì‚¬ì´ì¦ˆ:   szCode,
            ì˜µì…˜ê°€:    diff,
            ì¬ê³ ìˆ˜ëŸ‰:  í’ˆì ˆ ? 0 : 99999,
            ê´€ë¦¬ì½”ë“œ:  manageCode,
            ì‚¬ìš©ì—¬ë¶€:  "Y"
          });
        });
      }
    });

    // --- ë¸Œëœë“œ ìˆ¨ê¸°ê¸° & 25ì ë³´ì • ë¡œì§ ---
    data.forEach(item => {
      if (hideBrand) {
        item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/^(\d+\)\s*)\S+\s/, "$1");
      }
      if (item.ì œí’ˆì„ íƒ.length > 25) {
        item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/ \/ /g, "/");
      }
      if (item.ì œí’ˆì„ íƒ.length > 25) {
        item.ì œí’ˆì„ íƒ = item.ì œí’ˆì„ íƒ.replace(/^(\d+\))\s/, "$1");
      }
    });

    const header = ["ì œí’ˆì„ íƒ"];
    if (mode === "both" || mode === "sizeOnly") header.push("ì‚¬ì´ì¦ˆ");
    if (mode === "colorOnly") header.push("ìƒ‰ìƒ");
    header.push("ì˜µì…˜ê°€", "ì¬ê³ ìˆ˜ëŸ‰", "ê´€ë¦¬ì½”ë“œ", "ì‚¬ìš©ì—¬ë¶€");

    const ws = XLSX.utils.json_to_sheet(data, { header });
    autoWidth(ws, data, header);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ì˜µì…˜ë°ì´í„°");

    const safeName = repr.ìƒí’ˆëª….replace(/[\\\/:*?"<>|]/g, "").trim();
    const blob = XLSX.write(wb, { bookType: "xls", type: "array" });
    zip.file(`${safeName}.xls`, blob);
  });

  zip.generateAsync({ type: "blob" })
    .then(content => saveAs(content, "ì˜µì…˜_ì¼ê´„ë‹¤ìš´ë¡œë“œ.zip"));
}

// ì¶”ê°€ìƒí’ˆ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ëª¨ë“  ì œì™¸ë˜ì§€ ì•Šì€ ìƒí’ˆ í¬í•¨)
  function downloadAddProductExcel() {
    const mode = getOptionDisplayMode();
    const rows = getDataFromTable().filter(r => !r.ì œì™¸);
    if (!rows.length) {
      return alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    }

    // 1) ëŒ€í‘œ ìƒí’ˆ ì•ìœ¼ë¡œ
    const ëŒ€í‘œ = rows.find(r => r.ëŒ€í‘œ) || rows[0];
    const items = [ëŒ€í‘œ, ...rows.filter(r => r !== ëŒ€í‘œ)];

    // 2) ë°ì´í„° ë°°ì—´ ì±„ìš°ê¸°
    let data = [];
    items.forEach((item, idx) => {
      const seq    = String(idx+1).padStart(2, "0");
      const colors = parseOptions(item.ìƒ‰ìƒ);
      const sizes  = expandSizes(item.ì‚¬ì´ì¦ˆ);
      const cols   = colors.length ? colors : [""];
      const szs    = sizes.length  ? sizes  : [""];

      cols.forEach(col => {
        szs.forEach(sz => {
          const opt = applyOptionMode(item.ìƒí’ˆëª…, col, sz, seq);
          data.push({
            ì¶”ê°€ìƒí’ˆëª…: "ì œí’ˆì„ íƒ",
            ì¶”ê°€ìƒí’ˆê°’: opt.ì œí’ˆì„ íƒ,
            ì¶”ê°€ìƒí’ˆê°€: item.íŒë§¤ê°€,
            ì¬ê³ ìˆ˜ëŸ‰: 99999,
            ì‚¬ìš©ì—¬ë¶€: "Y",
            ê´€ë¦¬ì½”ë“œ: item.ìƒí’ˆëª…
          });
        });
      });
    });

    // 3) ì¤‘ë³µ ì œê±°
    data = data.filter((row,i) =>
      data.findIndex(r => r.ì¶”ê°€ìƒí’ˆê°’ === row.ì¶”ê°€ìƒí’ˆê°’) === i
    );

    // 4) ì•ˆì „í•œ íŒŒì¼ëª…
    const safeName = ëŒ€í‘œ.ìƒí’ˆëª….replace(/[\\\/:*?"<>|]/g, "").trim();

    // 5) ì›Œí¬ë¶ ìƒì„± & ë‹¤ìš´ë¡œë“œ
    const header = [
    "ì¶”ê°€ìƒí’ˆëª…","ì¶”ê°€ìƒí’ˆê°’","ì¶”ê°€ìƒí’ˆê°€","ì¬ê³ ìˆ˜ëŸ‰","ì‚¬ìš©ì—¬ë¶€","ê´€ë¦¬ì½”ë“œ"
  ];
    const ws    = XLSX.utils.json_to_sheet(data, { header });
    autoWidth(ws, data, header);
    const wb    = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ì¶”ê°€ìƒí’ˆ");
    const wbout = XLSX.write(wb, { bookType: "xls", type: "array" });
    saveAs(new Blob([wbout], { type: "application/octet-stream" }),
           `ì¶”ê°€ìƒí’ˆ_${safeName}.xls`);
  }
  
// ë‹¨í’ˆë“±ë¡ìš© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ - ëŒ€í‘œìƒí’ˆë§Œ ìˆœë²ˆ ì—†ì´ ì¶œë ¥  
function downloadSingleProductExcel() {
  const rows = getDataFromTable().filter(r => !r.ì œì™¸);
  const ëŒ€í‘œ = rows.find(r => r.ëŒ€í‘œ) || rows[0];
  if (!ëŒ€í‘œ) return alert("ëŒ€í‘œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");

  const ìƒ‰ìƒëª©ë¡ = parseOptions(ëŒ€í‘œ.ìƒ‰ìƒ);
  const ì‚¬ì´ì¦ˆëª©ë¡ = expandSizes(ëŒ€í‘œ.ì‚¬ì´ì¦ˆ);
  const í’ˆì ˆì¡°í•© = parseOptions(ëŒ€í‘œ.í’ˆì ˆëœì¡°í•©);
  const ìƒí’ˆëª… = ëŒ€í‘œ["1ë²ˆ ìƒí’ˆëª…"] || ëŒ€í‘œ.ìƒí’ˆëª…;
  const mode = getOptionDisplayMode();

  const data = [];

  ìƒ‰ìƒëª©ë¡.forEach(color => {
    if (ì‚¬ì´ì¦ˆëª©ë¡.length === 0) {
      const í’ˆì ˆ = í’ˆì ˆì¡°í•©.includes(color);
      const row = {
        ì œí’ˆì„ íƒ: mode === "both" ? `${ìƒí’ˆëª…} / ${color}` : ìƒí’ˆëª…,
        ì˜µì…˜ê°€: 0,
        ì¬ê³ ìˆ˜ëŸ‰: í’ˆì ˆ ? 0 : 99999,
        ê´€ë¦¬ì½”ë“œ: ëŒ€í‘œ.ìƒí’ˆëª…,
        ì‚¬ìš©ì—¬ë¶€: "Y"
      };
      if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
      if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = ëŒ€í‘œ.ì‚¬ì´ì¦ˆ;
      data.push(row);
    } else {
      ì‚¬ì´ì¦ˆëª©ë¡.forEach(size => {
        const í’ˆì ˆ = í’ˆì ˆì¡°í•©.includes(color) || í’ˆì ˆì¡°í•©.includes(size) || í’ˆì ˆì¡°í•©.includes(`${color}-${size}`);
        const row = {
          ì œí’ˆì„ íƒ: mode === "both" ? `${ìƒí’ˆëª…} / ${color}` : ìƒí’ˆëª…,
          ì˜µì…˜ê°€: 0,
          ì¬ê³ ìˆ˜ëŸ‰: í’ˆì ˆ ? 0 : 99999,
          ê´€ë¦¬ì½”ë“œ: ëŒ€í‘œ.ìƒí’ˆëª…,
          ì‚¬ìš©ì—¬ë¶€: "Y"
        };
        if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
        if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = size;
        data.push(row);
      });
    }
  });

  const header = ["ì œí’ˆì„ íƒ"];
  if (mode === "colorOnly") header.push("ìƒ‰ìƒ");
  if (mode === "sizeOnly" || mode === "both") header.push("ì‚¬ì´ì¦ˆ");
  header.push("ì˜µì…˜ê°€", "ì¬ê³ ìˆ˜ëŸ‰", "ê´€ë¦¬ì½”ë“œ", "ì‚¬ìš©ì—¬ë¶€");

  const rowsArray = data.map(row => {
    const line = [row.ì œí’ˆì„ íƒ];
    if (mode === "colorOnly") line.push(row.ìƒ‰ìƒ);
    if (mode === "sizeOnly" || mode === "both") line.push(row.ì‚¬ì´ì¦ˆ);
    line.push(row.ì˜µì…˜ê°€, row.ì¬ê³ ìˆ˜ëŸ‰, row.ê´€ë¦¬ì½”ë“œ, row.ì‚¬ìš©ì—¬ë¶€);
    return line;
  });

  const aoa = [header, ...rowsArray];
  const ws  = XLSX.utils.aoa_to_sheet(aoa);
  autoWidthAoA(ws, aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ë‹¨í’ˆì˜µì…˜");
  const safeFileName = (ëŒ€í‘œ.ìƒí’ˆëª… || "ë‹¨í’ˆë“±ë¡").replace(/[\/:*?"<>|]/g, "").trim();
  const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
  saveAs(new Blob([wbout], { type: "application/octet-stream" }), `ë‹¨í’ˆë“±ë¡_${safeFileName}.xls`);
}

// ë‹¨í’ˆë“±ë¡ìš© ì „ì²´ ì—‘ì…€ ZIP ë‹¤ìš´ë¡œë“œ
function downloadSingleProductExcelAll() {
  const rows = getDataFromTable().filter(r => !r.ì œì™¸);
  if (rows.length === 0) return alert("ì¶œë ¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

  const mode = getOptionDisplayMode();
  const zip = new JSZip();
  const ìƒí’ˆê·¸ë£¹ = [...new Set(rows.map(r => r.ìƒí’ˆëª…))];

  ìƒí’ˆê·¸ë£¹.forEach(ìƒí’ˆëª… => {
    const ê·¸ë£¹ = rows.filter(r => r.ìƒí’ˆëª… === ìƒí’ˆëª…);
    const ëŒ€í‘œ = ê·¸ë£¹.find(r => r.ëŒ€í‘œ) || ê·¸ë£¹[0];
    const ìƒ‰ìƒëª©ë¡ = parseOptions(ëŒ€í‘œ.ìƒ‰ìƒ);
    const ì‚¬ì´ì¦ˆëª©ë¡ = expandSizes(ëŒ€í‘œ.ì‚¬ì´ì¦ˆ);
    const í’ˆì ˆì¡°í•© = parseOptions(ëŒ€í‘œ.í’ˆì ˆëœì¡°í•©);
    const ëŒ€í‘œìƒí’ˆëª… = ëŒ€í‘œ["1ë²ˆ ìƒí’ˆëª…"] || ëŒ€í‘œ.ìƒí’ˆëª…;

    const data = [];
    const ìƒ‰ìƒë°°ì—´ = ìƒ‰ìƒëª©ë¡.length > 0 ? ìƒ‰ìƒëª©ë¡ : [""];

    ìƒ‰ìƒë°°ì—´.forEach(color => {
      if (ì‚¬ì´ì¦ˆëª©ë¡.length === 0) {
        const í’ˆì ˆ = í’ˆì ˆì¡°í•©.includes(color);
        const row = {
          ì œí’ˆì„ íƒ: mode === "both" ? `${ëŒ€í‘œìƒí’ˆëª…} / ${color}` : ëŒ€í‘œìƒí’ˆëª…,
          ì˜µì…˜ê°€: 0,
          ì¬ê³ ìˆ˜ëŸ‰: í’ˆì ˆ ? 0 : 99999,
          ê´€ë¦¬ì½”ë“œ: ëŒ€í‘œ.ìƒí’ˆëª…,
          ì‚¬ìš©ì—¬ë¶€: "Y"
        };
        if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
        if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = ëŒ€í‘œ.ì‚¬ì´ì¦ˆ;
        data.push(row);
      } else {
        ì‚¬ì´ì¦ˆëª©ë¡.forEach(size => {
          const í’ˆì ˆ = í’ˆì ˆì¡°í•©.includes(color) || í’ˆì ˆì¡°í•©.includes(size) || í’ˆì ˆì¡°í•©.includes(`${color}-${size}`);
          const row = {
            ì œí’ˆì„ íƒ: mode === "both" ? `${ëŒ€í‘œìƒí’ˆëª…} / ${color}` : ëŒ€í‘œìƒí’ˆëª…,
            ì˜µì…˜ê°€: 0,
            ì¬ê³ ìˆ˜ëŸ‰: í’ˆì ˆ ? 0 : 99999,
            ê´€ë¦¬ì½”ë“œ: ëŒ€í‘œ.ìƒí’ˆëª…,
            ì‚¬ìš©ì—¬ë¶€: "Y"
          };
          if (mode === "colorOnly") row.ìƒ‰ìƒ = color;
          if (mode === "sizeOnly" || mode === "both") row.ì‚¬ì´ì¦ˆ = size;
          data.push(row);
        });
      }
    });

    const header = ["ì œí’ˆì„ íƒ"];
    if (mode === "colorOnly") header.push("ìƒ‰ìƒ");
    if (mode === "sizeOnly" || mode === "both") header.push("ì‚¬ì´ì¦ˆ");
    header.push("ì˜µì…˜ê°€", "ì¬ê³ ìˆ˜ëŸ‰", "ê´€ë¦¬ì½”ë“œ", "ì‚¬ìš©ì—¬ë¶€");

    const rowsArray = data.map(row => {
      const line = [row.ì œí’ˆì„ íƒ];
      if (mode === "colorOnly") line.push(row.ìƒ‰ìƒ);
      if (mode === "sizeOnly" || mode === "both") line.push(row.ì‚¬ì´ì¦ˆ);
      line.push(row.ì˜µì…˜ê°€, row.ì¬ê³ ìˆ˜ëŸ‰, row.ê´€ë¦¬ì½”ë“œ, row.ì‚¬ìš©ì—¬ë¶€);
      return line;
    });

    const aoa = [header, ...rowsArray];
    const ws  = XLSX.utils.aoa_to_sheet(aoa);
    autoWidthAoA(ws, aoa);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ë‹¨í’ˆì˜µì…˜");
    const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
    const safeFileName = (ëŒ€í‘œ.ìƒí’ˆëª… || "ë‹¨í’ˆë“±ë¡").replace(/[\/:*?"<>|]/g, "").trim();
    zip.file(`ë‹¨í’ˆë“±ë¡_${safeFileName}.xls`, wbout);
  });

  zip.generateAsync({ type: "blob" }).then(content => {
    saveAs(content, "ë‹¨í’ˆë“±ë¡_ì „ì²´ë‹¤ìš´ë¡œë“œ.zip");
  });
}

// ì˜µì…˜ ë…¸ì¶œ ë°©ì‹ í™•ì¸ í•¨ìˆ˜
function getOptionDisplayMode() {
  const selected = document.querySelector('input[name="optionDisplay"]:checked');
  return selected ? selected.value : "both";
} 


  // (1) ì˜µì…˜ êµ¬ì„± ë°©ì‹ ì ìš© í•¨ìˆ˜
function applyOptionMode(ì œí’ˆëª…, ìƒ‰ìƒ, ì‚¬ì´ì¦ˆ, ìˆœë²ˆ) {
  const prefix = ìˆœë²ˆ ? `${ìˆœë²ˆ}) ` : "";
  let í…ìŠ¤íŠ¸ = `${prefix}${ì œí’ˆëª…}`;
  const mode = getOptionDisplayMode();

  if (mode === "both") {
    const parts = [];
    if (ìƒ‰ìƒ)  parts.push(ìƒ‰ìƒ);
    if (ì‚¬ì´ì¦ˆ) parts.push(ì‚¬ì´ì¦ˆ);
    if (parts.length) í…ìŠ¤íŠ¸ += ` / ${parts.join(" ")}`;  // ë¸”ë™ FREE
  }
  else if (mode === "colorOnly" && ìƒ‰ìƒ) {
    í…ìŠ¤íŠ¸ += ` / ${ìƒ‰ìƒ}`;
  }
  else if (mode === "sizeOnly" && ì‚¬ì´ì¦ˆ) {
    í…ìŠ¤íŠ¸ += ` / ${ì‚¬ì´ì¦ˆ}`;
  }

  return { ì œí’ˆì„ íƒ: í…ìŠ¤íŠ¸ };
}

  // (2) ì‚¬ì´ì¦ˆ expand í•¨ìˆ˜
function expandSizes(sizeStr) {
  if (!sizeStr || typeof sizeStr !== 'string') return [];
  // ì½¤ë§ˆ/ìŠ¬ë˜ì‹œ ë¶„ë¦¬
  if (/[,ï¼Œ\/ï¼]/.test(sizeStr)) {
    return sizeStr
      .split(/[,ï¼Œ\/ï¼]/g)
      .map(s => s.trim())
      .filter(Boolean);
  }
  // ë²”ìœ„ ì…ë ¥(ì˜ˆ: 230~240)
  const m = sizeStr.match(/^(\d{2,3})~(\d{2,3})$/);
  if (m) {
    const start = +m[1], end = +m[2], out = [];
    for (let v = start; v <= end; v += 5) out.push(String(v));
    return out;
  }
  return [sizeStr.trim()];
}

// 2) íŒŒì¼ ì—…ë¡œë“œ ë¦¬ìŠ¤ë„ˆ
document.getElementById("inputFile").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(evt) {
    // 1) ì›Œí¬ë¶ íŒŒì‹±
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames.find(name =>
      name.includes("ìƒí’ˆ") || name.includes("ì˜µì…˜")
    ) || workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    if (!sheet) return alert("ìƒí’ˆì˜µì…˜ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    // 2) JSON ë³€í™˜ â†’ í…Œì´ë¸” ì´ˆê¸°í™” â†’ addRow ë°˜ë³µ
    const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    clearTable();
    json.forEach(row => addRow({
      ìƒí’ˆëª…: row["ìƒí’ˆëª…"],
      íŒë§¤ê°€: row["íŒë§¤ê°€"],
      ìƒ‰ìƒ: row["ìƒ‰ìƒ"],
      ì‚¬ì´ì¦ˆ: row["ì‚¬ì´ì¦ˆ"],
      ["1ë²ˆ ìƒí’ˆëª…"]: row["1ë²ˆ ìƒí’ˆëª…"],
      í’ˆì ˆëœì¡°í•©: row["í’ˆì ˆëœ ì¡°í•©"] || '',
      ì œì™¸: row["ì œì™¸"] === 'Y' || row["ì œì™¸"] === true
    }));

    // 3) í…Œì´ë¸”ì´ ì±„ì›Œì§„ ë’¤ì— originalDataì— ì €ì¥
    originalData = getDataFromTable();
  };

  reader.readAsArrayBuffer(file);
});
let lastFocusedInput = null;

//ì—‘ì…€ì—ì„œ ë³µì‚¬ ë¶™ì—¬ë„£ê¸° ì½”ë“œ
document.querySelector('#inputTable tbody').addEventListener('paste', function(e) {
  const active = document.activeElement;
  if (!active || !active.matches('input[type="text"], input[type="number"]')) return;

  const text = (e.clipboardData || window.clipboardData).getData('text');
  if (!text) return;

  const tbody = document.querySelector('#inputTable tbody');
  let trs   = Array.from(tbody.querySelectorAll('tr'));

  // [ê°€ë¡œ] ë¶™ì—¬ë„£ê¸°
  if (text.includes('\t')) {
    const rows = text.replace(/\r/g,'').split('\n').filter(Boolean);
    const td = active.closest('td');
    const tr = active.closest('tr');
    const colIdx = Array.from(tr.children).indexOf(td);
    let rowIdx = trs.indexOf(tr);

    // ë¶€ì¡±í•œ í–‰ ìë™ì¶”ê°€
    while (trs.length < rowIdx + rows.length) {
      addRow();
      trs = Array.from(tbody.querySelectorAll('tr'));
    }

    for (let i = 0; i < rows.length; i++) {
      const cols = rows[i].split('\t');
      const targetRow = trs[rowIdx + i];
      if (!targetRow) break;
      for (let j = 0; j < cols.length; j++) {
        const targetTd = targetRow.children[colIdx + j];
        if (!targetTd) break;
        const targetInput = targetTd.querySelector('input');
        if (targetInput) {
          let v = cols[j];
          // <input type="number">ì— ì½¤ë§ˆ, ë¬¸ì ì œê±°
          if (
            targetInput.type === "number" ||
            targetInput.getAttribute("type") === "number"
          ) {
            v = v.replace(/[^0-9.\-]/g, '');
          }
          targetInput.value = v;
          targetInput.dispatchEvent(new Event('input', {bubbles:true}));
        }
      }
    }
    e.preventDefault();
    return;
  }

// [ì„¸ë¡œ] ë¶™ì—¬ë„£ê¸°: í•œ ì—´ì— ì—¬ëŸ¬ ê°’ (ê³µë€ë„ ë°˜ì˜)
if (!text.includes('\t') && text.split('\n').length > 1) {
  const values = text.replace(/\r/g,'').split('\n');
  // ì—‘ì…€ì—ì„œ ë³µì‚¬í•œ ê°’ì´ ë§ˆì§€ë§‰ì— ë¹ˆ ì¤„ í•˜ë‚˜ ë¶™ì–´ì˜¤ëŠ” ê²½ìš°ë§Œ ì œê±°
  if (values.length > 0 && values[values.length - 1] === "") values.pop();
  const td     = active.closest('td');
  const tr     = active.closest('tr');
  const colIdx = Array.from(tr.children).indexOf(td);
  let trs2     = Array.from(tbody.querySelectorAll('tr'));
  const rowIdx = trs2.indexOf(tr);

  // **í–‰ ë¶€ì¡±í•˜ë©´ ìë™ ì¶”ê°€**
  while (trs2.length < rowIdx + values.length) {
    addRow();
    trs2 = Array.from(tbody.querySelectorAll('tr'));
  }

  // ë¶™ì—¬ë„£ê¸° ì‹¤ì œ ì…ë ¥ (ê³µë€ í¬í•¨)
  for(let i=0; i<values.length; i++) {
    const targetRow = trs2[rowIdx + i];
    if (!targetRow) break;
    const targetInput = targetRow.children[colIdx].querySelector('input');
    if (targetInput) {
      let v = values[i]; // ê³µë€ë„ ê·¸ëŒ€ë¡œ!
      // ìˆ«ìí•„ë“œì¼ ë•Œ ì½¤ë§ˆ, ë¬¸ì ì œê±°
      if (
        targetInput.type === "number" ||
        targetInput.getAttribute("type") === "number"
      ) {
        v = v.replace(/[^0-9.\-]/g, '');
      }
      targetInput.value = v;
      targetInput.dispatchEvent(new Event('input', {bubbles:true}));
    }
  }
  e.preventDefault();
  return;
}


});  // â† ì´ **ë‹«ëŠ” ê´„í˜¸ì™€ ì„¸ë¯¸ì½œë¡ (;)**ì´ ë°˜ë“œì‹œ í•„ìš”í•¨!!!

  </script>
</body>
</html>
