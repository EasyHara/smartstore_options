<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>스마트스토어 옵션 자동 생성기</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    input[type='text'], input[type='number'] { width: 100%; box-sizing: border-box; }
    .top-bar, .button-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    #inputTable-container { max-height: 500px; overflow-y: auto; margin-bottom: 20px; }
    .section { margin-top: 30px; }
    .hidden { display: none; }
    .saved-template { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #ccc; }
    .saved-template span { flex: 1; }
    .right-align { text-align: right; }
  </style>
</head>
<body>
  <h2>스마트스토어 옵션 자동 생성기</h2>

  <div class="top-bar">
    <input type="file" id="excelFile" accept=".xlsx" />
    <button onclick="downloadTemplate()">엑셀 양식 다운로드</button>
    <button onclick="addRow()">+ 행 추가</button>
    <button onclick="clearAll()">초기화</button>
  </div>

  <div id="inputTable-container">
    <table id="inputTable">
      <thead>
        <tr>
          <th>상품명</th>
          <th>판매가</th>
          <th>색상</th>
          <th>사이즈</th>
          <th>1번 상품명</th>
          <th>품절된 색상 입력</th>
          <th>품절된 사이즈 입력</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="top-bar">
    <input type="text" id="templateTitle" placeholder="양식 제목 입력" />
    <button onclick="saveTemplate()">제목으로 저장</button>
  </div>

  <div class="section">
    <div class="top-bar">
      <span><strong>저장된 양식 목록</strong></span>
      <button style="margin-left:auto" onclick="deleteSelectedTemplates()">선택된 양식 삭제</button>
    </div>
    <div id="templateList"></div>
  </div>

  <div class="right-align section">
    <button onclick="openTrash()">휴지통 바로가기</button>
  </div>

  <div class="section hidden" id="trashSection">
    <h3>휴지통</h3>
    <div id="trashList"></div>
  </div>

  <script>
    const tableBody = document.querySelector('#inputTable tbody');

    function addRow(data = {}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="${data['상품명'] || ''}" /></td>
        <td><input type="number" value="${data['판매가'] || ''}" /></td>
        <td><input type="text" value="${data['색상'] || ''}" /></td>
        <td><input type="text" value="${data['사이즈'] || ''}" /></td>
        <td><input type="text" value="${data['1번 상품명'] || ''}" /></td>
        <td><input type="text" value="${data['품절된 색상 입력'] || ''}" /></td>
        <td><input type="text" value="${data['품절된 사이즈 입력'] || ''}" /></td>
      `;
      tableBody.appendChild(tr);
    }

    function clearAll() {
      tableBody.innerHTML = '';
    }

    function populateTable(data) {
      clearAll();
      data.forEach(row => addRow(row));
    }

    function downloadTemplate() {
      const ws_data = [
        ['상품명', '판매가', '색상', '사이즈', '1번 상품명', '품절된 색상 입력', '품절된 사이즈 입력']
      ];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, '양식');
      XLSX.writeFile(wb, 'smartstore_template.xlsx');
    }

    function saveTemplate() {
      const title = document.getElementById('templateTitle').value.trim();
      if (!title) return alert('제목을 입력해주세요.');
      if (tableBody.children.length === 0) return alert('빈 양식은 저장할 수 없습니다.');

      const data = [...tableBody.querySelectorAll('tr')].map(tr => {
        const tds = tr.querySelectorAll('td');
        return {
          '상품명': tds[0].querySelector('input').value,
          '판매가': tds[1].querySelector('input').value,
          '색상': tds[2].querySelector('input').value,
          '사이즈': tds[3].querySelector('input').value,
          '1번 상품명': tds[4].querySelector('input').value,
          '품절된 색상 입력': tds[5].querySelector('input').value,
          '품절된 사이즈 입력': tds[6].querySelector('input').value,
        };
      });

      const now = new Date().toISOString();
      const template = { title, data, created: now, updated: now };
      localStorage.setItem('template_' + title, JSON.stringify(template));
      loadTemplates();
    }

    function loadTemplates() {
      const list = document.getElementById('templateList');
      list.innerHTML = '';
      Object.keys(localStorage).filter(k => k.startsWith('template_')).forEach(key => {
        const { title, created, updated } = JSON.parse(localStorage.getItem(key));
        const div = document.createElement('div');
        div.className = 'saved-template';
        div.innerHTML = `
          <span><input type="checkbox" value="${key}" /> <strong>${title}</strong><br><small>생성: ${formatTime(created)} | 수정: ${formatTime(updated)}</small></span>
          <button onclick="loadTemplate('${key}')">불러오기</button>
        `;
        list.appendChild(div);
      });
    }

    function loadTemplate(key) {
      const { title, data } = JSON.parse(localStorage.getItem(key));
      document.getElementById('templateTitle').value = title;
      populateTable(data);
    }

    function deleteSelectedTemplates() {
      const checked = [...document.querySelectorAll('#templateList input[type=checkbox]:checked')];
      if (checked.length === 0) return alert('삭제할 항목을 선택해주세요.');
      if (!confirm('정말 삭제하시겠습니까?')) return;
      checked.forEach(chk => {
        const key = chk.value;
        const trash = JSON.parse(localStorage.getItem(key));
        trash.deletedAt = new Date().toISOString();
        localStorage.setItem('trash_' + key, JSON.stringify(trash));
        localStorage.removeItem(key);
      });
      loadTemplates();
    }

    function openTrash() {
      const section = document.getElementById('trashSection');
      section.classList.toggle('hidden');
      const list = document.getElementById('trashList');
      list.innerHTML = '';
      const now = new Date();
      const trashItems = Object.keys(localStorage).filter(k => k.startsWith('trash_template_'));
      if (trashItems.length === 0) return alert('휴지통이 비어있습니다.');
      trashItems.forEach(key => {
        const item = JSON.parse(localStorage.getItem(key));
        const deletedAt = new Date(item.deletedAt);
        const remainingDays = 7 - Math.floor((now - deletedAt) / (1000 * 60 * 60 * 24));
        if (remainingDays <= 0) {
          localStorage.removeItem(key);
          return;
        }
        const div = document.createElement('div');
        div.className = 'saved-template';
        div.innerHTML = `
          <span><strong>${item.title}</strong><br><small>삭제됨 - ${formatTime(item.deletedAt)} (남은 ${remainingDays}일)</small></span>
          <button onclick="restoreTemplate('${key}')">복원</button>
        `;
        list.appendChild(div);
      });
    }

    function restoreTemplate(key) {
      const item = JSON.parse(localStorage.getItem(key));
      localStorage.setItem(key.replace('trash_', ''), JSON.stringify(item));
      localStorage.removeItem(key);
      openTrash();
      loadTemplates();
    }

    function formatTime(str) {
      const d = new Date(str);
      return `${d.getFullYear()}. ${d.getMonth()+1}. ${d.getDate()} ${d.getHours()}:${('0'+d.getMinutes()).slice(-2)}`;
    }

    document.getElementById('excelFile').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });
        populateTable(json);
      };
      reader.readAsArrayBuffer(file);
    });

    loadTemplates();
  </script>
</body>
</html>
